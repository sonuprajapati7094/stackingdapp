<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>USDT Staking â€” Final Dashboard (Fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#0b0b0c;color:#fff;font-family:Inter,system-ui,Arial;margin:0;padding:28px;display:flex;flex-direction:column;align-items:center}
    h1{margin:0 0 18px;font-size:28px}
    .card{background:#17171a;padding:20px;border-radius:12px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,0.5);width:460px;max-width:95%}
    button{cursor:pointer;border:0;padding:10px 16px;border-radius:8px;font-weight:600}
    .btn-yellow{background:#ffcc29;color:#111}
    .btn-dark{background:#2b2b2f;color:#fff}
    .btn-red{background:#e04646;color:#fff}
    input{padding:12px;border-radius:8px;border:0;background:#262628;color:#fff;width:240px}
    .center{text-align:center}
    .muted{color:#bdbdbd;font-size:14px}
    .small{font-size:13px;color:#999;margin-top:8px}
  </style>
</head>
<body>
  <h1>ðŸš€ USDT Staking â€” Final (Fixed)</h1>
  <div id="walletText" class="muted">Wallet: not connected</div>
  <div style="margin:14px"><button id="connectBtn" class="btn-yellow">Connect Wallet</button></div>

  <div class="card center">
    <h3>Approve & Stake</h3>
    <input id="amountInput" placeholder="Amount (USDT)" />
    <div style="margin-top:12px">
      <button class="btn-dark" id="approveBtn">Approve</button>
      <button class="btn-yellow" id="depositBtn">Deposit</button>
    </div>
    <div class="small">Note: First Approve, then Deposit. Use decimals according to token (UI handles usual 6 decimals).</div>
  </div>

  <div class="card center">
    <h3>Rewards</h3>
    <button class="btn-dark" id="pendingBtn">Check Pending Rewards</button>
    <div id="rewardsText" class="muted" style="margin:10px">Rewards: 0 USDT</div>
    <button class="btn-yellow" id="claimBtn">Claim Rewards</button>
  </div>

  <div class="card center">
    <h3>Withdraw</h3>
    <input id="withdrawInput" placeholder="Amount (USDT)" />
    <div style="margin-top:12px">
      <button class="btn-red" id="withdrawBtn">Withdraw</button>
    </div>
  </div>

  <div class="card center">
    <h3>ðŸ“Š Staking Info</h3>
    <button class="btn-dark" id="stakedBtn">Check Staked Balance</button>
    <div id="stakedInfo" class="muted" style="margin-top:14px">-</div>
  </div>

<script>
(async function(){
  // ============ CONFIG (update if needed) ============
  const STAKING_ADDRESS = "0x20Fbd4AF3cB507e702C7C513F08D7857bAc74407"; // <-- your new staking contract
  const TOKEN_ADDRESS   = "0xEbA5032Be8fc2d2a2fa29e134853ab6aAA12fa1C"; // <-- change if your token address is different

  // ============ ABIs (minimal, only needed methods) ============
  const tokenAbi = [
    "function decimals() view returns (uint8)",
    "function approve(address,uint256) returns (bool)",
    "function allowance(address,address) view returns (uint256)"
  ];
  const stakingAbi = [
    "function deposit(uint256,address)",
    "function claimRewards()",
    "function withdrawPrincipal(uint256)",
    "function pendingRewards(address) view returns (uint256)",
    "function getUserInfo(address) view returns (uint256,uint256,address,uint256,uint256)"
  ];

  // ============ Elements ============
  const connectBtn = document.getElementById("connectBtn");
  const walletText = document.getElementById("walletText");
  const amountInput = document.getElementById("amountInput");
  const approveBtn = document.getElementById("approveBtn");
  const depositBtn = document.getElementById("depositBtn");
  const pendingBtn = document.getElementById("pendingBtn");
  const rewardsText = document.getElementById("rewardsText");
  const claimBtn = document.getElementById("claimBtn");
  const withdrawInput = document.getElementById("withdrawInput");
  const withdrawBtn = document.getElementById("withdrawBtn");
  const stakedBtn = document.getElementById("stakedBtn");
  const stakedInfo = document.getElementById("stakedInfo");

  // ============ state ============
  let provider, signer, userAddress, token, staking, decimals = 6;

  // ===== dynamic ethers loader with fallback =====
  async function ensureEthers() {
    if (window.ethers) return;
    const urls = [
      "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js",
      "https://unpkg.com/ethers@5.7.2/dist/ethers.min.js"
    ];
    for (const url of urls) {
      await new Promise(res=>{
        const s = document.createElement('script');
        s.src = url;
        s.onload = ()=>{ res(); };
        s.onerror = ()=>{ s.remove(); res(); };
        document.head.appendChild(s);
      });
      if (window.ethers) return;
    }
    throw new Error("ethers library could not be loaded from CDN. Check network / CSP.");
  }

  // small helpers
  function fmt(bn){ try { return ethers.utils.formatUnits(bn, decimals); } catch(e){ return "0"; } }
  function toUnits(v){ if(typeof v !== "string") v = String(v); return ethers.utils.parseUnits(v||"0", decimals); }

  // connect wallet
  async function connect(){
    try{
      await ensureEthers();
      if (!window.ethereum) { alert("No injected wallet found (MetaMask). Install/enable MetaMask."); return; }
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      walletText.textContent = "Wallet: " + userAddress;
      connectBtn.textContent = "Connected";

      token = new ethers.Contract(TOKEN_ADDRESS, tokenAbi, signer);
      staking = new ethers.Contract(STAKING_ADDRESS, stakingAbi, signer);

      // try read decimals (default to 6 on failure)
      try { decimals = await token.decimals(); } catch(e){ decimals = 6; console.warn("Couldn't fetch token.decimals(), defaulting to 6"); }
      console.log("Connected:", userAddress, "decimals:", decimals);
    }catch(err){
      alert("Wallet connect failed: " + (err && err.message ? err.message : err));
      console.error(err);
    }
  }
  connectBtn.onclick = connect;

  // ensure connected before any action
  async function ensureConnectedOrThrow(){
    if (!signer) {
      await connect();
      if (!signer) throw new Error("Wallet not connected");
    }
  }

  // Approve
  approveBtn.onclick = async ()=>{
    try{
      await ensureConnectedOrThrow();
      const v = (amountInput.value||"").trim();
      if (!v) { alert("Enter amount"); return; }
      const amt = toUnits(v);
      const tx = await token.approve(STAKING_ADDRESS, amt);
      await tx.wait();
      alert("Approve success");
    }catch(e){ alert("Approve failed: " + (e && e.message ? e.message : e)); console.error(e); }
  };

  // Deposit (stake)
  depositBtn.onclick = async ()=>{
    try{
      await ensureConnectedOrThrow();
      const v = (amountInput.value||"").trim();
      if (!v) { alert("Enter amount"); return; }
      const amt = toUnits(v);
      const tx = await staking.deposit(amt, ethers.constants.AddressZero); // no referrer
      await tx.wait();
      alert("Deposit success");
    }catch(e){ alert("Deposit failed: " + (e && e.message ? e.message : e)); console.error(e); }
  };

  // Pending rewards
  pendingBtn.onclick = async ()=>{
    try{
      await ensureConnectedOrThrow();
      const p = await staking.pendingRewards(userAddress);
      rewardsText.textContent = "Rewards: " + fmt(p) + " USDT";
    }catch(e){ alert("Pending error: " + (e && e.message ? e.message : e)); console.error(e); }
  };

  // Claim
  claimBtn.onclick = async ()=>{
    try{
      await ensureConnectedOrThrow();
      const tx = await staking.claimRewards();
      await tx.wait();
      alert("Claimed OK");
    }catch(e){ alert("Claim failed: " + (e && e.message ? e.message : e)); console.error(e); }
  };

  // Withdraw principal
  withdrawBtn.onclick = async ()=>{
    try{
      await ensureConnectedOrThrow();
      const v = (withdrawInput.value||"").trim();
      if (!v) { alert("Enter amount"); return; }
      const amt = toUnits(v);
      const tx = await staking.withdrawPrincipal(amt);
      await tx.wait();
      alert("Withdraw success");
    }catch(e){ alert("Withdraw failed: " + (e && e.message ? e.message : e)); console.error(e); }
  };

  // Check staked balance via getUserInfo
  stakedBtn.onclick = async ()=>{
    try{
      await ensureConnectedOrThrow();
      // call getUserInfo(address) which returns (staked, lastAction, referrer, totalEarned, pending)
      const info = await staking.getUserInfo(userAddress);
      // it's a tuple - index based
      const staked = fmt(info[0]);
      const lastActionTs = Number(info[1]) || 0;
      const referrer = info[2];
      const totalEarned = fmt(info[3]);
      const pending = fmt(info[4]);

      const lastAction = lastActionTs ? new Date(lastActionTs * 1000).toLocaleString() : "-";
      stakedInfo.innerHTML = `
        <div>Staked: <b>${staked} USDT</b></div>
        <div>Pending: <b>${pending} USDT</b></div>
        <div>Total Earned (claimed+accrued): <b>${totalEarned} USDT</b></div>
        <div>Last action: <span class="muted">${lastAction}</span></div>
        <div>Referrer: <span class="muted">${referrer && referrer !== ethers.constants.AddressZero ? referrer : "-"}</span></div>
      `;
    }catch(e){
      // provide full error text to help debugging (revert / missing user struct etc.)
      const msg = e && e.message ? e.message : String(e);
      alert("Error fetching staked info: " + msg);
      console.error("Staked info error:", e);
    }
  };

  // auto-try to load ethers early (so user gets prompt if library blocked)
  try { await ensureEthers(); } catch(e){ alert("Library load failed: " + e.message); console.error(e); }

})();
</script>
</body>
</html>
