<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Full Staking DApp ‚Äî Dashboard</title>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0d0f; --card:#0f1214; --muted:#9aa4b2; --accent:#ffd86b;
      --panel:#121416; --success:#00c176; --danger:#ff6b6b;
    }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#e6eef6;}
    header{padding:18px 24px;text-align:center;background:linear-gradient(90deg,#081018,#0d1016);box-shadow:0 2px 8px rgba(0,0,0,0.5);}
    header h1{margin:0;color:var(--accent);font-size:20px;}
    .topbar{display:flex;justify-content:flex-end;gap:12px;padding:12px 24px;align-items:center;max-width:1180px;margin:0 auto;}
    .wallet-btn{background:var(--accent);color:#000;padding:8px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer;}
    .container{padding:20px;display:grid;grid-template-columns:360px 1fr;gap:18px;max-width:1180px;margin:18px auto;}
    .left{display:flex;flex-direction:column;gap:14px;}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.4);}
    .card h2{margin:0 0 10px 0;color:var(--accent);font-size:16px;}
    .muted{color:var(--muted);font-size:13px;}
    input, textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:#fff;box-sizing:border-box;}
    .small-btn{padding:10px 12px;border-radius:8px;border:0;background:#2a2f35;color:#fff;cursor:pointer;margin-top:8px;}
    .accent-btn{background:var(--accent);color:#000;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;margin-top:8px;}
    .right{display:flex;flex-direction:column;gap:14px;}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .value{font-size:18px;font-weight:700;color:#fff;}
    .label{font-size:12px;color:var(--muted);margin-top:6px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;}
    th{color:var(--accent);font-weight:700;}
    .center{text-align:center;}
    footer{padding:14px;text-align:center;color:var(--muted);font-size:12px;}
    @media(max-width:980px){.container{grid-template-columns:1fr;padding:12px;}.grid-4{grid-template-columns:repeat(2,1fr);}}
    .pill{display:inline-block;padding:6px 10px;border-radius:16px;background:#222;color:#fff;font-weight:600;}
    #disclaimer {
  transition: all 0.3s ease;
}
#disclaimer:hover {
  background: rgba(255,255,255,0.05);
  transform: scale(1.01);
}
#disclaimer p {
  margin: 6px 0;
}
  </style>
</head>
<body>
<header><h1>USDT Staking ‚Äî Full DApp</h1></header>
<div class="topbar">
  <div id="walletDisplay" class="muted">Not connected</div>
  <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
</div>

<main class="container">

  <!-- LEFT: Actions -->
  <div class="left">

    <div class="card">
      <h2>Stake USDT</h2>
      <div class="muted">Min stake: <strong>20 USDT</strong> ‚Äî multiples of 20</div>
      <!-- main stake input -->
      <input id="stakeAmt" type="number" placeholder="Enter amount (20,40...)" />
      <div style="display:flex;gap:10px;margin-top:8px">
        <button id="approveBtn" class="small-btn">Quick Approve</button>
        <button id="stakeBtn" class="accent-btn">Stake Now</button>
      </div>
      <div id="stakeNote" class="muted" style="margin-top:8px">Tip: Approve once then stake.</div>
    </div>

    <div class="card">
      <h2>P2P Stake (Stake For)</h2>
      <div class="muted">Stake for another wallet ‚Äî no 5% fee (owner required as refForRefUser)</div>
      <input id="p2pAmount" type="number" placeholder="P2P amount (min 20)" />
      <input id="p2pAddress" type="text" placeholder="Recipient wallet address" style="margin-top:8px" />
      <button id="stakeForBtn" class="accent-btn" style="margin-top:10px">Stake For (P2P)</button>
    </div>

    <div class="card">
      <h2>Your Referral Link</h2>
      <input id="refLink" type="text" readonly placeholder="Connect wallet to generate link" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="copyLink" class="small-btn">Copy Referral Link</button>
        <button id="showTeam" class="small-btn">Show Team</button>
      </div>
      <div class="muted" style="margin-top:8px">Users who register via this link will credit you referral income.</div>
    </div>

    <div class="card">
      <h2>Withdraw</h2>
      <div class="muted">Minimum withdraw 20 USDT (admin approval applies)</div>
      <input id="withdrawAmt" type="number" placeholder="20, 40, 60 ..." />
      <button id="requestWithdraw" class="accent-btn" style="margin-top:8px">Request Withdraw</button>
      <div id="withdrawStatus" class="muted" style="margin-top:8px">No withdraw requests yet.</div>
    </div>

  </div>

  <!-- RIGHT: Dashboard -->
  <div class="right">

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h2>Wallet Balances & Income</h2><div class="muted">Instant / Level / ROI</div></div>
        <div><button id="refreshBtn" class="small-btn">Refresh</button></div>
      </div>

      <div style="margin-top:12px" class="grid-4">
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Instant Income</div>
          <div class="value" id="instantIncome">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Level income</div>
          <div class="value" id="levelIncome">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">ROI Pending</div>
          <div class="value" id="roiPending">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Total Wallet</div>
          <div class="value" id="totalWallet">0.000000 USDT</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Staking Info</h2>
      <table>
        <tr><td>Staked</td><td id="stakedDisplay">0.000000 USDT</td></tr>
        <tr><td>Target (3x)</td><td id="targetDisplay">0.000000 USDT</td></tr>
        <tr><td>Days to 3x</td><td id="days3x">0 days</td></tr>
        <tr><td>Package Status</td><td id="pkgStatus">Inactive</td></tr>
      </table>
    </div>
    <!-- ===== Progress Bar (3x Target) ===== -->
<div id="progressSection" style="margin-top: 15px;">
  <p style="margin-bottom: 6px; color: #ffcc00; font-weight: bold;">Progress to 3x </p>
  <div style="width:100%; background:#333; border-radius:8px; height:10px; overflow:hidden;">
    <div id="progressFill" style="height:100%; width:0%; background:linear-gradient(90deg,#ffcc00,#00ff99); transition:width 1s;"></div>
  </div>
  <p id="progressLabel" style="margin-top:4px; font-size:13px; color:#aaa;">0% completed</p>
</div>


    <div class="card">
      <h2>Team & Levels</h2>
      <div style="display:flex; gap:12px; align-items:center;">
        <div style="flex:1"><div class="muted">Direct</div><div class="value" id="directCount">0</div></div>
        <div style="flex:1"><div class="muted">Indirect</div><div class="value" id="indirectCount">0</div></div>
        <div style="flex:2"><div class="muted">Active / Inactive</div><div class="value" id="activeCounts">0 / 0</div></div>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Level</th><th>Percent</th><th>Status</th></tr></thead>
          <tbody id="levelsTbody">
            <tr><td>L1</td><td>10%</td><td id="sL1">Pending</td></tr>
            <tr><td>L2</td><td>10%</td><td id="sL2">Pending</td></tr>
            <tr><td>L3</td><td>5%</td><td id="sL3">Pending</td></tr>
            <tr><td>L4</td><td>3%</td><td id="sL4">Pending</td></tr>
            <tr><td>L5</td><td>2%</td><td id="sL5">Pending</td></tr>
            <tr><td>L6</td><td>1%</td><td id="sL6">Pending</td></tr>
            <tr><td>L7</td><td>1%</td><td id="sL7">Pending</td></tr>
            <tr><td>L8</td><td>1%</td><td id="sL8">Pending</td></tr>
            <tr><td>L9</td><td>1%</td><td id="sL9">Pending</td></tr>
            <tr><td>L10</td><td>1%</td><td id="sL10">Pending</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</main>
<div class="card">
  <h3>Withdrawal History (Requests & Approved)</h3>
  <div class="history-table">
    <table id="withdrawHistory">
      <thead><tr><th>When</th><th>Amount</th><th>Approved</th><th>TX</th></tr></thead>
      <tbody id="withdrawHistoryBody"><tr><td colspan="4" class="center muted">No history yet.</td></tr></tbody>
    </table>
  </div>
</div>

<!-- üß© DISCLAIMER SECTION -->
<footer id="disclaimer" style="margin-top:60px;padding:25px 12px;text-align:center;background:rgba(255,255,255,0.03);border-top:1px solid rgba(255,255,255,0.07);font-size:14px;line-height:1.6;color:#bbb;backdrop-filter:blur(8px);">
  <div style="max-width:900px;margin:auto;">
    <h3 style="color:#fff;font-size:16px;margin-bottom:8px;">‚ö†Ô∏è Disclaimer</h3>
    <p>
      This decentralized application (DApp) operates entirely on blockchain smart contracts.
      The platform team does <strong>not control or guarantee</strong> returns, profits, or user funds.
      All staking, deposits, and withdrawals are processed automatically by the verified smart contract.
    </p>
    <p>
      Users are advised to <strong>do their own research (DYOR)</strong> before investing or interacting with any smart contract.
      Cryptocurrency investments are subject to market risk, smart contract vulnerabilities, and potential loss of funds.
    </p>
    <p style="margin-top:10px;">
      By using this DApp, you agree that you are participating voluntarily and take full responsibility for your decisions.
    </p>
    <div style="margin-top:14px;font-size:13px;color:#888;">
      &copy; <script>document.write(new Date().getFullYear());</script> USDT Staking dashboard. All rights reserved.
    </div>
  </div>
</footer>
<!-- üß© END DISCLAIMER -->

<footer>Made with ‚ù§Ô∏è ‚Äî Testnet only while testing</footer>

<script>
/* ============================================================
   FINAL INTEGRATED SCRIPT ‚Äì blockchain ROI + P2P/withdraw fix
   ============================================================ */

const CONFIG = {
  // BSC Testnet ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® - ‡§Ü‡§™‡§ï‡•ã ‡§á‡§®‡•ç‡§π‡•á‡§Ç ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ!
  tokenAddress: "0x1a904b37B0d9D6ab755aBDa4656E42F278FC89AA", // Testnet USDT/BEP20 Address
  stakingAddress: "0xE65396C1B8c63167A86d374ec7aD8F1471CC1F2f", // Your Deployed Staking Contract Address
  adminAddress: "0x8b2ce640bd59c7333e72bae9a3fc8d33d5460c63...", // Staking Contract Owner/Admin Address (P2P stake ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä)
  decimals: 6,
  minStake: 20
};

// --- GLOBAL VARIABLES ---
let provider, signer, userAddress, stakingContract, tokenContract;
let ownerAddress = CONFIG.adminAddress; // P2P ‡§ï‡•á ‡§≤‡§ø‡§è

// ‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ABI (events ‡§ï‡•ã ‡§õ‡•ã‡§°‡§º‡§ï‡§∞)
const STAKING_ABI = [
  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"ref","type":"address"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"refUser","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"refForRefUser","type":"address"}],"name":"stakeFor","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amt","type":"uint256"}],"name":"requestWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"usr","type":"address"}],"name":"getTimeTo3x","outputs":[{"internalType":"uint256","name":"daysLeft","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[
    {"internalType":"address","name":"referrer","type":"address"},
    {"internalType":"uint256","name":"totalStake","type":"uint256"},
    {"internalType":"uint256","name":"totalWithdrawn","type":"uint256"},
    {"internalType":"uint256","name":"totalEarned","type":"uint256"},
    {"internalType":"uint256","name":"lastRoiUpdate","type":"uint256"},
    {"internalType":"uint256","name":"roiIncome","type":"uint256"},
    {"internalType":"uint256","name":"instantIncome","type":"uint256"},
    {"internalType":"uint256","name":"levelIncome","type":"uint256"},
    {"internalType":"bool","name":"isActive","type":"bool"},
    {"internalType":"bool","name":"isPaused","type":"bool"},
    {"internalType":"uint256","name":"inactiveAt","type":"uint256"}
  ],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"ref","type":"address"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"usr","type":"address"}],"name":"getWithdrawable","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}, // Assuming this view function exists in final ABI
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"withdrawals","outputs":[
    {"internalType":"address","name":"user","type":"address"},
    {"internalType":"uint256","name":"amount","type":"uint256"},
    {"internalType":"bool","name":"approved","type":"bool"},
    {"internalType":"uint256","name":"timestamp","type":"uint256"}
  ],"stateMutability":"view","type":"function"}, // Assuming this view function exists
  {"inputs":[],"name":"nextWithdrawId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
];

const TOKEN_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];

// --- UTILITY FUNCTIONS ---
function displayMessage(text, isError = false) {
    const msgEl = document.getElementById('stakeNote'); // General message display
    msgEl.style.color = isError ? 'var(--danger)' : 'var(--success)';
    msgEl.innerHTML = text;
}

function formatToken(amountWei, decimals = CONFIG.decimals) {
    if (!amountWei) return "0.000000";
    return ethers.utils.formatUnits(amountWei, decimals).toString();
}

function truncateAddress(address) {
    return `${address.substring(0, 6)}...${address.slice(-4)}`;
}

// --- CORE FUNCTIONS ---

// 1. ‡§µ‡•â‡§≤‡•á‡§ü ‡§ï‡•ã ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
async function connectWallet() {
    if (typeof window.ethereum === 'undefined') {
        document.getElementById('walletDisplay').innerHTML = `MetaMask not installed!`;
        return;
    }
    
    try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        // Contracts
        stakingContract = new ethers.Contract(CONFIG.stakingAddress, STAKING_ABI, signer);
        tokenContract = new ethers.Contract(CONFIG.tokenAddress, TOKEN_ABI, signer);
        
        document.getElementById('walletDisplay').innerHTML = `Connected: ${truncateAddress(userAddress)}`;
        document.getElementById('connectBtn').innerText = 'Connected';
        document.getElementById('connectBtn').disabled = true;

        // ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§≤‡§ø‡§Ç‡§ï ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        document.getElementById('refLink').value = `${window.location.origin}/?ref=${userAddress}`;
        
        // UI ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
        loadDashboardData(userAddress);
        
    } catch (error) {
        console.error("Wallet connection failed:", error);
        document.getElementById('walletDisplay').innerHTML = `Connection Failed.`;
    }
}

// 2. ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
async function loadDashboardData(addr) {
    if (!stakingContract) return;

    try {
        // ‡§Æ‡§≤‡•ç‡§ü‡•Ä‡§™‡§≤ ‡§µ‡•ç‡§Ø‡•Ç ‡§ï‡•â‡§≤‡•ç‡§∏
        const [tokenBalanceRaw, userInfo, daysTo3xRaw] = await Promise.all([
            tokenContract.balanceOf(addr),
            stakingContract.users(addr),
            stakingContract.getTimeTo3x(addr)
        ]);

        const totalStake = userInfo.totalStake;
        const totalEarned = userInfo.totalEarned;
        const maxCap = totalStake.mul(3); // 3x cap

        // Calculate ROI (Assuming you are calling getWithdrawable to update rewards, but for display:
        // We will display the recorded income fields.
        const roiPending = userInfo.roiIncome;
        const instantIncome = userInfo.instantIncome;
        const levelIncome = userInfo.levelIncome;
        const totalWallet = instantIncome.add(levelIncome).add(roiPending).sub(userInfo.totalWithdrawn);
        
        // --- DISPLAY UI ---

        // 1. Balances & Income
        document.getElementById('totalWallet').innerText = `${formatToken(totalWallet)} USDT`;
        document.getElementById('instantIncome').innerText = `${formatToken(instantIncome)} USDT`;
        document.getElementById('levelIncome').innerText = `${formatToken(levelIncome)} USDT`;
        document.getElementById('roiPending').innerText = `${formatToken(roiPending)} USDT`;
        document.getElementById('totalWallet').innerText = `${formatToken(totalWallet)} USDT`;

        // 2. Staking Info
        document.getElementById('stakedDisplay').innerText = `${formatToken(totalStake)} USDT`;
        document.getElementById('targetDisplay').innerText = `${formatToken(maxCap)} USDT`;
        document.getElementById('days3x').innerText = totalStake.isZero() ? 'N/A' : `${daysTo3xRaw.toString()} days`;
        
        const status = totalStake.isZero() ? 'No Stake' : userInfo.isActive ? 'Active' : 'Completed 3x';
        document.getElementById('pkgStatus').innerText = status;
        
        // 3. Progress Bar
        let progressPercent = 0;
        if (!totalStake.isZero()) {
            progressPercent = totalEarned.mul(100).div(maxCap).toNumber();
            if (progressPercent > 100) progressPercent = 100;
        }
        document.getElementById('progressFill').style.width = `${progressPercent}%`;
        document.getElementById('progressLabel').innerText = `${progressPercent.toFixed(1)}% completed (${formatToken(totalEarned)} / ${formatToken(maxCap)} USDT)`;

        // 4. Withdrawal History (Simplified - fetching only last 5 requests)
        await loadWithdrawalHistory();
        
        // 5. Level Status (Simplified based on direct count. Your contract checks total directs, we will simplify)
        await updateLevelStatus(addr, userInfo.directs);
        
    } catch (error) {
        console.error("Error loading dashboard data:", error);
        displayMessage("Error loading dashboard data. Check console.", true);
    }
}

// 3. USDT ‡§Ö‡§™‡•ç‡§∞‡•Ç‡§µ ‡§ï‡§∞‡•á‡§Ç
async function approveUSDT() {
    if (!signer) { displayMessage("Please connect wallet first.", true); return; }
    
    const amountToApprove = document.getElementById('stakeAmt').value;
    if (!amountToApprove || isNaN(amountToApprove) || Number(amountToApprove) < CONFIG.minStake) {
        displayMessage(`Please enter a valid amount (min ${CONFIG.minStake} USDT).`, true);
        return;
    }

    try {
        const amountWei = ethers.utils.parseUnits(amountToApprove, CONFIG.decimals);
        displayMessage("Approving USDT... (Check MetaMask)");

        const tx = await tokenContract.approve(CONFIG.stakingAddress, amountWei);
        await tx.wait(); 

        displayMessage(`‚úÖ Approved ${amountToApprove} USDT. You can now Stake.`, false);
        return true; 
    } catch (error) {
        console.error("Approval failed:", error);
        displayMessage(`‚ùå Approval failed. Error: ${error.reason || error.message}`, true);
        return false;
    }
}


// 4. ‡§∏‡•ç‡§ü‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
async function handleStake() {
    if (!signer) { displayMessage("Please connect wallet first.", true); return; }
    
    const amountToStake = document.getElementById('stakeAmt').value;
    // For simplicity, we assume the user has a referrer, otherwise they need to call register first.
    // We'll use a placeholder referral address (Owner/Admin) if none is provided.
    const referrerAddress = document.getElementById('refLink').value.split('=')[1] || ownerAddress;
    
    if (!amountToStake || isNaN(amountToStake) || Number(amountToStake) < CONFIG.minStake || Number(amountToStake) % CONFIG.minStake !== 0) {
        displayMessage(`Please enter a valid amount (min ${CONFIG.minStake} and multiple of ${CONFIG.minStake}).`, true);
        return;
    }

    // A. Approve check is ideally done here, but for the "Quick Approve" button, we skip it.
    // If you want "Stake Now" to also approve, move the approveUSDT logic here.
    
    try {
        const amountWei = ethers.utils.parseUnits(amountToStake, CONFIG.decimals);

        displayMessage("Staking tokens... (Check MetaMask)");

        // stake(uint256 amount, address ref)
        const tx = await stakingContract.stake(amountWei, referrerAddress);
        await tx.wait(); 

        displayMessage(`‚úÖ ${amountToStake} USDT staked successfully!`, false);
        loadDashboardData(userAddress); 
    } catch (error) {
        console.error("Staking failed:", error);
        displayMessage(`‚ùå Staking failed. Error: ${error.reason || error.message}`, true);
    }
}


// 5. P2P ‡§∏‡•ç‡§ü‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
async function handleStakeFor() {
    if (!signer) { displayMessage("Please connect wallet first.", true); return; }
    
    const amount = document.getElementById('p2pAmount').value;
    const recipient = document.getElementById('p2pAddress').value;
    
    if (!amount || isNaN(amount) || Number(amount) < CONFIG.minStake) {
        displayMessage(`Please enter a valid amount (min ${CONFIG.minStake} USDT).`, true);
        return;
    }
    if (!ethers.utils.isAddress(recipient)) {
        displayMessage("Invalid recipient address.", true);
        return;
    }

    // P2P stake requires the caller (msg.sender) to approve the staking contract for the amount.
    // We must call approve here first, unless we assume a prior approval.
    // For simplicity, we assume a prior approval or use the quick approve button.
    
    try {
        const amountWei = ethers.utils.parseUnits(amount, CONFIG.decimals);

        displayMessage(`Staking ${amount} USDT for ${truncateAddress(recipient)}... (Check MetaMask)`);

        // stakeFor(address refUser, uint256 amount, address refForRefUser)
        // refForRefUser is needed if the recipient is not registered. We use the owner/admin address as per contract
        const tx = await stakingContract.stakeFor(recipient, amountWei, ownerAddress); 
        await tx.wait(); 

        displayMessage(`‚úÖ P2P Stake successful for ${truncateAddress(recipient)}!`, false);
        loadDashboardData(userAddress); 
    } catch (error) {
        console.error("P2P Staking failed:", error);
        displayMessage(`‚ùå P2P Staking failed. Error: ${error.reason || error.message}`, true);
    }
}

// 6. ‡§µ‡§ø‡§•‡§°‡•ç‡§∞‡•â ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü
async function handleRequestWithdrawal() {
    if (!signer) { displayMessage("Please connect wallet first.", true); return; }
    
    const amountToWithdraw = document.getElementById('withdrawAmt').value;
    
    if (!amountToWithdraw || isNaN(amountToWithdraw) || Number(amountToWithdraw) < CONFIG.minStake) {
        displayMessage(`Please enter a valid amount (min ${CONFIG.minStake} USDT).`, true);
        return;
    }

    try {
        const amountWei = ethers.utils.parseUnits(amountToWithdraw, CONFIG.decimals);

        displayMessage("Requesting withdrawal... (Check MetaMask)");

        // requestWithdrawal(uint256 amt)
        const tx = await stakingContract.requestWithdrawal(amountWei);
        await tx.wait(); 

        displayMessage(`‚úÖ Withdrawal request for ${amountToWithdraw} USDT submitted! Admin needs to approve.`, false);
        loadDashboardData(userAddress); 
    } catch (error) {
        console.error("Withdrawal request failed:", error);
        displayMessage(`‚ùå Withdrawal request failed. Error: ${error.reason || error.message}`, true);
    }
}

// 7. ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (Withdrawal History)
async function loadWithdrawalHistory() {
    const historyBody = document.getElementById('withdrawHistoryBody');
    historyBody.innerHTML = '<tr><td colspan="4" class="center muted">Loading...</td></tr>';

    try {
        const nextIdRaw = await stakingContract.nextWithdrawId();
        const nextId = nextIdRaw.toNumber();
        const MAX_ENTRIES = 5; 
        
        let foundHistory = false;
        historyBody.innerHTML = '';
        
        for (let i = 1; i < nextId && i < nextId + MAX_ENTRIES; i++) {
            const withdrawal = await stakingContract.withdrawals(i);
            
            // Display only the current user's requests
            if (withdrawal.user.toLowerCase() === userAddress.toLowerCase()) {
                foundHistory = true;
                const timestamp = new Date(withdrawal.timestamp.toNumber() * 1000).toLocaleString();
                const amount = formatToken(withdrawal.amount);
                const approvedStatus = withdrawal.approved ? `<span style="color:var(--success)">Approved</span>` : `<span style="color:var(--danger)">Pending</span>`;
                
                const row = `<tr>
                                <td>${timestamp}</td>
                                <td>${amount}</td>
                                <td>${approvedStatus}</td>
                                <td>#${i}</td>
                             </tr>`;
                historyBody.insertAdjacentHTML('afterbegin', row); // Show newest first
            }
        }

        if (!foundHistory) {
            historyBody.innerHTML = '<tr><td colspan="4" class="center muted">No history for this user.</td></tr>';
        }

    } catch (error) {
        console.error("Error loading withdrawal history (ABI Check!):", error);
        historyBody.innerHTML = '<tr><td colspan="4" class="center muted">Error loading history. Check console/ABI.</td></tr>';
    }
}

// 8. ‡§≤‡•á‡§µ‡§≤ ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (Simplified)
async function updateLevelStatus(addr) {
    // This requires calling the 'users' view function again, but we reuse the data from loadDashboardData
    const userInfo = await stakingContract.users(addr);
    const directsCount = userInfo.directs.length;
    
    document.getElementById('directCount').innerText = directsCount; // Display Directs count
    // Indirect count and Active/Inactive counts require iterating through the directs, which is complex for a simple script.
    document.getElementById('indirectCount').innerText = 'N/A';
    document.getElementById('activeCounts').innerText = 'N/A';

    // Update Level Status based on the number of directs (simplified requirement)
    // The contract requires directs.length >= level number (i+1) for level income.
    for (let i = 1; i <= 10; i++) {
        const statusEl = document.getElementById(`sL${i}`);
        if (directsCount >= i) {
            statusEl.innerHTML = `<span style="color:var(--success);font-weight:600;">Active (${i} Directs)</span>`;
        } else {
            statusEl.innerHTML = `<span style="color:var(--danger);font-weight:600;">Pending (${i} Directs Req.)</span>`;
        }
    }
}


// --- EVENT LISTENERS ---
window.onload = function() {
    // 1. Connect Wallet
    document.getElementById('connectBtn').addEventListener('click', connectWallet);
    
    // 2. Refresh Dashboard
    document.getElementById('refreshBtn').addEventListener('click', () => {
        if (userAddress) loadDashboardData(userAddress);
        else displayMessage("Connect wallet to refresh data.", true);
    });

    // 3. Stake Actions
    document.getElementById('approveBtn').addEventListener('click', approveUSDT);
    document.getElementById('stakeBtn').addEventListener('click', handleStake);
    document.getElementById('stakeForBtn').addEventListener('click', handleStakeFor);

    // 4. Withdrawal
    document.getElementById('requestWithdraw').addEventListener('click', handleRequestWithdrawal);

    // 5. Copy Link
    document.getElementById('copyLink').addEventListener('click', () => {
        const link = document.getElementById('refLink').value;
        navigator.clipboard.writeText(link).then(() => {
            alert('Referral Link copied!');
        });
    });

    // 6. Show Team (Placeholder)
    document.getElementById('showTeam').addEventListener('click', () => {
        alert("Team section coming soon! You have direct count displayed.");
    });
};