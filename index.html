Index.html Github Old code<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USDT Staking Dashboard</title>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root { --bg:#0b0d0f; --card:#121416; --muted:#9aa4b2; --accent:#ffd86b; --panel:#0f1113; }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#e6eef6;}
    header{padding:18px 24px;text-align:center;background:linear-gradient(90deg,#081018,#0d1016);box-shadow:0 2px 8px rgba(0,0,0,0.5);}
    header h1{margin:0;color:var(--accent);font-size:20px;letter-spacing:0.6px;}
    .topbar{display:flex;justify-content:flex-end;gap:12px;padding:12px 24px;align-items:center;}
    .wallet-btn{background:var(--accent);color:#000;padding:8px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer;}
    .container{padding:20px;display:grid;grid-template-columns:360px 1fr;gap:18px;max-width:1180px;margin:18px auto;}
    .left{display:flex;flex-direction:column;gap:14px;}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.4);}
    .card h2{margin:0 0 10px 0;color:var(--accent);font-size:16px;}
    .muted{color:var(--muted);font-size:13px;}
    input[type="number"],input[type="text"]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:#fff;}
    .small-btn{padding:10px 12px;border-radius:8px;border:0;background:#2a2f35;color:#fff;cursor:pointer;margin-top:8px;}
    .accent-btn{background:var(--accent);color:#000;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;margin-top:8px;}
    .right{display:flex;flex-direction:column;gap:14px;}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .value{font-size:18px;font-weight:700;color:#fff;}
    .label{font-size:12px;color:var(--muted);margin-top:6px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;}
    th{color:var(--accent);font-weight:700;}
    .center{text-align:center;}
    .sm{font-size:12px;color:var(--muted);}
    footer{padding:14px;text-align:center;color:var(--muted);font-size:12px;}
    @media(max-width:980px){.container{grid-template-columns:1fr;padding:12px;}.grid-4{grid-template-columns:repeat(2,1fr);}}
  </style>
</head>
<body>
<header><h1>USDT Staking ‚Äî Dashboard</h1></header>

<div class="topbar" style="max-width:1180px;margin:0 auto">
  <div id="walletDisplay" class="sm muted">Not connected</div>
  <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
</div>

<main class="container">
  <div class="left">
    <div class="card">
      <h2>Stake USDT</h2>
      <div class="sm muted">Minimum deposit: 20 USDT ‚Äî multiples of 20 only</div>
      <input id="stakeAmount" type="number" placeholder="20, 40, 60 ..." />
      <button class="accent-btn" id="quickApproveBtn">Quick Approve</button>
      <button class="accent-btn" id="stakeBtn">Stake Now</button>
      <div class="sm" style="margin-top:10px;">Tip: Approve once (Quick Approve) then stake.</div>
    </div>

    <input id="stakeAmt" type="number" placeholder="Enter amount (min 20)" class="form-control" style="width:100%;margin-top:8px;margin-bottom:8px;padding:8px;border-radius:8px;border:1px solid #444;background:#111;color:#fff;">

  <button id="approveBtn" class="btn btn-warning">Quick Approve</button>
  <button id="stakeBtn" class="btn btn-success">Stake Now</button>
</div>


<div class="card" style="background:#111;padding:20px;border-radius:12px;color:#fff;">
  <h3 style="color:#ffd700;">ü§ù Stake For (P2P)</h3>
  <p style="font-size:14px;color:#ccc;">Stake for other wallet (No 5% fee)</p>

  <input id="p2pAmount" 
         type="number" 
         placeholder="P2P stake amount (min 20)" 
         style="width:100%;margin-top:10px;margin-bottom:10px;padding:10px;
                border-radius:8px;border:1px solid #444;background:#000;color:#fff;">

  <input id="p2pAddress" 
         type="text" 
         placeholder="Wallet address for P2P" 
         style="width:100%;margin-top:10px;margin-bottom:10px;padding:10px;
                border-radius:8px;border:1px solid #444;background:#000;color:#fff;">

  <button id="stakeForBtn" 
          class="btn" 
          style="width:100%;background:#0984e3;color:#fff;padding:10px;border:none;
                 border-radius:8px;cursor:pointer;font-weight:600;">
    Stake For (P2P)
  </button>
</div>

      <h2>Your Referral Link</h2>
      <input id="referralInput" type="text" readonly />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="small-btn" id="copyRefBtn">Copy Link</button>
        <button class="small-btn" id="showTeamBtn">Show Team</button>
      </div>
      <div class="sm muted" style="margin-top:8px;">Share this link. Users who join via referral will credit you 10% instant (internal balance).</div>
    </div>
    <div class="card">
      <h2>Withdraw</h2>
      <div class="sm muted">Minimum withdraw 20 USDT ‚Äî multiples of 10. Withdrawals require admin approval.</div>
      <input id="withdrawAmount" type="number" placeholder="20, 40, 60 ..." />
      <button class="accent-btn" id="withdrawBtn">Request Withdraw</button>
      <div id="withdrawStatus" class="sm" style="margin-top:8px;">No withdraw actions yet.</div>
    </div>
  </div>

  <div class="right">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h2>Wallet Balances & Income</h2><div class="sm muted">Instant / Level / ROI breakdown</div></div>
        <div><button class="small-btn" id="refreshBtn">Refresh Now</button></div>
      </div>

      <div style="margin-top:12px" class="grid-4">
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Instant Income</div>
          <div class="value" id="instantIncome">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Level income</div>
          <div class="value" id="levelIncome">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">ROI Pending</div>
          <div class="value" id="roiPending">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Total Wallet</div>
          <div class="value" id="totalWallet">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;margin-top:12px;">
          <div class="label">Team Business</div>
          <div class="value" id="teamBusiness">0.000000 USDT</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Staking Info</h2>
      <table>
        <tr><th>Metric</th><th>Value</th></tr>
        <tr><td>Staked</td><td id="stakedDisplay">0.000000 USDT</td></tr>
        <tr><td>Target (3x)</td><td id="targetDisplay">0.000000 USDT</td></tr>
        <tr><td>Days to 3x</td><td id="days3x">0 days</td></tr>
        <tr><td>Package Status</td><td id="pkgStatus">Inactive</td></tr>
      </table>
    </div>

    <div class="card">
      <h2>Team & Levels</h2>
      <div style="display:flex; gap:12px; align-items:center;">
        <div style="flex:1"><div class="sm muted">Direct</div><div class="value" id="directCount">0</div></div>
        <div style="flex:1"><div class="sm muted">Indirect</div><div class="value" id="indirectCount">0</div></div>
        <div style="flex:2"><div class="sm muted">Active / Inactive</div><div class="value" id="activeCounts">0 / 0</div></div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3 style="margin:6px 0 8px;color:var(--accent)">Direct Team</h3>
        <table id="directTeamTable"><thead><tr><th>Wallet</th><th>Staked</th><th>Status</th></tr></thead>
          <tbody id="directTeamBody"><tr><td colspan="3" class="center sm">No directs yet.</td></tr></tbody></table>

        <h3 style="margin:12px 0 8px;color:var(--accent)">Indirect Team</h3>
        <table id="indirectTeamTable"><thead><tr><th>Wallet</th><th>Staked</th><th>Status</th></tr></thead>
          <tbody id="indirectTeamBody"><tr><td colspan="3" class="center sm">No indirects yet.</td></tr></tbody></table>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Level</th><th>Percent</th><th>Status</th></tr></thead>
          <tbody id="levelsTbody">
            <tr><td>L1</td><td>10%</td><td id="sL1">Pending</td></tr>
            <tr><td>L2</td><td>10%</td><td id="sL2">Pending</td></tr>
            <tr><td>L3</td><td>5%</td><td id="sL3">Pending</td></tr>
            <tr><td>L4</td><td>3%</td><td id="sL4">Pending</td></tr>
            <tr><td>L5</td><td>2%</td><td id="sL5">Pending</td></tr>
            <tr><td>L6</td><td>1%</td><td id="sL6">Pending</td></tr>
            <tr><td>L7</td><td>1%</td><td id="sL7">Pending</td></tr>
            <tr><td>L8</td><td>1%</td><td id="sL8">Pending</td></tr>
            <tr><td>L9</td><td>1%</td><td id="sL9">Pending</td></tr>
            <tr><td>L10</td><td>1%</td><td id="sL10">Pending</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Withdrawal History</h2>
      <table id="withdrawHistoryTable">
        <thead><tr><th>Req ID</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
        <tbody id="withdrawHistoryBody"><tr><td colspan="4" class="center sm">No withdrawals yet.</td></tr></tbody>
      </table>
    </div>

  </div>
</main>

   <!-- üü° NEW: Disclaimer Card -->
    <div class="card" style="background:#101214;color:#ccc;">
      <h2 style="color:#ffd86b;">Disclaimer</h2>
      <div style="font-size:13px;line-height:1.6;">
        This platform operates on the <b>Binance Smart Chain Testnet</b>.  
        All actions here are for testing and educational purposes only.  
        <span style="color:#ffd86b;">Do not use real USDT or mainnet funds</span>.  
        Developers are not responsible for any loss of funds during testing.
      </div>
    </div>

  </div>

<footer>Made with ‚ù§Ô∏è ‚Äî Testnet only (do not use mainnet funds while testing)</footer>

<script>
/* ==================== CONFIG ==================== */
const STAKING_ADDRESS = "0xE65396C1B8c63167A86d374ec7aD8F1471CC1F2f";
const TOKEN_ADDRESS   = "0x1a904b37B0d9D6ab755aBDa4656E42F278FC89AA";

let TOKEN_DECIMALS = 6; // default
let provider, signer, stakingContract, tokenContract, account = null;

/* ==================== ABI (match the Solidity above) ==================== */
/* If you recompile contract, paste the new ABI here */
 // ====================== STAKING_ABI ======================
const STAKING_ABI = [
  // üü¢ Custom additions (stake & stakeFor)
  {
    "inputs": [
      { "internalType": "uint256", "name": "amount", "type": "uint256" },
      { "internalType": "address", "name": "ref", "type": "address" }
    ],
    "name": "stake",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "address", "name": "refUser", "type": "address" },
      { "internalType": "uint256", "name": "amount", "type": "uint256" },
      { "internalType": "address", "name": "refForRefUser", "type": "address" }
    ],
    "name": "stakeFor",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },

  // üß© Full Contract ABI (as provided)
  {
    "inputs": [
      { "internalType": "contract IERC20", "name": "_token", "type": "address" },
      { "internalType": "address", "name": "_adminWallet", "type": "address" }
    ],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  { "inputs": [], "name": "EnforcedPause", "type": "error" },
  { "inputs": [], "name": "ExpectedPause", "type": "error" },
  { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }], "name": "OwnableInvalidOwner", "type": "error" },
  { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "OwnableUnauthorizedAccount", "type": "error" },
  { "inputs": [{ "internalType": "address", "name": "token", "type": "address" }], "name": "SafeERC20FailedOperation", "type": "error" },
  {
    "anonymous": false,
    "inputs": [{ "indexed": true, "internalType": "address", "name": "newAdmin", "type": "address" }],
    "name": "AdminWalletUpdated",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "to", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
    ],
    "name": "EmergencyWithdraw",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
      { "indexed": true, "internalType": "address", "name": "to", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
    ],
    "name": "InstantCommissionPaid",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
      { "indexed": true, "internalType": "address", "name": "to", "type": "address" },
      { "indexed": false, "internalType": "uint8", "name": "level", "type": "uint8" },
      { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
    ],
    "name": "LevelCommissionPaid",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" },
      { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }
    ],
    "name": "OwnershipTransferred",
    "type": "event"
  },
  { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "account", "type": "address" }], "name": "Paused", "type": "event" },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": true, "internalType": "address", "name": "referrer", "type": "address" }
    ],
    "name": "Registered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
    ],
    "name": "RoiAccrued",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
    ],
    "name": "Staked",
    "type": "event"
  },
  { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "account", "type": "address" }], "name": "Unpaused", "type": "event" },
  {
    "anonymous": false,
    "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }],
    "name": "UserPaused",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }],
    "name": "UserUnpaused",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "id", "type": "uint256" },
      { "indexed": false, "internalType": "uint256", "name": "gross", "type": "uint256" },
      { "indexed": false, "internalType": "uint256", "name": "net", "type": "uint256" },
      { "indexed": false, "internalType": "uint256", "name": "fee", "type": "uint256" }
    ],
    "name": "WithdrawalApproved",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "id", "type": "uint256" },
      { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
    ],
    "name": "WithdrawalRequested",
    "type": "event"
  },
  { "inputs": [], "name": "BPS_DIV", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "MAX_LEVELS", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "adminWallet", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "id", "type": "uint256" }], "name": "approveWithdrawal", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "dailyROIbps", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }], "name": "emergencyWithdrawAll", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "usr", "type": "address" }], "name": "getTimeTo3x", "outputs": [{ "internalType": "uint256", "name": "daysLeft", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "usr", "type": "address" }], "name": "getWithdrawable", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "levelPercents", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "maxRewardMultiplier", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "minStake", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "nextWithdrawId", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "pauseContract", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "a", "type": "address" }], "name": "pauseUser", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "paused", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "ref", "type": "address" }], "name": "register", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "registered", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "amt", "type": "uint256" }], "name": "requestWithdrawal", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "a", "type": "address" }], "name": "setAdminWallet", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "bps", "type": "uint256" }], "name": "setDailyRoi", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "bps", "type": "uint256" }], "name": "setWithdrawFee", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "token", "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "totalFeesCollected", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "totalStaked", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "totalUsers", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "totalWithdrawnNet", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "unpauseContract", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "a", "type": "address" }], "name": "unpauseUser", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "withdrawFeeBps", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }
];

const TOKEN_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];

/* ==================== HELPERS ==================== */
function toFixedNumber(num, decimals = 6) {
  if (isNaN(num)) return "0.000000";
  return Number(num).toFixed(decimals);
}
function fromUnits(valueBn) {
  try { return Number(ethers.utils.formatUnits(valueBn, TOKEN_DECIMALS)); }
  catch (e) { return Number(valueBn) / (10 ** TOKEN_DECIMALS); }
}

/* ==================== CONNECT WALLET ==================== */
async function connect() {
  try {
    if (!window.ethereum) { alert("MetaMask not found. Install and refresh."); return; }
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    account = await signer.getAddress();

    document.getElementById("walletDisplay").innerText = `${account}`;
    document.getElementById("connectBtn").innerText = "Connected ‚úÖ";

    stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);
    tokenContract   = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);

    try { TOKEN_DECIMALS = await tokenContract.decimals(); } catch (e) { TOKEN_DECIMALS = 6; }

    // ‚úÖ Robust referral link generator (works on GitHub pages, custom domain, localhost, all)
const baseURL = window.location.href.split("?")[0]; 
document.getElementById("referralInput").value = `${baseURL}?ref=${account}`;
console.log("Referral link generated:", `${baseURL}?ref=${account}`);

    // Attach event listeners (contract events)
    listenEvents();

    await refreshAll();
  } catch (err) {
    console.error("connect error", err);
    alert("Connect failed: " + (err?.message || err));
  }
}
document.getElementById("connectBtn").addEventListener("click", connect);

/* Auto reconnect */
window.addEventListener("load", async () => {
  const prev = localStorage.getItem("staking_connected");
  if (prev && window.ethereum) {
    try {
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      const accs = await provider.listAccounts();
      if (accs && accs.length > 0) {
        signer = provider.getSigner();
        account = accs[0];
        stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);
        tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
        document.getElementById("walletDisplay").innerText = account;
        document.getElementById("connectBtn").innerText = "Connected ‚úÖ";
        listenEvents();
        document.getElementById("stakeBtn").addEventListener("click", stake);
        document.getElementById("withdrawBtn").addEventListener("click", withdraw);
        await refreshAll();
      }
    } catch (e) { console.warn("Auto reconnect failed", e); }
  }
});

/* ==================== EVENT HELPERS (parse logs for instant & level incomes) ==================== */
async function sumReferralEventsFor(accountAddr) {
  if (!provider) return 0;
  try {
    const iface = new ethers.utils.Interface(STAKING_ABI);
    const filter = stakingContract.filters.ReferralCredited(accountAddr, null); // ‚úÖ corrected
    const logs = await provider.getLogs({
      address: STAKING_ADDRESS,
      fromBlock: 0,
      toBlock: "latest",
      topics: filter.topics,
    });
    let sumUnits = ethers.BigNumber.from(0);
    for (const l of logs) {
      const parsed = iface.parseLog(l);
      const amountUnits = parsed.args.amountUnits;
      sumUnits = sumUnits.add(amountUnits);
    }
    return fromUnits(sumUnits);
  } catch (e) {
    console.warn("sumReferralEventsFor failed, fallback to 0", e);
    return 0;
  }
}

async function sumLevelEventsFor(accountAddr) {
  if (!provider) return 0;
  try {
    const iface = new ethers.utils.Interface(STAKING_ABI);
    const filter = stakingContract.filters.LevelCredited(accountAddr, null); // ‚úÖ corrected
    const logs = await provider.getLogs({
      address: STAKING_ADDRESS,
      fromBlock: 0,
      toBlock: "latest",
      topics: filter.topics,
    });
    let sumUnits = ethers.BigNumber.from(0);
    for (const l of logs) {
      const parsed = iface.parseLog(l);
      const amountUnits = parsed.args.amountUnits;
      sumUnits = sumUnits.add(amountUnits);
    }
    return fromUnits(sumUnits);
  } catch (e) {
    console.warn("sumLevelEventsFor failed, fallback to 0", e);
    return 0;
  }
}

/* ==================== REFRESH ALL (main) ==================== */
/* ==================== REFRESH ALL (main) ==================== */
async function refreshAll() {
  if (!stakingContract || !account) return;
  try {
    // === WALLET BALANCE ===
    const rawBal = await tokenContract.balanceOf(account);
    const walletBal = fromUnits(rawBal);
    document.getElementById("walletDisplay").innerText =
      `${account} ‚Äî ${toFixedNumber(walletBal, 6)} USDT`;

    // === USER INFO ===
    const info = await stakingContract.users(account);

    const staked = fromUnits(info.totalStake || 0);
    const roiPending = fromUnits(info.roiIncome || 0);
    const instantIncome = fromUnits(info.instantIncome || 0);
    const levelIncome = fromUnits(info.levelIncome || 0);
    const totalEarned = fromUnits(info.totalEarned || 0);
    const isActive = info.isActive || false;

    document.getElementById("pkgStatus").innerText = isActive ? "Active ‚úÖ" : "Inactive ‚ùå";

    // === DAYS TO 3x ===
    let daysLeft = 0;
    try {
      const res = await stakingContract.getTimeTo3x(account);
      daysLeft = Number(res || 0);
    } catch (err) {
      console.warn("getTimeTo3x error (fallback to 0)", err);
    }

    document.getElementById("stakedDisplay").innerText =
      toFixedNumber(staked, 6) + " USDT";
    document.getElementById("targetDisplay").innerText =
      toFixedNumber(staked * 3, 6) + " USDT";
    document.getElementById("days3x").innerText = daysLeft + " days";

    // === INCOME SUMMARY ===
    document.getElementById("instantIncome").innerText =
      toFixedNumber(instantIncome, 6) + " USDT";
    document.getElementById("levelIncome").innerText =
      toFixedNumber(levelIncome, 6) + " USDT";
    document.getElementById("roiPending").innerText =
      toFixedNumber(roiPending, 6) + " USDT";

    // === TOTAL WALLET CALCULATION ===
    const totalWallet =
      instantIncome + levelIncome + roiPending;
    document.getElementById("totalWallet").innerText =
      toFixedNumber(totalWallet, 6) + " USDT";

    // === TEAM DATA ===
    const directs = await stakingContract.getDirectRefs(account);
    const directCount = directs.length;

    let teamBusiness = 0;
    let indirectCount = 0;

    for (const d of directs) {
      const dInfo = await stakingContract.users(d);
      teamBusiness += fromUnits(dInfo.totalStake || 0);

      const subs = await stakingContract.getDirectRefs(d);
      indirectCount += subs.length;
      for (const s of subs) {
        const sInfo = await stakingContract.users(s);
        teamBusiness += fromUnits(sInfo.totalStake || 0);
      }
    }

    document.getElementById("teamBusiness").innerText =
      toFixedNumber(teamBusiness, 6) + " USDT";
    document.getElementById("directCount").innerText = directCount;
    document.getElementById("indirectCount").innerText = indirectCount;

    // === ACTIVE / INACTIVE ===
    let active = 0,
      inactive = 0;
    for (const d of directs) {
      const dInfo = await stakingContract.users(d);
      const st = fromUnits(dInfo.totalStake || 0);
      if (st > 0) active++;
      else inactive++;
    }
    document.getElementById("activeCounts").innerText = `${active} / ${inactive}`;

    // === LEVEL UNLOCK LOGIC ===
    const rows = document.querySelectorAll("#levelsTbody tr");
    rows.forEach((r, i) => {
      const cell = r.querySelector("td:last-child");
      if (!cell) return;
      if (i < Math.min(directCount, 10)) {
        cell.innerText = "Open ‚úÖ";
        cell.style.color = "#00FF90";
        cell.style.fontWeight = "600";
      } else {
        cell.innerText = "Pending";
        cell.style.color = "";
        cell.style.fontWeight = "";
      }
    });

    console.log("‚úÖ Refresh done:", {
      staked,
      roiPending,
      instantIncome,
      levelIncome,
      totalEarned,
      teamBusiness,
      daysLeft,
    });
  } catch (err) {
    console.error("refreshAll error:", err);
  }
}

/* ===================== STAKE FUNCTION ===================== */
async function stake() {
  if (!stakingContract || !tokenContract || !account) {
    return alert("‚ö†Ô∏è Please connect your wallet first.");
  }

  const amount = document.getElementById("stakeAmt").value;
  const ref = new URLSearchParams(window.location.search).get("ref") || ethers.ZeroAddress;

  if (!amount || Number(amount) < 20) {
    return alert("‚ö†Ô∏è Minimum stake is 20 USDT.");
  }

  try {
    const units = toUnits(amount);

    // üîπ Check if user is registered or not
    let isRegistered = false;
    try {
      isRegistered = await stakingContract.registered(account);
    } catch (e) {
      console.warn("Registered check failed:", e);
    }

    // üîπ Auto-register if not yet registered
    if (!isRegistered) {
      alert("üîÑ Registering your account...");
      const regTx = await stakingContract.register(ref);
      await regTx.wait();
      alert("‚úÖ Registration successful!");
    }

    // üîπ Approve Token if needed
    const allowance = await tokenContract.allowance(account, STAKING_ADDRESS);
    if (allowance < units) {
      alert("üîπ Approving token spending...");
      const approveTx = await tokenContract.approve(STAKING_ADDRESS, ethers.MaxUint256);
      await approveTx.wait();
      alert("‚úÖ Token approved successfully!");
    }

    // üîπ Perform Staking
    alert("üöÄ Staking in progress...");
    const tx = await stakingContract.stake(units, ref);
    await tx.wait();

    alert("‚úÖ Staking successful!");
    await refreshAll();
  } catch (err) {
    console.error("Stake failed:", err);
    alert("‚ùå Stake failed: " + (err.message || "Unknown error"));
  }
}

/* ===================== STAKE FOR (P2P) ===================== */
async function stakeFor() {
  if (!stakingContract || !tokenContract || !account) {
    return alert("‚ö†Ô∏è Please connect your wallet first.");
  }

  const amount = document.getElementById("p2pAmount").value;
  const refUser = document.getElementById("p2pAddress").value;

  if (!refUser || !ethers.isAddress(refUser)) {
    return alert("‚ö†Ô∏è Enter a valid wallet address to stake for.");
  }
  if (!amount || Number(amount) < 20) {
    return alert("‚ö†Ô∏è Minimum stake for P2P is 20 USDT.");
  }

  try {
    const units = toUnits(amount);

    // üîπ Check if refUser is registered or not
    let isRefRegistered = false;
    try {
      isRefRegistered = await stakingContract.registered(refUser);
    } catch (e) {
      console.warn("Ref user check failed:", e);
    }

    // üîπ Auto-register if not yet registered
    if (!isRefRegistered) {
      alert("üîÑ Registering P2P user...");
      const regTx = await stakingContract.register(ethers.ZeroAddress);
      await regTx.wait();
      alert("‚úÖ P2P user registered!");
    }

    // üîπ Approve Token if needed
    const allowance = await tokenContract.allowance(account, STAKING_ADDRESS);
    if (allowance < units) {
      alert("üîπ Approving token spending...");
      const approveTx = await tokenContract.approve(STAKING_ADDRESS, ethers.MaxUint256);
      await approveTx.wait();
      alert("‚úÖ Token approved successfully!");
    }

    // üîπ Perform P2P Stake
    alert("üöÄ P2P staking in progress...");
    const tx = await stakingContract.stakeFor(refUser, units, ethers.ZeroAddress);
    await tx.wait();

    alert("‚úÖ P2P staking successful!");
    await refreshAll();
  } catch (err) {
    console.error("P2P stake failed:", err);
    alert("‚ùå P2P stake failed: " + (err.message || "Unknown error"));
  }
}

async function claim() {
  try {
    if (!stakingContract || !signer) { alert("Connect wallet first"); return; }
    const tx = await stakingContract.claimRewards();
    alert("Claim transaction sent...");
    await tx.wait();
    alert("Claim processed");
    await refreshAll();
  } catch (e) {
    console.error("claim error", e);
    alert("Claim failed: " + (e?.data?.message || e?.message || e));
  }
}

// withdraw
document.getElementById("withdrawBtn").addEventListener("click", withdraw);
async function withdraw() {
  try {
    if (!stakingContract || !signer) { alert("Connect wallet first!"); return; }
    const amtStr = document.getElementById("withdrawAmount").value;
    if (!amtStr || Number(amtStr) <= 0) { alert("Enter withdraw amount"); return; }
    const amt = Number(amtStr);
    if (amt < 10 || amt % 10 !== 0) { alert("Minimum withdraw 10 USDT (multiples of 10)"); return; }
    const units = ethers.utils.parseUnits(amt.toString(), TOKEN_DECIMALS);

    // Optimistic UI: reduce total wallet immediately for better UX
    try {
      const totalWalletEl = document.getElementById("totalWallet");
      const current = parseFloat(totalWalletEl.innerText.split(" ")[0]) || 0;
      const newVal = Math.max(0, current - amt);
      totalWalletEl.innerText = toFixedNumber(newVal, 6) + " USDT";
      document.getElementById("withdrawStatus").innerText = "‚è≥ Sending withdraw request...";
    } catch (e) { /* ignore UI fallback */ }

    const tx = await stakingContract.requestWithdraw(units);
    await tx.wait();
    document.getElementById("withdrawStatus").innerText = "‚úÖ Withdraw request submitted successfully!";
    await refreshAll();
  } catch (e) {
    console.error("Withdraw error:", e);
    alert("Withdraw failed: " + (e?.data?.message || e?.message || e));
  }
}

/* ==================== QUICK APPROVE ==================== */
document.getElementById("quickApproveBtn").addEventListener("click", async () => {
  try {
    if (!tokenContract || !signer) { alert("Connect wallet first"); return; }
    const approveUnits = ethers.utils.parseUnits("1000000", TOKEN_DECIMALS);
    const btn = document.getElementById("quickApproveBtn");
    btn.innerText = "Approving...";
    btn.disabled = true;
    const tx = await tokenContract.approve(STAKING_ADDRESS, approveUnits);
    await tx.wait();
    btn.innerText = "Approved ‚úÖ";
    setTimeout(() => { btn.innerText = "Quick Approve"; btn.disabled = false; }, 1500);
    await refreshAll();
  } catch (err) {
    console.error("Approve error:", err);
    alert("Approve failed: " + (err?.data?.message || err?.message || err));
    const btn = document.getElementById("quickApproveBtn");
    btn.innerText = "Quick Approve";
    btn.disabled = false;
  }
});

/* ==================== EVENTS LISTENER (on-chain events -> refresh) ==================== */
function listenEvents() {
  try {
    if (!stakingContract) return;

    stakingContract.removeAllListeners && stakingContract.removeAllListeners();

    stakingContract.on("Deposit", (user, amount, referrer, event) => {
      console.log("Deposit event", user, amount.toString(), referrer);
      if (account && user.toLowerCase() === account.toLowerCase()) alert("‚úÖ Deposit processed for you");
      refreshAll();
    });

    stakingContract.on("ReferralCredited", (referrer, from, amountUnits, event) => {
      console.log("ReferralCredited", referrer, from, amountUnits.toString());
      if (account && referrer.toLowerCase() === account.toLowerCase()) {
        alert("üî• You got Instant Referral Income!");
      }
      refreshAll();
    });

    stakingContract.on("LevelCredited", (levelUser, from, level, amountUnits, event) => {
      console.log("LevelCredited", levelUser, from, level.toString(), amountUnits.toString());
      if (account && levelUser.toLowerCase() === account.toLowerCase()) {
        alert(`üéâ Level ${level.toString()} Income Received`);
      }
      refreshAll();
    });

    stakingContract.on("WithdrawRequested", (id, user, amountUnits, event) => {
      console.log("WithdrawRequested", id.toString(), user, amountUnits.toString());
      if (account && user.toLowerCase() === account.toLowerCase()) {
        alert("üïí Withdraw Requested (awaiting approval)");
      }
      refreshAll();
    });

    stakingContract.on("WithdrawApproved", (id, user, amountUnitsAfterFee, event) => {
      console.log("WithdrawApproved", id.toString(), user, amountUnitsAfterFee.toString());
      if (account && user.toLowerCase() === account.toLowerCase()) {
        alert("üí∏ Withdraw Approved (received funds after fee)");
      }
      refreshAll();
    });

    stakingContract.on("Claim", (user, rewardUnits, event) => {
      console.log("Claim", user, rewardUnits.toString());
      if (account && user.toLowerCase() === account.toLowerCase()) {
        alert("‚úÖ ROI Claimed & Credited internally");
      }
      refreshAll();
    });

  } catch (e) {
    console.warn("listenEvents error", e);
  }
}

/* ==================== WITHDRAW HISTORY (table) ==================== */
async function loadWithdrawHistory() {
  if (!stakingContract || !account) return;
  try {
    const countBn = await stakingContract.withdrawRequestsCount();
    const count = Number(countBn || 0);
    const tbody = document.getElementById("withdrawHistoryBody");
    tbody.innerHTML = "";

    // Show latest first
    for (let i = count; i >= 1 && i > count - 200; i--) {
      const req = await stakingContract.getWithdrawRequest(i);
      if (!req || !req.user) continue;
      if (req.user && req.user.toLowerCase() !== account.toLowerCase()) continue;
      const amt = fromUnits(req.amount || 0);
      const status = (req.status === 0) ? "Pending" : (req.status === 1) ? "Approved" : "Rejected";
      const time = new Date(Number(req.timestamp || 0) * 1000).toLocaleString();
      const row = `<tr><td>#${i}</td><td>${toFixedNumber(amt,6)}</td><td>${status}</td><td>${time}</td></tr>`;
      tbody.innerHTML += row;
    }

    if (!tbody.innerHTML) tbody.innerHTML = '<tr><td colspan="4" class="center sm">No withdrawals yet.</td></tr>';
  } catch (e) { console.warn("loadWithdrawHistory error", e); }
}

/* ==================== TEAM TABLES ==================== */
async function loadTeamInfo() {
  if (!stakingContract || !account) return;
  try {
    // Directs
    const directs = await stakingContract.getDirectRefs(account);
    const directBody = document.getElementById("directTeamBody");
    directBody.innerHTML = "";
    if (!directs || directs.length === 0) {
      directBody.innerHTML = '<tr><td colspan="3" class="center sm">No directs yet.</td></tr>';
    } else {
      const infos = await Promise.all(directs.map(a => stakingContract.getUserInfo(a).catch(() => null)));
      for (let i = 0; i < directs.length; i++) {
        const addr = directs[i];
        if (!ethers.utils.isAddress(addr)) continue;
        const info = infos[i];
        const st = info ? fromUnits(info.staked || 0) : 0;
        const status = st > 0 ? "Active" : "Inactive";
        directBody.innerHTML += `<tr><td class="sm">${addr}</td><td>${toFixedNumber(st, 2)} USDT</td><td>${status}</td></tr>`;
      }
    }

    // Indirects (one level deep)
    const indirects = [];
    if (directs && directs.length > 0) {
      const subsArrays = await Promise.all(directs.map(d => stakingContract.getDirectRefs(d).catch(() => [])));
      for (const arr of subsArrays) if (arr && arr.length) indirects.push(...arr);
    }

    const indirectBody = document.getElementById("indirectTeamBody");
    indirectBody.innerHTML = "";
    if (!indirects || indirects.length === 0) {
      indirectBody.innerHTML = '<tr><td colspan="3" class="center sm">No indirects yet.</td></tr>';
    } else {
      const infos = await Promise.all(indirects.map(a => stakingContract.getUserInfo(a).catch(() => null)));
      for (let i = 0; i < indirects.length; i++) {
        const addr = indirects[i];
        if (!ethers.utils.isAddress(addr)) continue;
        const info = infos[i];
        const st = info ? fromUnits(info.staked || 0) : 0;
        const status = st > 0 ? "Active" : "Inactive";
        indirectBody.innerHTML += `<tr><td class="sm">${addr}</td><td>${toFixedNumber(st, 2)} USDT</td><td>${status}</td></tr>`;
      }
    }

    // update counts
    document.getElementById("directCount").innerText = directs.length.toString();
    document.getElementById("indirectCount").innerText = indirects.length.toString();

    let active = 0, inactive = 0;
    if (directs.length > 0) {
      const infos = await Promise.all(directs.map(a => stakingContract.getUserInfo(a).catch(()=>null)));
      for (const info of infos) {
        const st = info ? fromUnits(info.staked || 0) : 0;
        if (st > 0) active++; else inactive++;
      }
    }
    document.getElementById("activeCounts").innerText = `${active} / ${inactive}`;

  } catch (e) {
    console.error("loadTeamInfo error", e);
  }
}

/* ==================== UI ACTIONS & Utilities ==================== */
document.getElementById("copyRefBtn").addEventListener("click", async () => {
  if (!account) { alert("Connect wallet first"); return; }
  await navigator.clipboard.writeText(document.getElementById("referralInput").value);
  alert("Referral link copied!");
});

document.getElementById("refreshBtn").addEventListener("click", refreshAll);

/* END */
console.log("Dashboard script loaded. Connect wallet to begin.");
</script>
</body>
</html>

