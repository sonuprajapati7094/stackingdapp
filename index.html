<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>USDT Staking Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <style>
    /* Minimal dark theme styled to match the screenshot */
    :root{
      --bg:#071014; --card:#0e1416; --muted:#9aa3a6; --accent:#f6c84c; --glass: rgba(255,255,255,0.03);
    }
    body{background:var(--bg);color:#fff;font-family:Inter,system-ui,Arial;padding:18px}
    .wrap{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    h1{color:var(--accent);margin:0}
    .btn{background:var(--accent);color:#000;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .card{background:var(--card);padding:16px;border-radius:10px;margin-bottom:12px;box-shadow: 0 6px 18px rgba(0,0,0,0.6)}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:16px}
    input,select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:#fff;width:100%}
    .row{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .stat{background:#071617;padding:12px;border-radius:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>USDT Staking — Dashboard</h1>
      <div class="row">
        <div id="statusText" class="small muted">Not connected</div>
        <button id="connectBtn" class="btn">Connect</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Controls -->
      <div>
        <div class="card">
          <h3>Stake USDT</h3>
          <div class="small">Minimum deposit 20 USDT</div>
          <div style="margin-top:10px">
            <input id="stakeAmt" placeholder="amount (eg. 20)" />
            <div style="margin-top:8px" class="row">
              <button id="approveBtn" class="btn">Quick Approve</button>
              <button id="stakeBtn" class="btn">Stake Now</button>
            </div>
            <div class="small" style="margin-top:8px">Tip: Approve once, then stake.</div>
          </div>
        </div>

        <div class="card">
          <h3>Your Referral Link</h3>
          <input id="refLink" readonly />
          <div style="margin-top:8px" class="row">
            <button id="copyLink" class="btn">Copy Link</button>
            <button id="showTeam" class="btn">Show Team</button>
          </div>
          <div class="small" style="margin-top:8px">
            Share this link — users who join via this link will credit you 10% instant on their deposit.
          </div>
        </div>

        <div class="card">
          <h3>Withdraw</h3>
          <div class="small">Minimum withdraw 20 USDT. Withdrawals require admin approval.</div>
          <input id="withdrawAmt" placeholder="amount (eg. 20)"/>
          <div style="margin-top:8px" class="row">
            <button id="requestWithdraw" class="btn">Request Withdraw</button>
          </div>
          <div id="withdrawStatus" class="small muted" style="margin-top:8px">No withdraw actions yet.</div>
        </div>
      </div>

      <!-- RIGHT: Dashboard -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div id="addrDisplay" class="small muted">Address: -</div>
              <div id="balanceDisplay" style="font-weight:600">USDT Balance: -</div>
            </div>
            <div>
              <button id="refreshBtn" class="btn">Refresh Now</button>
            </div>
          </div>

          <div style="margin-top:12px" class="stat-grid">
            <div class="stat">
              <div class="small muted">Instant Income</div>
              <div id="instantIncome">0.000000</div>
            </div>
            <div class="stat">
              <div class="small muted">Level Income</div>
              <div id="levelIncome">0.000000</div>
            </div>
            <div class="stat">
              <div class="small muted">ROI Pending</div>
              <div id="roiIncome">0.000000</div>
            </div>
          </div>

          <div style="margin-top:12px" class="stat-grid">
            <div class="stat">
              <div class="small muted">Total Wallet</div>
              <div id="totalWallet">0.000000</div>
            </div>
            <div class="stat">
              <div class="small muted">Team Business</div>
              <div id="teamBusiness">0.000000</div>
            </div>
            <div class="stat">
              <div class="small muted">Days to 3x</div>
              <div id="days3x">-</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Staking Info</h3>
          <table>
            <tr><th>Metric</th><th>Value</th></tr>
            <tr><td>Staked</td><td id="staked">0</td></tr>
            <tr><td>Target (3x)</td><td id="target3x">0</td></tr>
            <tr><td>Days to 3x</td><td id="days3x2">-</td></tr>
            <tr><td>Package Status</td><td id="pkgStatus">—</td></tr>
          </table>
        </div>

        <div class="card">
          <h3>Team & Levels</h3>
          <div class="row" style="justify-content:space-between">
            <div><b>Directs</b> <span id="directCount">0</span></div>
            <div><b>Indirect</b> <span id="indirectCount">0</span></div>
            <div><b>Active/Inactive</b> <span id="activeCount">0 / 0</span></div>
          </div>
          <div style="margin-top:10px">
            <table id="directsTable">
              <thead><tr><th>Address</th><th>Stake</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Disclaimer</h3>
          <div class="small muted">
            All investments are at user's own risk. The team/project is not responsible for any financial loss. By staking you agree to these terms.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  Frontend for USDTMLMStaking (ethers.js v5)
  - Update CONTRACT addresses below
  - Designed for BEP20 testnet + USDT decimals = 6
*/

const CONFIG = {
  tokenAddress: "0x1a904b37B0d9D6ab755aBDa4656E42F278FC89AA",
  stakingAddress: "0xE65396C1B8c63167A86d374ec7aD8F1471CC1F2f",
  decimals: 6,
  chainId: 97 // BSC Testnet chainId
}

// Minimal ABI — necessary functions used by UI
const STAKING_ABI = [
  "function register(address referrer) external",
  "function stake(uint256 amount, address referrer) external",
  "function stakeFor(address refUser, uint256 amount, address refForRefUser) external",
  "function updateRewards(address userAddr) external",
  "function getUserInfo(address userAddr) external view returns (uint256 totalStake,uint256 roiIncome,uint256 instantIncome,uint256 levelIncome,uint256 totalEarned,uint256 totalWithdrawn_,bool isActive,uint256 directsCount)",
  "function getWithdrawable(address userAddr) external view returns (uint256)",
  "function getTimeTo3x(address userAddr) external view returns (uint256)",
  "function getDirects(address userAddr) external view returns (address[])",
  "function requestWithdrawal(uint256 amount) external",
  "function getWithdrawal(uint256 wid) external view returns (address user,uint256 amount,bool approved,uint256 timestamp)",
  "function owner() external view returns (address)",
  // admin functions (for admin page)
  "function approveWithdrawal(uint256 id) external",
  "function pauseUser(address userAddr) external",
  "function unpauseUser(address userAddr) external"
];

const TOKEN_ABI = [
  "function approve(address spender,uint256 amount) external returns(bool)",
  "function allowance(address owner,address spender) external view returns(uint256)",
  "function balanceOf(address owner) external view returns(uint256)",
  "function decimals() external view returns(uint8)"
];

let provider, signer, userAddress;
let stakingContract, tokenContract;

async function connect() {
  if (!window.ethereum) return alert("Install MetaMask");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  const network = await provider.getNetwork();
  // optional: check chainId
  if (network.chainId !== CONFIG.chainId) {
    // just warn — let user change
    console.warn("Connected chainId", network.chainId, "expected", CONFIG.chainId);
  }
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  document.getElementById('statusText').innerText = "Connected";
  document.getElementById('addrDisplay').innerText = `Address: ${userAddress}`;
  stakingContract = new ethers.Contract(CONFIG.stakingAddress, STAKING_ABI, signer);
  tokenContract = new ethers.Contract(CONFIG.tokenAddress, TOKEN_ABI, signer);
  // set referral link
  const url = new URL(window.location.href);
  const refParam = url.searchParams.get('ref');
  const refLinkInput = document.getElementById('refLink');
  const myRef = `${window.location.origin + window.location.pathname}?ref=${userAddress}`;
  refLinkInput.value = myRef;
  // elements
  document.getElementById('connectBtn').innerText = "Connected ✓";
  await refreshAll();
}

// -------- helpers
function toUnits(amount) {
  return ethers.utils.parseUnits(String(amount), CONFIG.decimals);
}
function fromUnits(big) {
  try { return Number(ethers.utils.formatUnits(big, CONFIG.decimals)); } catch(e){ return 0 }
}

// -------- UI actions
document.getElementById('connectBtn').onclick = connect;
document.getElementById('refreshBtn').onclick = refreshAll;

document.getElementById('approveBtn').onclick = async () => {
  const amt = toUnits("1000000"); // large approve
  await tokenContract.approve(CONFIG.stakingAddress, amt);
  alert("Approved (large)");
};

document.getElementById('stakeBtn').onclick = async () => {
  const v = document.getElementById('stakeAmt').value;
  if (!v || Number(v) < 20) return alert("Enter >= 20 USDT");
  const url = new URL(window.location.href);
  const refParam = url.searchParams.get('ref');
  // use ref param if present else empty (owner can stake without ref)
  const refAddr = refParam || ethers.constants.AddressZero;
  const amt = toUnits(v);
  try {
    const tx = await stakingContract.stake(amt, refAddr);
    await tx.wait();
    alert("Staked!");
    await refreshAll();
  } catch (e) {
    console.error(e); alert("Stake failed: " + (e?.data?.message || e?.message || e));
  }
};

document.getElementById('copyLink').onclick = () => {
  const v = document.getElementById('refLink').value;
  navigator.clipboard.writeText(v);
  alert("Copied link");
};

document.getElementById('showTeam').onclick = async () => {
  await showTeam();
};

document.getElementById('requestWithdraw').onclick = async () => {
  const v = document.getElementById('withdrawAmt').value;
  if (!v || Number(v) < 20) return alert("Min withdraw 20 USDT");
  const amt = toUnits(v);
  try {
    const tx = await stakingContract.requestWithdrawal(amt);
    await tx.wait();
    alert("Withdrawal requested (pending admin approval)");
  } catch (e) {
    console.error(e); alert("Request failed: " + (e?.data?.message || e?.message || e));
  }
};

// -------- core refresh
async function refreshAll() {
  if (!signer) return;
  // update token balance
  try {
    const bal = await tokenContract.balanceOf(userAddress);
    document.getElementById('balanceDisplay').innerText = `USDT Balance: ${fromUnits(bal).toFixed(6)} USDT`;
  } catch(e){ console.error(e) }

  // call updateRewards for current user (so ROI accrues on-chain)
  try { await stakingContract.updateRewards(userAddress); } catch(e){ /* ignore */ }

  // fetch user info
  try {
    const info = await stakingContract.getUserInfo(userAddress);
    // returns tuple: totalStake, roiIncome, instantIncome, levelIncome, totalEarned, totalWithdrawn, isActive, directsCount
    const staked = fromUnits(info[0]);
    const roiIncome = fromUnits(info[1]);
    const instantIncome = fromUnits(info[2]);
    const levelIncome = fromUnits(info[3]);
    const totalEarned = fromUnits(info[4]);
    const totalWithdrawn = fromUnits(info[5]);
    const isActive = info[6];
    const directsCount = Number(info[7] || 0);

    document.getElementById('staked').innerText = staked.toFixed(6) + " USDT";
    document.getElementById('pkgStatus').innerText = isActive ? "Active" : "Inactive";
    document.getElementById('instantIncome').innerText = instantIncome.toFixed(6) + " USDT";
    document.getElementById('levelIncome').innerText = levelIncome.toFixed(6) + " USDT";
    document.getElementById('roiIncome').innerText = roiIncome.toFixed(6) + " USDT";

    const withdrawable = await stakingContract.getWithdrawable(userAddress);
    document.getElementById('totalWallet').innerText = fromUnits(withdrawable).toFixed(6) + " USDT";

    // time to 3x
    const days = await stakingContract.getTimeTo3x(userAddress);
    document.getElementById('days3x').innerText = String(Number(days));
    document.getElementById('days3x2').innerText = String(Number(days));

    // target 3x
    document.getElementById('target3x').innerText = (staked * 3).toFixed(6) + " USDT";
    // directs
    document.getElementById('directCount').innerText = directsCount;
    // simple active/inactive count: check direct addresses
    await loadDirects(userAddress);
  } catch (e) {
    console.error(e);
  }
}

// fetch directs and build small table and team business (simple)
async function loadDirects(addr) {
  try {
    const directs = await stakingContract.getDirects(addr);
    const tbody = document.querySelector('#directsTable tbody');
    tbody.innerHTML = "";
    let teamBusiness = 0;
    let active = 0, inactive = 0;
    for (let d of directs) {
      // get user info for each direct
      const info = await stakingContract.getUserInfo(d);
      const st = fromUnits(info[0]);
      const isActive = info[6];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d}</td><td>${st.toFixed(6)} USDT</td>`;
      tbody.appendChild(tr);
      teamBusiness += st;
      if (isActive) active++; else inactive++;
    }
    document.getElementById('teamBusiness').innerText = teamBusiness.toFixed(6) + " USDT";
    document.getElementById('indirectCount').innerText = "—";
    document.getElementById('activeCount').innerText = `${active} / ${inactive}`;
  } catch(e){ console.error(e) }
}

async function showTeam() {
  const directs = await stakingContract.getDirects(userAddress);
  let msg = "Direct referrals:\n";
  for (let d of directs) msg += `${d}\n`;
  alert(msg || "No directs");
}

// auto-connect if already connected
if (window.ethereum && window.ethereum.selectedAddress) {
  // do nothing — wait for user click
}

// track query param ref: if page opened with ?ref=0x..., we store it in localStorage for stake usage
(function storeRefFromUrl(){
  const url = new URL(window.location.href);
  const r = url.searchParams.get('ref');
  if (r) localStorage.setItem('ref', r);
})();

</script>
</body>
</html>
