<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>USDT Staking â€” Final Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <style>
    body{background:#0c0c0f;color:#fff;font-family:Inter,system-ui,Arial;margin:0;padding:30px;display:flex;flex-direction:column;align-items:center}
    h1{margin:0 0 20px;font-size:28px}
    .card{background:#18181b;padding:22px;border-radius:12px;margin:14px 0;box-shadow:0 6px 20px rgba(0,0,0,0.45);width:420px;max-width:95%}
    button{cursor:pointer;border:0;padding:10px 16px;border-radius:8px;font-weight:600}
    .btn-yellow{background:#ffc629;color:#111}
    .btn-dark{background:#2a2a2e;color:#fff}
    .btn-red{background:#e23e3e;color:#fff}
    input{padding:12px;border-radius:8px;border:0;background:#2a2a2e;color:#fff;width:200px}
    .center{text-align:center}
    .muted{color:#aaa;font-size:14px}
  </style>
</head>
<body>
  <h1>ðŸ’« USDT Staking â€” Final Dashboard</h1>
  <div class="muted" id="walletText">Wallet: not connected</div>
  <div style="margin:16px"><button id="connectBtn" class="btn-yellow">Connect Wallet</button></div>

  <div class="card center">
    <h3>Approve & Stake</h3>
    <input id="amountInput" placeholder="Amount (USDT)" />
    <div style="margin-top:12px">
      <button class="btn-dark" id="approveBtn">Approve</button>
      <button class="btn-yellow" id="depositBtn">Deposit</button>
    </div>
  </div>

  <div class="card center">
    <h3>Rewards</h3>
    <button class="btn-dark" id="pendingBtn">Check Pending Rewards</button>
    <div id="rewardsText" class="muted" style="margin:10px">Rewards: 0 USDT</div>
    <button class="btn-yellow" id="claimBtn">Claim Rewards</button>
  </div>

  <div class="card center">
    <h3>Withdraw</h3>
    <input id="withdrawInput" placeholder="Amount (USDT)" />
    <div style="margin-top:12px">
      <button class="btn-red" id="withdrawBtn">Withdraw</button>
    </div>
  </div>

  <div class="card center">
    <h3>ðŸ“Š Staking Info</h3>
    <button class="btn-dark" id="stakedBtn">Check Staked Balance</button>
    <div id="stakedInfo" class="muted" style="margin-top:14px">-</div>
  </div>

<script>
(async function(){
  // ==== Contract Addresses (update only if redeployed) ====
  const STAKING_ADDRESS = "0x20Fbd4AF3cB507e702C7C513F08D7857bAc74407";
  const TOKEN_ADDRESS   = "0xEbA5032Be8fc2d2a2fa29e134853ab6aAA12fa1C";

  // ==== ABIs ====
  const tokenAbi = [
    "function decimals() view returns (uint8)",
    "function approve(address,uint256) returns (bool)",
    "function allowance(address,address) view returns (uint256)"
  ];
  const stakingAbi = [
    "function deposit(uint256,address)",
    "function claimRewards()",
    "function withdrawPrincipal(uint256)",
    "function pendingRewards(address) view returns (uint256)",
    "function getUserInfo(address) view returns (uint256,uint256,address,uint256,uint256)"
  ];

  // ==== Elements ====
  const connectBtn = document.getElementById("connectBtn");
  const walletText = document.getElementById("walletText");
  const amountInput = document.getElementById("amountInput");
  const approveBtn = document.getElementById("approveBtn");
  const depositBtn = document.getElementById("depositBtn");
  const pendingBtn = document.getElementById("pendingBtn");
  const rewardsText = document.getElementById("rewardsText");
  const claimBtn = document.getElementById("claimBtn");
  const withdrawInput = document.getElementById("withdrawInput");
  const withdrawBtn = document.getElementById("withdrawBtn");
  const stakedBtn = document.getElementById("stakedBtn");
  const stakedInfo = document.getElementById("stakedInfo");

  // ==== State ====
  let provider, signer, userAddress, token, staking, decimals=6;

  function fmt(bn){ return ethers.utils.formatUnits(bn, decimals); }
  function toUnits(v){ return ethers.utils.parseUnits(v, decimals); }

  async function connect(){
    try{
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts",[]);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      walletText.textContent = "Wallet: " + userAddress;
      connectBtn.textContent = "Connected";

      token = new ethers.Contract(TOKEN_ADDRESS, tokenAbi, signer);
      staking = new ethers.Contract(STAKING_ADDRESS, stakingAbi, signer);
      decimals = await token.decimals();
    }catch(e){ alert("Wallet connect failed: " + e.message); }
  }
  connectBtn.onclick = connect;

  approveBtn.onclick = async ()=>{
    try{
      const amt = toUnits(amountInput.value||"0");
      const tx = await token.approve(STAKING_ADDRESS, amt);
      await tx.wait();
      alert("Approved!");
    }catch(e){ alert("Approve failed: " + e.message); }
  };

  depositBtn.onclick = async ()=>{
    try{
      const amt = toUnits(amountInput.value||"0");
      const tx = await staking.deposit(amt, ethers.constants.AddressZero);
      await tx.wait();
      alert("Deposit success!");
    }catch(e){ alert("Deposit failed: " + e.message); }
  };

  pendingBtn.onclick = async ()=>{
    try{
      const val = await staking.pendingRewards(userAddress);
      rewardsText.textContent = "Rewards: " + fmt(val) + " USDT";
    }catch(e){ alert("Pending error: " + e.message); }
  };

  claimBtn.onclick = async ()=>{
    try{ const tx = await staking.claimRewards(); await tx.wait(); alert("Rewards claimed!"); }
    catch(e){ alert("Claim failed: " + e.message); }
  };

  withdrawBtn.onclick = async ()=>{
    try{
      const amt = toUnits(withdrawInput.value||"0");
      const tx = await staking.withdrawPrincipal(amt);
      await tx.wait();
      alert("Withdraw success!");
    }catch(e){ alert("Withdraw failed: " + e.message); }
  };

  stakedBtn.onclick = async ()=>{
    try{
      const info = await staking.getUserInfo(userAddress);
      const staked = fmt(info[0]);
      const earned = fmt(info[3]);
      const pending = fmt(info[4]);
      stakedInfo.innerHTML = `
        <div>Staked: <b>${staked} USDT</b></div>
        <div>Total Earned: <b>${earned} USDT</b></div>
        <div>Pending: <b>${pending} USDT</b></div>
      `;
    }catch(e){ alert("Staked info error: " + e.message); }
  };
})();
</script>
</body>
</html>
