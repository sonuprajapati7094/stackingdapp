<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USDT Staking Dashboard</title>

  <!-- ethers v5 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root {
      --bg: #0b0d0f;
      --card: #121416;
      --muted: #9aa4b2;
      --accent: #ffd86b;
      --panel: #0f1113;
    }
    body { margin:0; font-family: Inter, Arial, sans-serif; background:var(--bg); color:#e6eef6; }
    header { padding:18px 24px; text-align:center; background:linear-gradient(90deg,#081018, #0d1016); box-shadow:0 2px 8px rgba(0,0,0,0.5); }
    header h1 { margin:0; color:var(--accent); font-size:20px; letter-spacing:0.6px; }
    .topbar { display:flex; justify-content:flex-end; gap:12px; padding:12px 24px; align-items:center; }
    .wallet-btn { background:var(--accent); color:#000; padding:8px 14px; border-radius:8px; border:0; font-weight:600; cursor:pointer; }
    .container { padding: 20px; display:grid; grid-template-columns: 360px 1fr; gap:18px; max-width:1180px; margin:18px auto; }
    .left { display:flex; flex-direction:column; gap:14px; }
    .card { background:var(--card); border-radius:12px; padding:14px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
    .card h2 { margin:0 0 10px 0; color:var(--accent); font-size:16px; }
    .muted { color:var(--muted); font-size:13px; }
    input[type="number"], input[type="text"] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:var(--panel); color:#fff; }
    .small-btn { padding:10px 12px; border-radius:8px; border:0; background:#2a2f35; color:#fff; cursor:pointer; margin-top:8px; }
    .accent-btn { background:var(--accent); color:#000; border:0; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:700; margin-top:8px; }
    .right { display:flex; flex-direction:column; gap:14px; }
    .grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
    .value { font-size:18px; font-weight:700; color:#fff; }
    .label { font-size:12px; color:var(--muted); margin-top:6px; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
    th,td { padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.03); text-align:left; }
    th { color:var(--accent); font-weight:700; background:transparent; }
    .center { text-align:center; }
    .sm { font-size:12px; color:var(--muted); }
    footer { padding:14px; text-align:center; color:var(--muted); font-size:12px; }
    @media(max-width:980px) {
      .container { grid-template-columns: 1fr; padding:12px; }
      .grid-4 { grid-template-columns: repeat(2,1fr); }
    }
  </style>
</head>
<body>
  <header><h1>USDT Staking — Dashboard</h1></header>
  <div class="topbar" style="max-width:1180px;margin:0 auto">
    <div id="walletDisplay" class="sm muted">Not connected</div>
    <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
  </div>

  <main class="container">

    <!-- LEFT -->
    <div class="left">
      <div class="card">
        <h2>Stake USDT</h2>
        <input id="stakeAmount" type="number" placeholder="20, 40, 60 ..." />
        <button class="accent-btn" id="quickApproveBtn">Quick Approve</button>
        <button class="accent-btn" id="stakeBtn">Stake Now</button>
      </div>

      <div class="card">
        <h2>Your Referral Link</h2>
        <input id="referralInput" type="text" readonly />
        <button class="small-btn" id="copyRefBtn">Copy Link</button>
      </div>

      <div class="card">
        <h2>Withdraw</h2>
        <input id="withdrawAmount" type="number" placeholder="10, 20, 30 ..." />
        <button class="accent-btn" id="withdrawBtn">Request Withdraw</button>
        <div id="withdrawStatus" class="sm" style="margin-top:8px;">No withdraw actions yet.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="card">
        <h2>Wallet Balances & Income</h2>
        <div class="grid-4">
          <div><div class="label">Instant Income</div><div class="value" id="instantIncome">0</div></div>
          <div><div class="label">Level Income</div><div class="value" id="levelIncome">0</div></div>
          <div><div class="label">ROI Pending</div><div class="value" id="roiPending">0</div></div>
          <div><div class="label">Total Wallet</div><div class="value" id="totalWallet">0</div></div>
        </div>
      </div>

      <div class="card">
        <h2>Staking Info</h2>
        <table>
          <tr><td>Staked</td><td id="stakedDisplay">0</td></tr>
          <tr><td>Target (3x)</td><td id="targetDisplay">0</td></tr>
          <tr><td>Days to 3x</td><td id="days3x">0</td></tr>
          <tr><td>Status</td><td id="pkgStatus">Inactive</td></tr>
        </table>
      </div>

      <div class="card">
        <h2>Team</h2>
        <h3>Direct Team</h3>
        <table><thead><tr><th>Wallet</th><th>Staked</th><th>Status</th></tr></thead>
        <tbody id="directTeamBody"><tr><td colspan="3" class="center sm">No directs yet.</td></tr></tbody></table>
        <h3>Indirect Team</h3>
        <table><thead><tr><th>Wallet</th><th>Staked</th><th>Status</th></tr></thead>
        <tbody id="indirectTeamBody"><tr><td colspan="3" class="center sm">No indirects yet.</td></tr></tbody></table>
      </div>

      <div class="card">
        <h2>Withdrawal History</h2>
        <table>
          <thead><tr><th>ID</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
          <tbody id="withdrawHistoryBody"><tr><td colspan="4" class="center sm">No withdrawals yet.</td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>Made with ❤️ — Testnet only</footer>

<script>
const STAKING_ADDRESS = "0x12488f70eb36059941b7b12DB97cB44Ac22e2998";
const TOKEN_ADDRESS   = "0xEbA5032Be8fc2d2a2fa29e134853ab6aAA12fa1C";
let TOKEN_DECIMALS = 6;

const STAKING_ABI = [
  {
    "inputs": [
      { "internalType": "address", "name": "_token", "type": "address" },
      { "internalType": "address", "name": "_owner", "type": "address" }
    ],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "rewardUnits", "type": "uint256" }
    ],
    "name": "Claim",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "amountUnits", "type": "uint256" },
      { "indexed": true, "internalType": "address", "name": "referrer", "type": "address" }
    ],
    "name": "Deposit",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
      { "indexed": true, "internalType": "address", "name": "to", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "level", "type": "uint256" },
      { "indexed": false, "internalType": "uint256", "name": "amountUnits", "type": "uint256" }
    ],
    "name": "ReferralPaid",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "uint256", "name": "id", "type": "uint256" },
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "amountUnitsAfterFee", "type": "uint256" }
    ],
    "name": "WithdrawApproved",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "uint256", "name": "id", "type": "uint256" },
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "amountUnits", "type": "uint256" }
    ],
    "name": "WithdrawRequested",
    "type": "event"
  },
  { "inputs": [{ "internalType": "uint256", "name": "reqId", "type": "uint256" }], "name": "approveWithdrawal", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "businessVolume", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "capX", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "claimRewards", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "amountUnits", "type": "uint256" }, { "internalType": "address", "name": "referrer", "type": "address" }], "name": "deposit", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "directCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "", "type": "address" }, { "internalType": "uint256", "name": "", "type": "uint256" }], "name": "directRefs", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "feeCollector", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "userAddr", "type": "address" }], "name": "getDirectRefs", "outputs": [{ "internalType": "address[]", "name": "", "type": "address[]" }], "stateMutability": "view", "type": "function" },
  {
    "inputs": [{ "internalType": "address", "name": "userAddr", "type": "address" }],
    "name": "getUserInfo",
    "outputs": [
      { "internalType": "uint256", "name": "staked", "type": "uint256" },
      { "internalType": "uint256", "name": "lastAction", "type": "uint256" },
      { "internalType": "address", "name": "referrer", "type": "address" },
      { "internalType": "uint256", "name": "totalEarned", "type": "uint256" },
      { "internalType": "uint256", "name": "pending", "type": "uint256" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{ "internalType": "uint256", "name": "id", "type": "uint256" }],
    "name": "getWithdrawRequest",
    "outputs": [
      { "internalType": "address", "name": "user", "type": "address" },
      { "internalType": "uint256", "name": "amount", "type": "uint256" },
      { "internalType": "uint256", "name": "timestamp", "type": "uint256" },
      { "internalType": "enum USDTStakingWithReferrals.WithdrawStatus", "name": "status", "type": "uint8" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "instantIncome", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "levelBP", "outputs": [{ "internalType": "uint16", "name": "", "type": "uint16" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "levelIncome", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "lockSeconds", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "minTx", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "userAddr", "type": "address" }], "name": "pendingRewards", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "amountUnits", "type": "uint256" }], "name": "requestWithdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [], "name": "roiBP", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "roiClaimed", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "fc", "type": "address" }], "name": "setFeeCollector", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  {
    "inputs": [
      { "internalType": "uint256", "name": "_roiBP", "type": "uint256" },
      { "internalType": "uint256", "name": "_lockSeconds", "type": "uint256" },
      { "internalType": "uint256", "name": "_minTx", "type": "uint256" },
      { "internalType": "uint256", "name": "_capX", "type": "uint256" }
    ],
    "name": "setParams",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  { "inputs": [], "name": "token", "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  {
    "inputs": [{ "internalType": "address", "name": "", "type": "address" }],
    "name": "users",
    "outputs": [
      { "internalType": "uint256", "name": "staked", "type": "uint256" },
      { "internalType": "uint256", "name": "lastAction", "type": "uint256" },
      { "internalType": "address", "name": "referrer", "type": "address" },
      { "internalType": "uint256", "name": "totalEarned", "type": "uint256" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
    "name": "withdrawRequests",
    "outputs": [
      { "internalType": "address", "name": "user", "type": "address" },
      { "internalType": "uint256", "name": "amount", "type": "uint256" },
      { "internalType": "uint256", "name": "timestamp", "type": "uint256" },
      { "internalType": "enum USDTStakingWithReferrals.WithdrawStatus", "name": "status", "type": "uint8" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  { "inputs": [], "name": "withdrawRequestsCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }
];

const TOKEN_ABI = [
 "function decimals() view returns (uint8)",
 "function balanceOf(address) view returns (uint256)",
 "function approve(address,uint256) returns (bool)"
];

let provider, signer, stakingContract, tokenContract, account=null;

function fromUnits(v){return Number(ethers.utils.formatUnits(v,TOKEN_DECIMALS));}
function toUnits(v){return ethers.utils.parseUnits(v.toString(),TOKEN_DECIMALS);}

async function connect(){
  provider=new ethers.providers.Web3Provider(window.ethereum,"any");
  await provider.send("eth_requestAccounts",[]);
  signer=provider.getSigner(); account=await signer.getAddress();
  stakingContract=new ethers.Contract(STAKING_ADDRESS,STAKING_ABI,signer);
  tokenContract=new ethers.Contract(TOKEN_ADDRESS,TOKEN_ABI,signer);
  TOKEN_DECIMALS=await tokenContract.decimals();
  document.getElementById("walletDisplay").innerText=account;
  document.getElementById("referralInput").value=location.origin+location.pathname+"?ref="+account;
  refreshAll();
}
document.getElementById("connectBtn").onclick=connect;

async function refreshAll(){
 if(!stakingContract||!account) return;
 const u=await stakingContract.getUserInfo(account);
 const st=fromUnits(u.staked), te=fromUnits(u.totalEarned), p=fromUnits(u.pending);
 document.getElementById("stakedDisplay").innerText=st;
 document.getElementById("targetDisplay").innerText=st*3;
 document.getElementById("pkgStatus").innerText=st>0?"Active":"Inactive";
 document.getElementById("roiPending").innerText=p;
 document.getElementById("instantIncome").innerText=fromUnits(await stakingContract.instantIncome(account));
 document.getElementById("levelIncome").innerText=fromUnits(await stakingContract.levelIncome(account));
 document.getElementById("totalWallet").innerText=(fromUnits(await stakingContract.instantIncome(account))+fromUnits(await stakingContract.levelIncome(account))+p).toFixed(2);
 await loadWithdrawHistory(); await loadTeamInfo();
}
async function loadWithdrawHistory(){
 const c=await stakingContract.withdrawRequestsCount();
 const tbody=document.getElementById("withdrawHistoryBody"); tbody.innerHTML="";
 for(let i=Number(c);i>0&&i>c-20;i--){
  const r=await stakingContract.getWithdrawRequest(i);
  if(r.user.toLowerCase()!=account.toLowerCase()) continue;
  const row=`<tr><td>${i}</td><td>${fromUnits(r.amount)}</td><td>${["Pending","Approved","Rejected"][r.status]}</td><td>${new Date(r.timestamp*1000).toLocaleString()}</td></tr>`;
  tbody.innerHTML+=row;
 }
 if(!tbody.innerHTML) tbody.innerHTML='<tr><td colspan="4" class="center sm">No withdrawals yet.</td></tr>';
}
async function loadTeamInfo(){
 const directs=await stakingContract.getDirectRefs(account);
 const db=document.getElementById("directTeamBody"); db.innerHTML="";
 if(directs.length==0){db.innerHTML='<tr><td colspan="3" class="center sm">No directs yet.</td></tr>';}
 for(let d of directs){const u=await stakingContract.getUserInfo(d);const st=fromUnits(u.staked);db.innerHTML+=`<tr><td>${d}</td><td>${st}</td><td>${st>0?"Active":"Inactive"}</td></tr>`;}
 const indirects=[];for(let d of directs){indirects.push(...await stakingContract.getDirectRefs(d));}
 const ib=document.getElementById("indirectTeamBody");ib.innerHTML="";
 if(indirects.length==0){ib.innerHTML='<tr><td colspan="3" class="center sm">No indirects yet.</td></tr>';}
 for(let d of indirects){const u=await stakingContract.getUserInfo(d);const st=fromUnits(u.staked);ib.innerHTML+=`<tr><td>${d}</td><td>${st}</td><td>${st>0?"Active":"Inactive"}</td></tr>`;}
}
document.getElementById("quickApproveBtn").onclick=async()=>{await tokenContract.approve(STAKING_ADDRESS,ethers.constants.MaxUint256).then(tx=>tx.wait());alert("Approved ✅");}
document.getElementById("stakeBtn").onclick=async()=>{const amt=Number(document.getElementById("stakeAmount").value);if(amt<20||amt%20!=0){alert("Min 20 multiple");return;}const ref=new URLSearchParams(location.search).get("ref")||await stakingContract.owner();await (await stakingContract.deposit(toUnits(amt),ref)).wait();alert("Staked ✅");refreshAll();}
document.getElementById("withdrawBtn").onclick=async()=>{const amt=Number(document.getElementById("withdrawAmount").value);if(amt<10||amt%10!=0){alert("Min 10 multiple");return;}await (await stakingContract.requestWithdraw(toUnits(amt))).wait();document.getElementById("withdrawStatus").innerText="Withdraw requested";refreshAll();}
document.getElementById("copyRefBtn").onclick=()=>{navigator.clipboard.writeText(document.getElementById("referralInput").value);alert("Copied ✅");}
</script>
</body>
</html>
