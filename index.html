<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Full Staking DApp ‚Äî Dashboard</title>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0d0f; --card:#0f1214; --muted:#9aa4b2; --accent:#ffd86b;
      --panel:#121416; --success:#00c176; --danger:#ff6b6b;
    }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#e6eef6;}
    header{padding:18px 24px;text-align:center;background:linear-gradient(90deg,#081018,#0d1016);box-shadow:0 2px 8px rgba(0,0,0,0.5);}
    header h1{margin:0;color:var(--accent);font-size:20px;}
    .topbar{display:flex;justify-content:flex-end;gap:12px;padding:12px 24px;align-items:center;max-width:1180px;margin:0 auto;}
    .wallet-btn{background:var(--accent);color:#000;padding:8px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer;}
    .container{padding:20px;display:grid;grid-template-columns:360px 1fr;gap:18px;max-width:1180px;margin:18px auto;}
    .left{display:flex;flex-direction:column;gap:14px;}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.4);}
    .card h2{margin:0 0 10px 0;color:var(--accent);font-size:16px;}
    .muted{color:var(--muted);font-size:13px;}
    input, textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:#fff;box-sizing:border-box;}
    .small-btn{padding:10px 12px;border-radius:8px;border:0;background:#2a2f35;color:#fff;cursor:pointer;margin-top:8px;}
    .accent-btn{background:var(--accent);color:#000;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;margin-top:8px;}
    .right{display:flex;flex-direction:column;gap:14px;}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .value{font-size:18px;font-weight:700;color:#fff;}
    .label{font-size:12px;color:var(--muted);margin-top:6px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;}
    th{color:var(--accent);font-weight:700;}
    .center{text-align:center;}
    footer{padding:14px;text-align:center;color:var(--muted);font-size:12px;}
    @media(max-width:980px){.container{grid-template-columns:1fr;padding:12px;}.grid-4{grid-template-columns:repeat(2,1fr);}}
    .pill{display:inline-block;padding:6px 10px;border-radius:16px;background:#222;color:#fff;font-weight:600;}
    #disclaimer {
  transition: all 0.3s ease;
}
#disclaimer:hover {
  background: rgba(255,255,255,0.05);
  transform: scale(1.01);
}
#disclaimer p {
  margin: 6px 0;
}
  </style>
</head>
<body>
<header><h1>USDT Staking ‚Äî Full DApp</h1></header>

<div class="topbar">
  <div id="walletDisplay" class="muted">Not connected</div>
  <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
</div>

<main class="container">

  <!-- LEFT: Actions -->
  <div class="left">

    <div class="card">
      <h2>Stake USDT</h2>
      <div class="muted">Min stake: <strong>20 USDT</strong> ‚Äî multiples of 20</div>
      <!-- main stake input -->
      <input id="stakeAmt" type="number" placeholder="Enter amount (20,40...)" />
      <div style="display:flex;gap:10px;margin-top:8px">
        <button id="approveBtn" class="small-btn">Quick Approve</button>
        <button id="stakeBtn" class="accent-btn">Stake Now</button>
      </div>
      <div id="stakeNote" class="muted" style="margin-top:8px">Tip: Approve once then stake.</div>
    </div>

    <div class="card">
      <h2>P2P Stake (Stake For)</h2>
      <div class="muted">Stake for another wallet ‚Äî no 5% fee (owner required as refForRefUser)</div>
      <input id="p2pAmount" type="number" placeholder="P2P amount (min 20)" />
      <input id="p2pAddress" type="text" placeholder="Recipient wallet address" style="margin-top:8px" />
      <button id="stakeForBtn" class="accent-btn" style="margin-top:10px">Stake For (P2P)</button>
    </div>

    <div class="card">
      <h2>Your Referral Link</h2>
      <input id="refLink" type="text" readonly placeholder="Connect wallet to generate link" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="copyLink" class="small-btn">Copy Referral Link</button>
        <button id="showTeam" class="small-btn">Show Team</button>
      </div>
      <div class="muted" style="margin-top:8px">Users who register via this link will credit you referral income.</div>
    </div>

    <div class="card">
      <h2>Withdraw</h2>
      <div class="muted">Minimum withdraw 20 USDT (admin approval applies)</div>
      <input id="withdrawAmt" type="number" placeholder="20, 40, 60 ..." />
      <button id="requestWithdraw" class="accent-btn" style="margin-top:8px">Request Withdraw</button>
      <div id="withdrawStatus" class="muted" style="margin-top:8px">No withdraw requests yet.</div>
    </div>

  </div>

  <!-- RIGHT: Dashboard -->
  <div class="right">

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h2>Wallet Balances & Income</h2><div class="muted">Instant / Level / ROI</div></div>
        <div><button id="refreshBtn" class="small-btn">Refresh</button></div>
      </div>

      <div style="margin-top:12px" class="grid-4">
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Instant Income</div>
          <div class="value" id="instantIncome">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Level income</div>
          <div class="value" id="levelIncome">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">ROI Pending</div>
          <div class="value" id="roiPending">0.000000 USDT</div>
        </div>
        <div class="card" style="background:#0b0d0f;padding:12px;">
          <div class="label">Total Wallet</div>
          <div class="value" id="totalWallet">0.000000 USDT</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Staking Info</h2>
      <table>
        <tr><td>Staked</td><td id="stakedDisplay">0.000000 USDT</td></tr>
        <tr><td>Target (3x)</td><td id="targetDisplay">0.000000 USDT</td></tr>
        <tr><td>Days to 3x</td><td id="days3x">0 days</td></tr>
        <tr><td>Package Status</td><td id="pkgStatus">Inactive</td></tr>
      </table>
    </div>
    <!-- ===== Progress Bar (3x Target) ===== -->
<div id="progressSection" style="margin-top: 15px;">
  <p style="margin-bottom: 6px; color: #ffcc00; font-weight: bold;">Progress to 3√ó Goal</p>
  <div style="width:100%; background:#333; border-radius:8px; height:10px; overflow:hidden;">
    <div id="progressFill" style="height:100%; width:0%; background:linear-gradient(90deg,#ffcc00,#00ff99); transition:width 1s;"></div>
  </div>
  <p id="progressLabel" style="margin-top:4px; font-size:13px; color:#aaa;">0% completed</p>
</div>


    <div class="card">
      <h2>Team & Levels</h2>
      <div style="display:flex; gap:12px; align-items:center;">
        <div style="flex:1"><div class="muted">Direct</div><div class="value" id="directCount">0</div></div>
        <div style="flex:1"><div class="muted">Indirect</div><div class="value" id="indirectCount">0</div></div>
        <div style="flex:2"><div class="muted">Active / Inactive</div><div class="value" id="activeCounts">0 / 0</div></div>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Level</th><th>Percent</th><th>Status</th></tr></thead>
          <tbody id="levelsTbody">
            <tr><td>L1</td><td>10%</td><td id="sL1">Pending</td></tr>
            <tr><td>L2</td><td>10%</td><td id="sL2">Pending</td></tr>
            <tr><td>L3</td><td>5%</td><td id="sL3">Pending</td></tr>
            <tr><td>L4</td><td>3%</td><td id="sL4">Pending</td></tr>
            <tr><td>L5</td><td>2%</td><td id="sL5">Pending</td></tr>
            <tr><td>L6</td><td>1%</td><td id="sL6">Pending</td></tr>
            <tr><td>L7</td><td>1%</td><td id="sL7">Pending</td></tr>
            <tr><td>L8</td><td>1%</td><td id="sL8">Pending</td></tr>
            <tr><td>L9</td><td>1%</td><td id="sL9">Pending</td></tr>
            <tr><td>L10</td><td>1%</td><td id="sL10">Pending</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</main>
<div class="card">
  <h3>Withdrawal History (Requests & Approved)</h3>
  <div class="history-table">
    <table id="withdrawHistory">
      <thead><tr><th>When</th><th>Amount</th><th>Approved</th><th>TX</th></tr></thead>
      <tbody id="withdrawHistoryBody"><tr><td colspan="4" class="center muted">No history yet.</td></tr></tbody>
    </table>
  </div>
</div>

<!-- üß© DISCLAIMER SECTION -->
<footer id="disclaimer" style="margin-top:60px;padding:25px 12px;text-align:center;background:rgba(255,255,255,0.03);border-top:1px solid rgba(255,255,255,0.07);font-size:14px;line-height:1.6;color:#bbb;backdrop-filter:blur(8px);">
  <div style="max-width:900px;margin:auto;">
    <h3 style="color:#fff;font-size:16px;margin-bottom:8px;">‚ö†Ô∏è Disclaimer</h3>
    <p>
      This decentralized application (DApp) operates entirely on blockchain smart contracts.
      The platform team does <strong>not control or guarantee</strong> returns, profits, or user funds.
      All staking, deposits, and withdrawals are processed automatically by the verified smart contract.
    </p>
    <p>
      Users are advised to <strong>do their own research (DYOR)</strong> before investing or interacting with any smart contract.
      Cryptocurrency investments are subject to market risk, smart contract vulnerabilities, and potential loss of funds.
    </p>
    <p style="margin-top:10px;">
      By using this DApp, you agree that you are participating voluntarily and take full responsibility for your decisions.
    </p>
    <div style="margin-top:14px;font-size:13px;color:#888;">
      &copy; <script>document.write(new Date().getFullYear());</script> USDT Staking dashboard. All rights reserved.
    </div>
  </div>
</footer>
<!-- üß© END DISCLAIMER -->

<footer>Made with ‚ù§Ô∏è ‚Äî Testnet only while testing</footer>

<!-- ========== JS: Full logic ========== -->
<script>
/* ======= CONFIG - REPLACE these addresses ======= */
const CONFIG = {
  tokenAddress: "0x1a904b37B0d9D6ab755aBDa4656E42F278FC89AA", // <-- replace with your token (USDT) address
  stakingAddress: "0xE65396C1B8c63167A86d374ec7aD8F1471CC1F2f", // <-- replace with your staking contract address
  decimals: 6
};

/* ======= ABIs ======= */
/* Use the staking ABI you shared (trimmed to necessary functions) */
const STAKING_ABI = [
  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"ref","type":"address"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"refUser","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"refForRefUser","type":"address"}],"name":"stakeFor","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amt","type":"uint256"}],"name":"requestWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"usr","type":"address"}],"name":"getTimeTo3x","outputs":[{"internalType":"uint256","name":"daysLeft","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[
    {"internalType":"address","name":"referrer","type":"address"},
    {"internalType":"uint256","name":"totalStake","type":"uint256"},
    {"internalType":"uint256","name":"totalWithdrawn","type":"uint256"},
    {"internalType":"uint256","name":"totalEarned","type":"uint256"},
    {"internalType":"uint256","name":"lastRoiUpdate","type":"uint256"},
    {"internalType":"uint256","name":"roiIncome","type":"uint256"},
    {"internalType":"uint256","name":"instantIncome","type":"uint256"},
    {"internalType":"uint256","name":"levelIncome","type":"uint256"},
    {"internalType":"bool","name":"isActive","type":"bool"},
    {"internalType":"bool","name":"isPaused","type":"bool"},
    {"internalType":"uint256","name":"inactiveAt","type":"uint256"}
  ],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"registered","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"ref","type":"address"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"Registered","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Staked","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"WithdrawalRequested","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"InstantCommissionPaid","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralCredited","type":"event"},
  // add any more events you want to listen to
];

const TOKEN_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];

/* ======= STATE ======= */
let provider, signer, account, stakingContract, tokenContract;

/* ======= HELPERS ======= */
function toFixedNumber(v, d = 6) { return Number(v).toLocaleString('en-US', {minimumFractionDigits:d,maximumFractionDigits:d}); }
function fromUnits(bn) { try { return Number(ethers.utils.formatUnits(bn, CONFIG.decimals)); } catch (e) { return 0; } }

/* ======= INIT & CONNECT ======= */
async function initProvider() {
  if (!window.ethereum) { alert("MetaMask not found. Install and refresh."); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  signer = provider.getSigner();
  account = await signer.getAddress();
  stakingContract = new ethers.Contract(CONFIG.stakingAddress, STAKING_ABI, signer);
  tokenContract = new ethers.Contract(CONFIG.tokenAddress, TOKEN_ABI, signer);

  document.getElementById("walletDisplay").innerText = `${account}`;
  // referral link
  const base = window.location.href.split("?")[0];
  document.getElementById("refLink").value = `${base}?ref=${account}`;

  // attach UI handlers that require contract
  attachUIHandlers();

  // listen contract events
  listenEvents();

  await refreshAll();
}

document.getElementById("connectBtn").addEventListener("click", async () => {
  try {
    await provider?.send ? provider.send("eth_requestAccounts", []) : window.ethereum.request({method:"eth_requestAccounts"});
    await initProvider();
  } catch (e) { try { await window.ethereum.request({method:"eth_requestAccounts"}); await initProvider(); } catch (err) { console.error(err); alert("Connect failed: " + (err.message || err)); } }
});

/* Auto reconnect on load if wallet already connected */
window.addEventListener("load", async () => {
  if (window.ethereum) {
    try {
      const tempProv = new ethers.providers.Web3Provider(window.ethereum, "any");
      const accs = await tempProv.listAccounts();
      if (accs && accs.length > 0) {
        provider = tempProv;
        signer = provider.getSigner();
        account = accs[0];
        stakingContract = new ethers.Contract(CONFIG.stakingAddress, STAKING_ABI, signer);
        tokenContract = new ethers.Contract(CONFIG.tokenAddress, TOKEN_ABI, signer);
        document.getElementById("walletDisplay").innerText = account;
        attachUIHandlers();
        listenEvents();
        await refreshAll();
      }
    } catch (e) { console.warn("Auto connect failed", e); }
  }
});

/* ======= UI HANDLERS (attach once contract exists) ======= */
function attachUIHandlers(){
  // quick approve
  document.getElementById("approveBtn").onclick = async () => {
    if (!tokenContract) return alert("Connect wallet first");
    try {
      const tx = await tokenContract.approve(CONFIG.stakingAddress, ethers.constants.MaxUint256);
      await tx.wait();
      alert("Approved ‚úî");
      await refreshAll();
    } catch (e) { console.error(e); alert("Approve failed: " + (e.message || e)); }
  };

  // stake
  document.getElementById("stakeBtn").onclick = async () => {
    try {
      if (!stakingContract) return alert("Connect wallet first");
      const amount = document.getElementById("stakeAmt").value;
      if (!amount || Number(amount) < 20) return alert("Minimum stake 20 USDT");
      // parse units
      const units = ethers.utils.parseUnits(String(amount), CONFIG.decimals);

      // auto-register if not registered
      const isReg = await stakingContract.registered(account).catch(()=>false);
      const refParam = new URLSearchParams(window.location.search).get("ref") || ethers.constants.AddressZero;
      if (!isReg) {
        // register with refParam (if invalid address, register with owner or zero)
        let refToUse = ethers.constants.AddressZero;
        if (refParam && ethers.utils.isAddress(refParam)) refToUse = refParam;
        try {
          // try to call register
          const txr = await stakingContract.register(refToUse);
          await txr.wait();
          console.log("Auto-registered with ref:", refToUse);
        } catch (regErr) {
          console.warn("Auto register failed:", regErr);
          // still attempt stake if contract accepts stake without register (some revert if required)
        }
      }

      // call stake(amount, ref)
      const tx = await stakingContract.stake(units, refParam || ethers.constants.AddressZero);
      await tx.wait();
      alert("Stake successful ‚úî");
      await refreshAll();
    } catch (e) {
      console.error("Stake failed:", e);
      const msg = e?.error?.message || e?.data?.message || e?.message || e;
      alert("Stake failed: " + String(msg).slice(0,300));
    }
  };

  // stakeFor (P2P)
  document.getElementById("stakeForBtn").onclick = async () => {
    try {
      if (!stakingContract) return alert("Connect wallet first");
      const amtStr = document.getElementById("p2pAmount").value;
      const addr = document.getElementById("p2pAddress").value;
      if (!amtStr || Number(amtStr) < 20) return alert("P2P min 20");
      if (!addr || !ethers.utils.isAddress(addr)) return alert("Enter valid wallet address");
      const units = ethers.utils.parseUnits(String(amtStr), CONFIG.decimals);
      // need owner as refForRefUser (per contract pattern)
      const owner = await stakingContract.owner();
      const tx = await stakingContract.stakeFor(addr, units, owner);
      await tx.wait();
      alert("P2P stake successful ‚úî");
      await refreshAll();
    } catch (e) {
      console.error("StakeFor failed:", e);
      alert("P2P stake failed: " + (e?.message || e));
    }
  };

  // withdraw
  document.getElementById("requestWithdraw").onclick = async () => {
    try {
      if (!stakingContract) return alert("Connect wallet first");
      const amt = document.getElementById("withdrawAmt").value;
      if (!amt || Number(amt) < 20) return alert("Min withdraw 20");
      const units = ethers.utils.parseUnits(String(amt), CONFIG.decimals);
      const tx = await stakingContract.requestWithdrawal(units);
      await tx.wait();
      document.getElementById("withdrawStatus").innerText = "Withdraw requested ‚úî";
      await refreshAll();
    } catch (e) {
      console.error("Withdraw failed:", e);
      alert("Withdraw failed: " + (e?.message || e));
    }
  };

  // copy referral
  document.getElementById("copyLink").onclick = async () => {
    const v = document.getElementById("refLink").value;
    if (!v) return alert("No link yet");
    await navigator.clipboard.writeText(v);
    alert("Referral link copied!");
  };

  // show team (simple refresh)
  document.getElementById("showTeam").onclick = async () => {
    await loadTeamInfo();
    alert("Team data refreshed (see UI)");
  };

  // refresh
  document.getElementById("refreshBtn").onclick = refreshAll;
}

/* ======= LISTEN CONTRACT EVENTS ======= */
function listenEvents(){
  if (!stakingContract) return;
  try {
    // remove old listeners
    stakingContract.removeAllListeners && stakingContract.removeAllListeners();

    stakingContract.on("Staked", (user, amount, event) => {
      console.log("Staked event:", user, amount.toString());
      if (user && account && user.toLowerCase() === account.toLowerCase()) {
        alert("‚úÖ Your stake processed");
      }
      refreshAll();
    });

    stakingContract.on("Registered", (user, ref, event) => {
      console.log("Registered:", user, ref);
      refreshAll();
    });

    stakingContract.on("ReferralCredited", (referrer, from, amount) => {
      console.log("ReferralCredited:", referrer, from, amount.toString());
      refreshAll();
    });

    stakingContract.on("InstantCommissionPaid", (from, to, amount) => {
      console.log("InstantCommissionPaid", from, to, amount.toString());
      refreshAll();
    });

    stakingContract.on("WithdrawalRequested", (id, user, amount) => {
      console.log("WithdrawalRequested:", id.toString(), user, amount.toString());
      refreshAll();
    });

  } catch (e) { console.warn("listenEvents error", e); }
}
// üß© Auto ROI update (before refresh)
async function updateROIIfNeeded() {
  try {
    if (!stakingContract || !account) return;

    const info = await stakingContract.users(account);
    const lastUpdate = Number(info.lastRoiUpdate || 0);
    const now = Math.floor(Date.now() / 1000);

    if (now - lastUpdate > 86400) { // 24 hours
      console.log("‚è≥ Auto ROI update triggered...");
      const tx = await stakingContract.stake(0, account);
      await tx.wait();
      console.log("‚úÖ ROI updated successfully");
    } else {
      console.log("ROI already updated recently ‚è≥");
    }
  } catch (err) {
    console.warn("‚ö†Ô∏è ROI auto-update failed:", err);
  }
  return;
}

/* ======= REFRESH ALL: populates UI ======= */
async function refreshAll() {
  if (!stakingContract || !account) return;
  await updateROIIfNeeded();
  try {
    // ü™ô Wallet token balance
    const rawBal = await tokenContract.balanceOf(account);
    const walletBal = fromUnits(rawBal);
    document.getElementById("walletDisplay").innerText = `${account} ‚Äî ${toFixedNumber(walletBal, 4)} USDT`;

    // üë§ User info (users mapping)
    const info = await stakingContract.users(account);
    // [referrer, totalStake(1), totalWithdrawn(2), totalEarned(3), lastRoiUpdate(4), roiIncome(5), instantIncome(6), levelIncome(7), isActive(8), isPaused(9), inactiveAt(10)]
    const staked = fromUnits(info[1] || 0);
    const totalEarned = fromUnits(info[3] || 0);
    const roiPending = fromUnits(info[5] || 0);
    const instantIncome = fromUnits(info[6] || 0);
    const levelIncome = fromUnits(info[7] || 0);
    const totalWallet = roiPending + instantIncome + levelIncome;

    // üßæ Update main UI fields
    document.getElementById("stakedDisplay").innerText = `${toFixedNumber(staked, 6)} USDT`;
    document.getElementById("targetDisplay").innerText = `${toFixedNumber(staked * 3, 6)} USDT`;
    document.getElementById("roiPending").innerText = `${toFixedNumber(roiPending, 6)} USDT`;
    document.getElementById("instantIncome").innerText = `${toFixedNumber(instantIncome, 6)} USDT`;
    document.getElementById("levelIncome").innerText = `${toFixedNumber(levelIncome, 6)} USDT`;
    document.getElementById("totalWallet").innerText = `${toFixedNumber(totalWallet, 6)} USDT`;

    document.getElementById("pkgStatus").innerText = info[8] ? "‚úÖ Active" : "Inactive";

    // üìÜ Days to 3x
    try {
      const daysBn = await stakingContract.getTimeTo3x(account);
      document.getElementById("days3x").innerText = (Number(daysBn) || 0) + " days";
    } catch (e) {
      document.getElementById("days3x").innerText = "N/A";
    }

    // üë• Direct & Indirect team
    let directCount = 0,
      indirectCount = 0,
      active = 0,
      inactive = 0,
      teamBusiness = 0;
    if (stakingContract.getDirectRefs) {
      const directs = await stakingContract.getDirectRefs(account).catch(() => []);
      directCount = directs.length;
      for (const d of directs) {
        const dInfo = await stakingContract.users(d).catch(() => null);
        const st = dInfo ? fromUnits(dInfo[1]) : 0;
        teamBusiness += st;
        if (st > 0) active++;
        else inactive++;
        const subs = await stakingContract.getDirectRefs(d).catch(() => []);
        indirectCount += subs.length;
        for (const s of subs) {
          const sInfo = await stakingContract.users(s).catch(() => null);
          teamBusiness += sInfo ? fromUnits(sInfo[1]) : 0;
        }
      }
    }

    document.getElementById("directCount").innerText = directCount;
    document.getElementById("indirectCount").innerText = indirectCount;
    document.getElementById("activeCounts").innerText = `${active} / ${inactive}`;
    document.getElementById("teamBusiness") &&
      (document.getElementById("teamBusiness").innerText = `${toFixedNumber(teamBusiness, 6)} USDT`);

    // ü™ú Level unlock UI
    const rows = document.querySelectorAll("#levelsTbody tr");
    rows.forEach((r, i) => {
      const cell = r.querySelector("td:last-child");
      if (!cell) return;
      if (i < Math.min(directCount, 10)) {
        cell.innerText = "Open ‚úÖ";
        cell.style.color = "#00FF90";
        cell.style.fontWeight = "600";
      } else {
        cell.innerText = "Pending";
        cell.style.color = "";
        cell.style.fontWeight = "";
      }
    });

    // üöÄ Start live ROI update animation
    const dailyRoiBps = Number(await stakingContract.dailyROIbps());
    startLiveROIAnimation(roiPending, staked, dailyRoiBps);

    // üéØ Update 3x progress bar
    updateProgressBar(staked, staked * 3, totalEarned);

  } catch (e) {
    console.error("refreshAll error:", e);
  }
}

/* ======= TEAM info helper (lighter) ======= */
async function loadTeamInfo(){
  try {
    if (!stakingContract || !account) return;
    // this function updates direct & indirect tables (already refreshed in refreshAll)
    await refreshAll();
  } catch (e) { console.warn("loadTeamInfo error", e); }
}

/* ======= simple register helper (optional) ======= */
async function ensureRegistered(referrerAddr) {
  try {
    const isReg = await stakingContract.registered(account).catch(()=>false);
    if (isReg) return true;
    // validate referrer
    const ref = (referrerAddr && ethers.utils.isAddress(referrerAddr)) ? referrerAddr : ethers.constants.AddressZero;
    const tx = await stakingContract.register(ref);
    await tx.wait();
    return true;
  } catch (e) { console.warn("ensureRegistered failed:", e); return false; }
}
// ‚úÖ Withdraw history
async function loadWithdrawHistory() {
  const tbody = document.getElementById('withdrawHistoryBody');
  tbody.innerHTML = '<tr><td colspan="4" class="center muted">Loading...</td></tr>';
  if (!stakingContract || !account) return;
  try {
    let total = Number(await stakingContract.nextWithdrawId().catch(()=>0));
    tbody.innerHTML = '';
    for (let i = total; i > 0; i--) {
      const req = await stakingContract.withdrawals(i).catch(()=>null);
      if (!req || !req.user || req.user.toLowerCase() !== account.toLowerCase()) continue;
      const time = new Date(Number(req.timestamp)*1000).toLocaleString();
      const amount = fromUnits(req.amount);
      const status = req.approved ? "‚úÖ" : "‚è≥";
      tbody.innerHTML += `<tr><td>${time}</td><td>${amount}</td><td>${status}</td><td>-</td></tr>`;
    }
  } catch(e) {
    tbody.innerHTML = '<tr><td colspan="4" class="center muted">Error</td></tr>';
  }
}

/* ======= utility: attach accounts/chain change to reload UI ======= */
if (window.ethereum) {
  window.ethereum.on("accountsChanged", (accs) => { if (accs.length === 0) { document.getElementById("walletDisplay").innerText = "Not connected"; } else location.reload(); });
  window.ethereum.on("chainChanged", () => { location.reload(); });
}

/* ======= INITIAL LOG ======= */
console.log("Staking DApp script loaded. Replace CONFIG addresses with your contract addresses.");
</script>
</body>
</html>
