Index.html old code   <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USDT Staking Dashboard</title>

  <!-- ethers v5 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root {
      --bg: #0b0d0f; --card: #121416; --muted: #9aa4b2; --accent: #ffd86b; --panel: #0f1113;
    }
    body { margin:0; font-family: Inter, Arial, sans-serif; background:var(--bg); color:#e6eef6; }
    header { padding:18px 24px; text-align:center; background:linear-gradient(90deg,#081018, #0d1016); box-shadow:0 2px 8px rgba(0,0,0,0.5); }
    header h1 { margin:0; color:var(--accent); font-size:20px; letter-spacing:0.6px; }
    .topbar { display:flex; justify-content:flex-end; gap:12px; padding:12px 24px; align-items:center; }
    .wallet-btn { background:var(--accent); color:#000; padding:8px 14px; border-radius:8px; border:0; font-weight:600; cursor:pointer; }
    .container { padding: 20px; display:grid; grid-template-columns: 360px 1fr; gap:18px; max-width:1180px; margin:18px auto; }
    .left { display:flex; flex-direction:column; gap:14px; }
    .card { background:var(--card); border-radius:12px; padding:14px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
    .card h2 { margin:0 0 10px 0; color:var(--accent); font-size:16px; }
    .muted { color:var(--muted); font-size:13px; }
    input[type="number"], input[type="text"] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:var(--panel); color:#fff; }
    .small-btn { padding:10px 12px; border-radius:8px; border:0; background:#2a2f35; color:#fff; cursor:pointer; margin-top:8px; }
    .accent-btn { background:var(--accent); color:#000; border:0; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:700; margin-top:8px; }
    .right { display:flex; flex-direction:column; gap:14px; }
    .grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
    .value { font-size:18px; font-weight:700; color:#fff; }
    .label { font-size:12px; color:var(--muted); margin-top:6px; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
    th,td { padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.03); text-align:left; }
    th { color:var(--accent); font-weight:700; background:transparent; }
    .center { text-align:center; }
    .sm { font-size:12px; color:var(--muted); }
    footer { padding:14px; text-align:center; color:var(--muted); font-size:12px; }
    @media(max-width:980px) {
      .container { grid-template-columns: 1fr; padding:12px; }
      .grid-4 { grid-template-columns: repeat(2,1fr); }
    }
  </style>
</head>
<body>
  <header><h1>USDT Staking — Dashboard</h1></header>

  <div class="topbar" style="max-width:1180px;margin:0 auto">
    <div id="walletDisplay" class="sm muted">Not connected</div>
    <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
  </div>

  <main class="container">
    <div class="left">

      <div class="card">
        <h2>Stake USDT</h2>
        <div class="sm muted">Minimum deposit: 20 USDT — multiples of 20 only</div>
        <input id="stakeAmount" type="number" placeholder="20, 40, 60 ..." />
        <button class="accent-btn" id="quickApproveBtn">Quick Approve</button>
        <button class="accent-btn" id="stakeBtn">Stake Now</button>
        <div class="sm" style="margin-top:10px;">Tip: Approve once (Quick Approve) then stake.</div>
      </div>

      <div class="card">
        <h2>Your Referral Link</h2>
        <input id="referralInput" type="text" readonly />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="small-btn" id="copyRefBtn">Copy Link</button>
          <button class="small-btn" id="showTeamBtn">Show Team</button>
        </div>
        <div class="sm muted" style="margin-top:8px;">Share this link. Users who join via referral will credit you 10% instant (internal balance).</div>
      </div>

      <div class="card">
        <h2>Withdraw</h2>
        <div class="sm muted">Minimum withdraw 10 USDT — multiples of 10. Withdrawals require admin approval.</div>
        <input id="withdrawAmount" type="number" placeholder="10, 20, 30 ..." />
        <button class="accent-btn" id="withdrawBtn">Request Withdraw</button>
        <div id="withdrawStatus" class="sm" style="margin-top:8px;">No withdraw actions yet.</div>
      </div>

    </div>

    <div class="right">

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h2>Wallet Balances & Income</h2><div class="sm muted">Instant / Level / ROI breakdown</div></div>
          <div><button class="small-btn" id="refreshBtn">Refresh Now</button></div>
        </div>

        <div style="margin-top:12px" class="grid-4">
          <div class="card" style="background:#0b0d0f; padding:12px;">
            <div class="label">Instant Income</div>
            <div class="value" id="instantIncome">0.000000 USDT</div>
          </div>
          <div class="card" style="background:#0b0d0f; padding:12px;">
            <div class="label">Level Income</div>
            <div class="value" id="levelIncome">0.000000 USDT</div>
          </div>
          <div class="card" style="background:#0b0d0f; padding:12px;">
            <div class="label">ROI Pending</div>
            <div class="value" id="roiPending">0.000000 USDT</div>
          </div>
          <div class="card" style="background:#0b0d0f; padding:12px;">
            <div class="label">Total Wallet</div>
            <div class="value" id="totalWallet">0.000000 USDT</div>
          </div>
          <div class="card" style="background:#0b0d0f; padding:12px;">
  <div class="label">Team Business</div>
  <div class="value" id="teamBusiness">0.000000 USDT</div>
</div>
        </div>
      </div>

      <div class="card">
        <h2>Staking Info</h2>
        <table>
          <tr><th>Metric</th><th>Value</th></tr>
          <tr><td>Staked</td><td id="stakedDisplay">0.000000 USDT</td></tr>
          <tr><td>Target (3x)</td><td id="targetDisplay">0.000000 USDT</td></tr>
          <tr><td>Days to 3x</td><td id="days3x">0 days</td></tr>
          <tr><td>Package Status</td><td id="pkgStatus">Inactive</td></tr>
        </table>
      </div>

      <div class="card">
        <h2>Team & Levels</h2>
        <div style="display:flex; gap:12px; align-items:center;">
          <div style="flex:1"><div class="sm muted">Direct</div><div class="value" id="directCount">0</div></div>
          <div style="flex:1"><div class="sm muted">Indirect</div><div class="value" id="indirectCount">0</div></div>
          <div style="flex:2"><div class="sm muted">Active / Inactive</div><div class="value" id="activeCounts">0 / 0</div></div>
        </div>

        <div style="margin-top:12px" class="card">
          <h3 style="margin:6px 0 8px;color:var(--accent)">Direct Team</h3>
          <table id="directTeamTable"><thead><tr><th>Wallet</th><th>Staked</th><th>Status</th></tr></thead>
            <tbody id="directTeamBody"><tr><td colspan="3" class="center sm">No directs yet.</td></tr></tbody></table>

          <h3 style="margin:12px 0 8px;color:var(--accent)">Indirect Team</h3>
          <table id="indirectTeamTable"><thead><tr><th>Wallet</th><th>Staked</th><th>Status</th></tr></thead>
            <tbody id="indirectTeamBody"><tr><td colspan="3" class="center sm">No indirects yet.</td></tr></tbody></table>
        </div>

        <div style="margin-top:12px">
          <table>
            <thead><tr><th>Level</th><th>Percent</th><th>Status</th></tr></thead>
            <tbody id="levelsTbody">
              <tr><td>L1</td><td>10%</td><td id="sL1">Pending</td></tr>
              <tr><td>L2</td><td>10%</td><td id="sL2">Pending</td></tr>
              <tr><td>L3</td><td>5%</td><td id="sL3">Pending</td></tr>
              <tr><td>L4</td><td>3%</td><td id="sL4">Pending</td></tr>
              <tr><td>L5</td><td>2%</td><td id="sL5">Pending</td></tr>
              <tr><td>L6</td><td>1%</td><td id="sL6">Pending</td></tr>
              <tr><td>L7</td><td>1%</td><td id="sL7">Pending</td></tr>
              <tr><td>L8</td><td>1%</td><td id="sL8">Pending</td></tr>
              <tr><td>L9</td><td>1%</td><td id="sL9">Pending</td></tr>
              <tr><td>L10</td><td>1%</td><td id="sL10">Pending</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Withdrawal History</h2>
        <table id="withdrawHistoryTable">
          <thead><tr><th>Req ID</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
          <tbody id="withdrawHistoryBody"><tr><td colspan="4" class="center sm">No withdrawals yet.</td></tr></tbody>
        </table>
      </div>

    </div>
  </main>

  <footer>Made with ❤️ — Testnet only (do not use mainnet funds while testing)</footer>

<script>
/* ==================== CONFIG ==================== */
/* Put your deployed addresses here (BSC Testnet) */
const STAKING_ADDRESS = "0x97DE52e37eB68e6105ecb81Dd015016C36cd6D51"; // replace if different
const TOKEN_ADDRESS   = "0xBCE19c66E53da172F78FE800368361a8aaB51F2a"; // replace if different

let TOKEN_DECIMALS = 6; // will be overwritten by token.decimals() if available

/* ==================== ABI (match the Solidity above) ==================== */
/* If you recompile contract, paste the new ABI here */
const STAKING_ABI = [
  // (keep the ABI minimal for the functions we use)
  {"inputs":[{"internalType":"address","name":"_token","type":"address"},{"internalType":"address","name":"_owner","type":"address"},{"internalType":"uint256","name":"_minTxUnits","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"rewardUnits","type":"uint256"}],"name":"Claim","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amountUnits","type":"uint256"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"Deposit","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"uint256","name":"amountUnits","type":"uint256"}],"name":"ReferralCredited","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"levelUser","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"uint256","name":"level","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amountUnits","type":"uint256"}],"name":"LevelCredited","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amountUnitsAfterFee","type":"uint256"}],"name":"WithdrawApproved","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amountUnits","type":"uint256"}],"name":"WithdrawRequested","type":"event"},
  {"inputs":[{"internalType":"uint256","name":"reqId","type":"uint256"}],"name":"approveWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"userAddr","type":"address"}],"name":"getDirectRefs","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"userAddr","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"staked","type":"uint256"},{"internalType":"uint256","name":"lastAction","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"totalEarned","type":"uint256"},{"internalType":"uint256","name":"pending","type":"uint256"},{"internalType":"uint256","name":"incomeBal","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"userAddr","type":"address"}],"name":"pendingRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amountUnits","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"}],"name":"deposit","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawRequestsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"getWithdrawRequest","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint8","name":"status","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amountUnits","type":"uint256"}],"name":"requestWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"directCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"incomeBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"}
];

const TOKEN_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];

/* ==================== APP STATE ==================== */
let provider, signer, stakingContract, tokenContract;
let account = null;

/* ==================== HELPERS ==================== */
function toFixedNumber(num, decimals=6) {
  if (isNaN(num)) return "0.000000";
  return Number(num).toFixed(decimals);
}
function fromUnits(valueBn) {
  try { return Number(ethers.utils.formatUnits(valueBn, TOKEN_DECIMALS)); }
  catch(e) { return Number(valueBn) / (10 ** TOKEN_DECIMALS); }
}

/* ==================== CONNECT ==================== */
async function connect() {
  try {
    if (!window.ethereum) { alert("MetaMask not found"); return; }
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    account = await signer.getAddress();
    document.getElementById("walletDisplay").innerText = account;

    stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);
    tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);

    try { TOKEN_DECIMALS = await tokenContract.decimals(); } catch(e){ console.warn("decimals read failed, using default", TOKEN_DECIMALS); }

    document.getElementById("referralInput").value = window.location.origin + window.location.pathname + "?ref=" + account;
    localStorage.setItem("staking_connected", account);

    await refreshAll();
    listenEvents();
  } catch (err) {
    console.error("connect error", err);
    alert("Connect failed: " + (err.message || err));
  }
}
document.getElementById("connectBtn").addEventListener("click", connect);

/* auto reconnect */
window.addEventListener("load", async () => {
  const prev = localStorage.getItem("staking_connected");
  if (prev) { try { await connect(); } catch(e){ console.log("reconnect failed"); } }
});

/* ==================== REFRESH ==================== */
async function refreshAll() {
  if (!stakingContract || !account) return;

  try {
    // ======= Wallet Balance =======
    const rawBal = await tokenContract.balanceOf(account);
    const walletBal = fromUnits(rawBal);
    document.getElementById("walletDisplay").innerText =
      account + " — " + toFixedNumber(walletBal, 6) + " USDT";

    // ======= User Info =======
    const info = await stakingContract.getUserInfo(account);
    const staked = fromUnits(info.staked || 0);
    const pending = fromUnits(info.pending || 0);
    const incomeBal = fromUnits(info.incomeBal || 0);
    const totalEarned = fromUnits(info.totalEarned || 0);

    // Display staking details
    document.getElementById("stakedDisplay").innerText = toFixedNumber(staked, 6) + " USDT";
    document.getElementById("targetDisplay").innerText = toFixedNumber(staked * 3, 6) + " USDT";
    document.getElementById("pkgStatus").innerText = staked > 0 ? "Active" : "Inactive";

    // Days to 3x (1% daily)
    const dailyRate = 0.01;
    let daysTo3x = 0;
    if (staked > 0) {
      const dailyReward = staked * dailyRate;
      const already = totalEarned + pending + incomeBal;
      const remaining = Math.max(staked * 3 - already, 0);
      daysTo3x = dailyReward > 0 ? Math.ceil(remaining / dailyReward) : 0;
    }
    document.getElementById("days3x").innerText = daysTo3x + " days";

    // ======= Team Calculation =======
    let teamBusiness = 0;
    let directCount = 0;
    let indirectCount = 0;
    let active = 0;
    let inactive = 0;

    const directs = await stakingContract.getDirectRefs(account);
    directCount = directs.length;

    for (let i = 0; i < directs.length; i++) {
      const u = await stakingContract.getUserInfo(directs[i]);
      const st = fromUnits(u.staked || 0);
      teamBusiness += st;
      if (st > 0) active++;
      else inactive++;

      const indirects = await stakingContract.getDirectRefs(directs[i]);
      indirectCount += indirects.length;
      for (let j = 0; j < indirects.length; j++) {
        const sub = await stakingContract.getUserInfo(indirects[j]);
        const st2 = fromUnits(sub.staked || 0);
        teamBusiness += st2;
      }
    }

    document.getElementById("teamBusiness").innerText = toFixedNumber(teamBusiness, 6) + " USDT";
    document.getElementById("directCount").innerText = directCount;
    document.getElementById("indirectCount").innerText = indirectCount;
    document.getElementById("activeCounts").innerText = `${active} / ${inactive}`;

    // ======= Income Calculation (Real Business Logic) =======
let roiIncome = 0, instantIncome = 0, levelIncome = 0, totalWallet = 0;

try {
  const info = await stakingContract.getUserInfo(account);
  const staked = fromUnits(info.staked || 0);
  const pending = fromUnits(info.pending || 0);
  const totalEarned = fromUnits(info.totalEarned || 0);
  const incomeBal = fromUnits(info.incomeBal || 0);

  // ROI Income = pending (not yet claimed) + totalEarned (already claimed)
  roiIncome = pending + totalEarned;

  // Instant Income = lifetime 10% referral reward (from Deposit event)
  // Contract stores combined balance, so here we simulate separation:
  // Approximation: 10% of direct deposits count toward instant income
  const directs = await stakingContract.getDirectRefs(account);
  let totalDirectStake = 0;
  for (let i = 0; i < directs.length; i++) {
    const u = await stakingContract.getUserInfo(directs[i]);
    const st = fromUnits(u.staked || 0);
    totalDirectStake += st;
  }
  instantIncome = totalDirectStake * 0.10; // 10% one-time reward

  // Level Income = difference between internal income balance and instant
  // (Represents ongoing ROI-based income from downline)
  levelIncome = Math.max(incomeBal - instantIncome, 0);

  // Total Wallet = withdrawable portion (internal + pending)
  totalWallet = incomeBal + pending;

  // Display
  document.getElementById("instantIncome").innerText = toFixedNumber(instantIncome, 6) + " USDT";
  document.getElementById("levelIncome").innerText = toFixedNumber(levelIncome, 6) + " USDT";
  document.getElementById("roiPending").innerText = toFixedNumber(roiIncome, 6) + " USDT";
  document.getElementById("totalWallet").innerText = toFixedNumber(totalWallet, 6) + " USDT";

} catch (e) {
  console.warn("income calc error:", e);
  document.getElementById("instantIncome").innerText = "0.000000 USDT";
  document.getElementById("levelIncome").innerText = "0.000000 USDT";
  document.getElementById("roiPending").innerText = "0.000000 USDT";
  document.getElementById("totalWallet").innerText = "0.000000 USDT";
}

   // ======= Level Unlock Logic =======
for (let i = 1; i <= 10; i++) {
  const el = document.getElementById(`sL${i}`);
  if (!el) continue;

  // Unlock logic based purely on direct count
  if (directCount >= i) {
    el.innerText = "Open ✅";
  } else {
    el.innerText = "Pending";
  }
}

    // ======= Team Tables =======
    const directBody = document.getElementById("directTeamBody");
    directBody.innerHTML = "";
    if (directs.length === 0) {
      directBody.innerHTML = '<tr><td colspan="3" class="center sm">No directs yet.</td></tr>';
    } else {
      for (let i = 0; i < directs.length; i++) {
        const addr = directs[i];
        const u = await stakingContract.getUserInfo(addr);
        const st = fromUnits(u.staked || 0);
        const status = st > 0 ? "Active" : "Inactive";
        directBody.innerHTML += `<tr><td class='sm'>${addr}</td><td>${toFixedNumber(st, 6)}</td><td>${status}</td></tr>`;
      }
    }

    // Indirects
    let indirectsAll = [];
    for (let i = 0; i < directs.length; i++) {
      const subs = await stakingContract.getDirectRefs(directs[i]);
      indirectsAll = indirectsAll.concat(subs);
    }
    const indirectBody = document.getElementById("indirectTeamBody");
    indirectBody.innerHTML = "";
    if (indirectsAll.length === 0) {
      indirectBody.innerHTML = '<tr><td colspan="3" class="center sm">No indirects yet.</td></tr>';
    } else {
      for (let i = 0; i < indirectsAll.length; i++) {
        const addr = indirectsAll[i];
        const u = await stakingContract.getUserInfo(addr);
        const st = fromUnits(u.staked || 0);
        const status = st > 0 ? "Active" : "Inactive";
        indirectBody.innerHTML += `<tr><td class='sm'>${addr}</td><td>${toFixedNumber(st, 6)}</td><td>${status}</td></tr>`;
      }
    }

    // ======= Withdraw History =======
    const countBn = await stakingContract.withdrawRequestsCount();
    const count = Number(countBn || 0);
    const tbody = document.getElementById("withdrawHistoryBody");
    tbody.innerHTML = "";
    for (let i = count; i >= 1 && i > count - 100; i--) {
      const req = await stakingContract.getWithdrawRequest(i);
      if (req.user && req.user.toLowerCase() !== account.toLowerCase()) continue;
      const amt = fromUnits(req.amount || 0);
      const status =
        req.status === 0
          ? "Pending"
          : req.status === 1
          ? "Approved"
          : "Rejected";
      const time = new Date(Number(req.timestamp || 0) * 1000).toLocaleString();
      tbody.innerHTML += `<tr><td>#${i}</td><td>${toFixedNumber(
        amt,
        6
      )}</td><td>${status}</td><td>${time}</td></tr>`;
    }
    if (!tbody.innerHTML)
      tbody.innerHTML =
        '<tr><td colspan="4" class="center sm">No withdrawals yet.</td></tr>';

  } catch (err) {
    console.error("refreshAll error:", err);
  }
}

/* ========== Approve / Stake / Claim / Withdraw ========== */
async function approveQuick() {
  try {
    if (!tokenContract || !signer) { alert("Connect first"); return; }
    const max = ethers.constants.MaxUint256;
    const tx = await tokenContract.approve(STAKING_ADDRESS, max);
    await tx.wait();
    alert("Approve successful");
  } catch (e) {
    console.error("approve error", e);
    alert("Approve failed: " + (e.message || e));
  }
}
document.getElementById("quickApproveBtn").addEventListener("click", approveQuick);

async function stake() {
  try {
    if (!stakingContract || !signer) { alert("Connect wallet first"); return; }
    const amtStr = document.getElementById("stakeAmount").value;
    if (!amtStr || Number(amtStr) <= 0) { alert("Enter stake amount"); return; }
    const amt = Number(amtStr);
    if (amt < 20 || (amt % 20) !== 0) { alert("Stake must be at least 20 USDT and multiple of 20"); return; }

    const units = ethers.utils.parseUnits(amt.toString(), TOKEN_DECIMALS);

    // resolve referrer: prefer localStorage then URL param else owner
    let ref = localStorage.getItem("staking_ref") || new URLSearchParams(window.location.search).get("ref");
    if (!ref || !ethers.utils.isAddress(ref)) {
      try { ref = await stakingContract.owner(); } catch(e){ ref = ethers.constants.AddressZero; }
    }

    const tx = await stakingContract.deposit(units, ref);
    await tx.wait();
    alert("Deposit successful");
    await refreshAll();
  } catch (e) {
    console.error("stake error", e);
    alert("Stake failed: " + (e.data?.message || e.message || e));
  }
}
document.getElementById("stakeBtn").addEventListener("click", stake);

/* Claim ROI (this will credit user's internal income balance and distribute level income to uplines) */
async function claim() {
  try {
    if (!stakingContract || !signer) { alert("Connect wallet first"); return; }
    const tx = await stakingContract.claimRewards();
    await tx.wait();
    alert("Claim processed. ROI credited to your income balance (withdrawable after admin approval).");
    await refreshAll();
  } catch (e) {
    console.error("claim error", e);
    alert("Claim failed: " + (e.data?.message || e.message || e));
  }
}

/* Withdraw request — this deducts from internal income balance immediately and creates request */
async function withdraw() {
  try {
    if (!stakingContract || !signer) { alert("Connect first"); return; }
    const amtStr = document.getElementById("withdrawAmount").value;
    if (!amtStr || Number(amtStr) <= 0) { alert("Enter withdraw amount"); return; }
    const amt = Number(amtStr);
    if (amt < 10 || (amt % 10) !== 0) { alert("Withdraw must be at least 10 USDT and multiple of 10"); return; }
    const units = ethers.utils.parseUnits(amt.toString(), TOKEN_DECIMALS);
    const tx = await stakingContract.requestWithdraw(units);
    await tx.wait();
  document.getElementById("withdrawStatus").innerText = "Withdraw request submitted. Waiting for Admin approval.";
await refreshAll();

// Reduce total wallet value after withdraw
const amttr = document.getElementById("withdrawAmount").value;
if (amtStr) {
  const totalBox = document.getElementById("totalWallet");
  let current = parseFloat(totalBox.innerText);
  if (!isNaN(current)) {
    totalBox.innerText = toFixedNumber(current - Number(amtStr), 6) + " USDT";
  }
}

  } catch (e) {
    console.error("withdraw error", e);
    alert("Withdraw failed: " + (e.data?.message || e.message || e));
  }
}
document.getElementById("withdrawBtn").addEventListener("click", withdraw);

/* ==================== EVENTS LISTENER ==================== */
function listenEvents() {
  try {
    if (!stakingContract) return;

    /* ===== Deposit Event ===== */
    stakingContract.on("Deposit", (user, amount, referrer, event) => {
      console.log("📥 Deposit:", user, amount.toString(), "Referrer:", referrer);
      if (user.toLowerCase() === account.toLowerCase()) {
        alert("✅ Deposit Successful!");
      }
      refreshAll();
    });

    /* ===== Claim Event ===== */
    stakingContract.on("Claim", (user, reward, event) => {
      console.log("💰 Claim:", user, reward.toString());
      if (user.toLowerCase() === account.toLowerCase()) {
        const amt = ethers.utils.formatUnits(reward, TOKEN_DECIMALS);
        alert(`🎉 ROI Claimed: ${amt} USDT credited to your internal wallet.`);
      }
      refreshAll();
    });

    /* ===== Withdraw Requested ===== */
    stakingContract.on("WithdrawRequested", (id, user, amount, event) => {
      console.log("📤 Withdraw Requested:", id.toString(), user, amount.toString());
      if (user.toLowerCase() === account.toLowerCase()) {
        alert("🕒 Withdraw Request Submitted! Waiting for Admin approval.");
      }
      refreshAll();
    });

    /* ===== Withdraw Approved ===== */
    stakingContract.on("WithdrawApproved", (id, user, amountAfterFee, event) => {
      console.log("✅ Withdraw Approved:", id.toString(), user, amountAfterFee.toString());
      if (user.toLowerCase() === account.toLowerCase()) {
        const amt = ethers.utils.formatUnits(amountAfterFee, TOKEN_DECIMALS);
        alert(`💸 Withdraw Approved! You received ${amt} USDT (after 5% fee).`);
      }
      refreshAll();
    });

    /* ===== Referral Instant Income (Direct 10%) ===== */
    stakingContract.on("ReferralCredited", (referrer, from, amount, event) => {
      console.log("🤝 ReferralCredited:", referrer, "from", from, "amount", amount.toString());

      if (referrer.toLowerCase() === account.toLowerCase()) {
        // Unlock Level 1
        const el = document.getElementById("sL1");
        if (el) {
          el.innerText = "Open ✅";
          el.style.color = "#00FF90";
          el.style.fontWeight = "600";
        }

        const amt = ethers.utils.formatUnits(amount, TOKEN_DECIMALS);
        alert(`🔥 Level 1 Activated! You earned ${amt} USDT Instant Income.`);
      }

      refreshAll();
    });

    /* ===== Level Income Credited (Auto Unlock L2–L10) ===== */
    stakingContract.on("LevelCredited", (levelUser, from, level, amount, event) => {
      console.log("🎯 LevelCredited Triggered:", levelUser, "from", from, "level", level.toString(), "amount", amount.toString());

      if (levelUser.toLowerCase() === account.toLowerCase()) {
        const lvl = parseInt(level.toString());
        if (lvl >= 1 && lvl <= 10) {
          const el = document.getElementById(`sL${lvl}`);
          if (el) {
            el.innerText = "Open ✅";
            el.style.color = "#00FF90";
            el.style.fontWeight = "600";
          }

          const amt = ethers.utils.formatUnits(amount, TOKEN_DECIMALS);
          alert(`🎉 Level ${lvl} Income Received: ${amt} USDT`);
        }
      }

      refreshAll();
    });

  } catch (e) {
    console.warn("⚠️ listenEvents error", e);
  }
}

/* Load withdraw request history for current user */
async function loadWithdrawHistory() {
  if (!stakingContract || !account) return;
  try {
    const countBn = await stakingContract.withdrawRequestsCount();
    const count = Number(countBn || 0);
    const tbody = document.getElementById("withdrawHistoryBody");
    tbody.innerHTML = "";
    for (let i = count; i >= 1 && i > count - 100; i--) {
      const req = await stakingContract.getWithdrawRequest(i);
      if (req.user && req.user.toLowerCase() !== account.toLowerCase()) continue;
      const amt = fromUnits(req.amount || 0);
      const status = (req.status === 0) ? "Pending" : (req.status === 1) ? "Approved" : "Rejected";
      const time = new Date(Number(req.timestamp || 0) * 1000).toLocaleString();
      const row = `<tr><td>#${i}</td><td>${toFixedNumber(amt,6)}</td><td>${status}</td><td>${time}</td></tr>`;
      tbody.innerHTML += row;
    }
    if (!tbody.innerHTML) tbody.innerHTML = '<tr><td colspan="4" class="center sm">No withdrawals yet.</td></tr>';
  } catch (e) { console.warn("loadWithdrawHistory", e); }
}

/* Load team tables */
async function loadTeamInfo() {
  if (!stakingContract || !account) return;
  try {
    // Direct Team
    let directs = [];
    try {
      directs = await stakingContract.getDirectRefs(account);
      console.log("Direct refs:", directs);
    } catch (err) {
      console.error("getDirectRefs error:", err);
    }

    const directBody = document.getElementById("directTeamBody");
    directBody.innerHTML = "";

    if (!directs || directs.length === 0) {
      directBody.innerHTML = '<tr><td colspan="3" class="center sm">No directs yet.</td></tr>';
    } else {
      for (let i = 0; i < directs.length; i++) {
        const addr = directs[i];
        if (!ethers.utils.isAddress(addr)) continue;
        try {
          const info = await stakingContract.getUserInfo(addr);
          const st = fromUnits(info.staked || 0);
          const status = st > 0 ? "Active" : "Inactive";
          directBody.innerHTML += `<tr><td class="sm">${addr}</td><td>${toFixedNumber(st, 2)} USDT</td><td>${status}</td></tr>`;
        } catch (err) {
          console.warn("getUserInfo failed for", addr, err);
        }
      }
    }

    // Indirect Team
    let indirects = [];
    for (let i = 0; i < directs.length; i++) {
      try {
        const subs = await stakingContract.getDirectRefs(directs[i]);
        if (subs && subs.length > 0) indirects = indirects.concat(subs);
      } catch (err) {
        console.warn("sub load error", err);
      }
    }

    const indirectBody = document.getElementById("indirectTeamBody");
    indirectBody.innerHTML = "";

    if (!indirects || indirects.length === 0) {
      indirectBody.innerHTML = '<tr><td colspan="3" class="center sm">No indirects yet.</td></tr>';
    } else {
      for (let i = 0; i < indirects.length; i++) {
        const addr = indirects[i];
        if (!ethers.utils.isAddress(addr)) continue;
        try {
          const info = await stakingContract.getUserInfo(addr);
          const st = fromUnits(info.staked || 0);
          const status = st > 0 ? "Active" : "Inactive";
          indirectBody.innerHTML += `<tr><td class="sm">${addr}</td><td>${toFixedNumber(st, 2)} USDT</td><td>${status}</td></tr>`;
        } catch (err) {
          console.warn("getUserInfo failed for", addr, err);
        }
      }
    }

    // Update counts
    document.getElementById("directCount").innerText = directs.length.toString();
    document.getElementById("indirectCount").innerText = indirects.length.toString();

    let active = 0, inactive = 0;
    for (let i = 0; i < directs.length; i++) {
      const addr = directs[i];
      const info = await stakingContract.getUserInfo(addr);
      const st = fromUnits(info.staked || 0);
      if (st > 0) active++; else inactive++;
    }
    document.getElementById("activeCounts").innerText = `${active} / ${inactive}`;

  } catch (e) {
    console.error("loadTeamInfo error", e);
  }
}


/* Copy referral */
document.getElementById("copyRefBtn").addEventListener("click", async () => {
  if (!account) { alert("Connect wallet first"); return; }
  const link = window.location.origin + window.location.pathname + "?ref=" + account;
  await navigator.clipboard.writeText(link);
  alert("Copied referral link");
});

/* expose connect on top button (redundant) */
document.getElementById("connectBtn").addEventListener("click", connect);

console.log("Dashboard loaded. Ready to connect.");
</script>
</body>
</html>

