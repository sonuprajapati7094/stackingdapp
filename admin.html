<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>USDT Staking — Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <style>
    body{background:#071014;color:#fff;font-family:Inter,Arial;padding:20px}
    .wrap{max-width:1000px;margin:0 auto}
    .card{background:#0e1416;padding:16px;border-radius:10px;margin-bottom:12px}
    .btn{background:#f6c84c;color:#000;padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
    input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Admin Panel — USDT Staking</h2>

    <div class="card">
      <div><b>Connected as:</b> <span id="addr">-</span></div>
      <div style="margin-top:10px"><button id="connect" class="btn">Connect MetaMask</button></div>
    </div>

    <div class="card">
      <h3>Pending Withdrawals</h3>
      <div style="margin-bottom:8px" class="small">Approve user withdrawal requests here.</div>
      <table id="pendingTable">
        <thead><tr><th>ID</th><th>User</th><th>Amount</th><th>When</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button id="refreshPending" class="btn">Refresh Pending</button></div>
    </div>

    <div class="card">
      <h3>Pause / Unpause User</h3>
      <div style="display:flex;gap:8px">
        <input id="pauseAddr" placeholder="user address"/>
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="unpauseBtn" class="btn">Unpause</button>
      </div>
    </div>

    <div class="card">
      <h3>Set ROI / Fee</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="roiBps" placeholder="dailyROI bps (100 = 1%)"/>
        <input id="feeBps" placeholder="withdraw fee bps (500 = 5%)"/>
        <button id="setParams" class="btn">Set</button>
      </div>
      <div id="setResult" style="margin-top:8px;color:#ddd"></div>
    </div>

    <div class="card">
      <h3>Emergency</h3>
      <div style="display:flex;gap:8px">
        <input id="emTo" placeholder="to address"/>
        <button id="emBtn" class="btn">Emergency Withdraw All</button>
      </div>
      <div id="emRes" style="margin-top:8px;color:#ddd"></div>
    </div>
  </div>

<script>
const CONFIG = {
  tokenAddress: "0x1a904b37B0d9D6ab755aBDa4656E42F278FC89AA",
  stakingAddress: "0xE65396C1B8c63167A86d374ec7aD8F1471CC1F2f",
  decimals: 6
};

const STAKING_ABI = [
  "function owner() external view returns (address)",
  "function approveWithdrawal(uint256 id) external",
  "function pauseUser(address userAddr) external",
  "function unpauseUser(address userAddr) external",
  "function setDailyRoi(uint256 bps) external",
  "function setWithdrawFee(uint256 bps) external",
  "function emergencyWithdrawAll(address to) external",
  "event WithdrawalRequested(address indexed user, uint256 id, uint256 amount)",
  "event WithdrawalApproved(address indexed user, uint256 id, uint256 gross, uint256 net, uint256 fee)"
];

let provider, signer, addr, staking;

document.getElementById('connect').onclick = async () => {
  if (!window.ethereum) return alert("Install MetaMask");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  addr = await signer.getAddress();
  document.getElementById('addr').innerText = addr;
  staking = new ethers.Contract(CONFIG.stakingAddress, STAKING_ABI, signer);
  const owner = await staking.owner();
  if (owner.toLowerCase() !== addr.toLowerCase()){
    alert("Warning: connected account is not owner.");
  }
  await loadPending();
};

document.getElementById('refreshPending').onclick = loadPending;

async function loadPending(){
  if (!provider) return alert("Connect");
  const iface = new ethers.utils.Interface(STAKING_ABI);
  const topic = iface.getEventTopic("WithdrawalRequested");
  try {
    const logs = await provider.getLogs({ address: CONFIG.stakingAddress, topics: [topic] });
    const items = logs.map(l => ({ l, ev: iface.parseLog(l) })).sort((a,b)=>b.l.blockNumber - a.l.blockNumber);
    const tbody = document.querySelector('#pendingTable tbody');
    tbody.innerHTML = "";
    for (let it of items){
      const ev = it.ev;
      const id = ev.args.id.toString();
      const user = ev.args.user;
      const amt = ethers.utils.formatUnits(ev.args.amount, CONFIG.decimals);
      const when = new Date((await provider.getBlock(it.l.blockNumber)).timestamp*1000).toLocaleString();
      // check if approved by searching WithdrawalApproved event
      const apvTopic = iface.getEventTopic("WithdrawalApproved");
      const apvLogs = await provider.getLogs({ address: CONFIG.stakingAddress, topics: [apvTopic] });
      const approvedIds = new Set(apvLogs.map(l=>iface.parseLog(l).args.id.toString()));
      if (approvedIds.has(id)) continue; // skip already approved
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${id}</td><td>${user}</td><td>${Number(amt).toFixed(6)}</td><td>${when}</td><td><button class="btn approve" data-id="${id}">Approve</button></td>`;
      tbody.appendChild(tr);
    }
    // add listeners
    document.querySelectorAll('.approve').forEach(b=>{
      b.onclick = async (e)=>{
        const id = e.target.dataset.id;
        try {
          const tx = await staking.approveWithdrawal(Number(id));
          await tx.wait();
          alert("Approved "+id);
          await loadPending();
        } catch(err){ console.error(err); alert("Approve failed: "+(err?.message||err)); }
      };
    });
  } catch(e){ console.error(e); alert("Failed to load pending"); }
}

document.getElementById('pauseBtn').onclick = async () => {
  const a = document.getElementById('pauseAddr').value;
  if (!a) return alert("addr");
  try { const tx = await staking.pauseUser(a); await tx.wait(); alert("Paused"); } catch(e){ alert(e?.message||e) }
};
document.getElementById('unpauseBtn').onclick = async () => {
  const a = document.getElementById('pauseAddr').value;
  if (!a) return alert("addr");
  try { const tx = await staking.unpauseUser(a); await tx.wait(); alert("Unpaused"); } catch(e){ alert(e?.message||e) }
};

document.getElementById('setParams').onclick = async ()=>{
  const r = document.getElementById('roiBps').value;
  const f = document.getElementById('feeBps').value;
  if (!r && !f) return alert("Enter values");
  try {
    if (r) { const tx = await staking.setDailyRoi(Number(r)); await tx.wait(); }
    if (f) { const tx = await staking.setWithdrawFee(Number(f)); await tx.wait(); }
    document.getElementById('setResult').innerText = "Parameters updated";
  } catch(e){ alert("Failed: "+(e?.message||e)); }
};

document.getElementById('emBtn').onclick = async () => {
  const to = document.getElementById('emTo').value;
  if (!to) return alert("to address");
  try {
    const tx = await staking.emergencyWithdrawAll(to);
    await tx.wait();
    document.getElementById('emRes').innerText = "Emergency withdraw executed";
  } catch(e){ alert("Failed: " + (e?.message||e)); }
};

</script>
</body>
</html>
