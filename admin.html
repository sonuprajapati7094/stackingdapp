<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel â€” USDT Staking (BSC Testnet)</title>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b0d0f; --card:#0f1214; --muted:#9aa4b2; --accent:#ffd86b;
      --panel:#121416; --success:#00c176; --danger:#ff6b6b;
    }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#e6eef6;}
    header{padding:18px 24px;text-align:center;background:linear-gradient(90deg,#081018,#0d1016);box-shadow:0 2px 8px rgba(0,0,0,0.5);}
    header h1{margin:0;color:var(--accent);font-size:20px;}
    .topbar{display:flex;justify-content:flex-end;gap:12px;padding:12px 24px;align-items:center;max-width:1180px;margin:0 auto;}
    .wallet-btn{background:var(--accent);color:#000;padding:8px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer;}
    .container{padding:20px;display:grid;grid-template-columns:1fr 420px;gap:18px;max-width:1180px;margin:18px auto;}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.4);}
    h2{color:var(--accent);margin:0 0 12px 0;}
    label{display:block;color:var(--muted);font-size:13px;margin-top:8px;}
    input,select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:#fff;box-sizing:border-box;margin-top:6px;}
    .small-btn{padding:8px 10px;border-radius:8px;border:0;background:#2a2f35;color:#fff;cursor:pointer;margin-top:8px;}
    .accent-btn{background:var(--accent);color:#000;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;margin-top:8px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;}
    th{color:var(--accent);font-weight:700;}
    .muted{color:var(--muted);font-size:13px;}
    .danger{background:var(--danger);color:#fff;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;}
    .success{background:var(--success);color:#000;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;}
    .pill{display:inline-block;padding:6px 10px;border-radius:16px;background:#222;color:#fff;font-weight:600;}
    footer{padding:14px;text-align:center;color:var(--muted);font-size:12px;}
    @media(max-width:980px){.container{grid-template-columns:1fr;padding:12px;} }
    .toast { position:fixed; right:18px; bottom:18px; background:#111; padding:12px 16px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.6); color:#fff; z-index:9999; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .mini { width:120px; }
    .kbd { background:#0b0d0f;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:6px;font-weight:700;display:inline-block;color:var(--muted); }
  </style>
</head>
<body>
<header><h1>Admin Panel â€” USDT Staking (BSC Testnet)</h1></header>
<div class="topbar">
  <div id="walletDisplay" class="muted">Not connected</div>
  <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
</div>

<main class="container">

  <!-- LEFT: Main Admin Controls -->
  <div class="card">
    <h2>Owner Dashboard</h2>
    <div id="ownerHint" class="muted" style="margin-bottom:10px">Connect MetaMask with the owner account to see admin controls.</div>

    <div id="ownerControls" style="display:none;">

      <div style="display:flex;gap:10px;align-items:center;">
        <div style="flex:1">
          <label>Contract Owner</label>
          <div id="ownerAddr" class="kbd">-</div>
        </div>
        <div style="width:160px">
          <label>Chain</label>
          <div class="kbd">BSC Testnet</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

      <h3 style="color:var(--accent);margin-bottom:8px">Quick Stats</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <div class="card"><div class="muted">Total Users</div><div id="statUsers" class="value">-</div></div>
        <div class="card"><div class="muted">Total Staked</div><div id="statStaked" class="value">-</div></div>
        <div class="card"><div class="muted">Total Withdrawn (net)</div><div id="statWithdrawn" class="value">-</div></div>
        <div class="card"><div class="muted">Total Fees Collected</div><div id="statFees" class="value">-</div></div>

        <!-- ðŸ”¥ New Live Stats Added -->
        <div class="card"><div class="muted">Contract Balance</div><div id="statContractBal" class="value">-</div></div>
        <div class="card"><div class="muted">Pending Withdrawals</div><div id="statPending" class="value">-</div></div>
        <div class="card"><div class="muted">Available Liquidity</div><div id="statAvailable" class="value">-</div></div>
      </div>
      <!-- end Quick Stats -->

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
      <h3 style="color:var(--accent);margin-bottom:8px">Contract Controls</h3>
      <label>Pause / Unpause Contract</label>
      <div class="row">
        <button id="pauseContract" class="small-btn">Pause</button>
        <button id="unpauseContract" class="small-btn">Unpause</button>
      </div>

      <label style="margin-top:8px">Pause / Unpause User (by address)</label>
      <input id="pauseUserAddr" placeholder="user address (0x...)" />
      <div class="row">
        <button id="pauseUserBtn" class="small-btn">Pause User</button>
        <button id="unpauseUserBtn" class="small-btn">Unpause User</button>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
      <h3 style="color:var(--accent);margin-bottom:8px">Settings</h3>
      <label>Set Daily ROI (BPS) â€” example 100 = 1%</label>
      <div class="row"><input id="dailyRoiInp" placeholder="e.g., 100" /><button id="setDailyRoi" class="small-btn">Set</button></div>
      <label>Set Withdraw Fee (BPS) â€” example 500 = 5%</label>
      <div class="row"><input id="withdrawFeeInp" placeholder="e.g., 500" /><button id="setWithdrawFee" class="small-btn">Set</button></div>
      <label>Update Admin Wallet (fees go here)</label>
      <div class="row"><input id="adminWalletInp" placeholder="0x..." /><button id="setAdminWalletBtn" class="small-btn">Set</button></div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
      <h3 style="color:var(--accent);margin-bottom:8px">Emergency</h3>
      <label>Emergency withdraw ALL tokens to address</label>
      <div class="row"><input id="emergencyTo" placeholder="0x..." /><button id="emergencyWithdrawBtn" class="danger">Emergency Withdraw</button></div>

    </div>
  </div>

  <!-- RIGHT: Withdrawals Queue & Approvals -->
  <div class="card">
    <h2>Withdrawals Queue</h2>
    <div class="muted">Approve on-chain or Reject (frontend mark). Table shows recent requests.</div>
    <div style="margin-top:10px;overflow:auto;max-height:620px;">
      <table id="withdrawTable">
        <thead>
          <tr><th>ID</th><th>User</th><th>Amount</th><th>When</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="withdrawTbody">
          <tr><td colspan="6" class="center muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div style="margin-top:12px">
      <button id="refreshQueue" class="small-btn">Refresh Queue</button>
      <button id="exportCsv" class="small-btn">Export CSV</button>
    </div>
  </div>

</main>

<footer style="max-width:1180px;margin:12px auto;text-align:center;color:var(--muted);font-size:13px;">
  Admin panel â€” keep your owner wallet safe. Use Testnet for testing.
</footer>

<div id="toastWrap" style="position:fixed;right:18px;bottom:18px;z-index:9999"></div>

<script>
/* ===== CONFIG ===== */
const CONFIG = {
  stakingAddress: "0x0c38576d85677dE210DD1C68378604d3AacfAB27",
  decimals: 6,
  desiredChainId: 97
};

/* ===== ABI (admin functions + useful views) ===== */
const STAKING_ABI = [
  "function owner() view returns (address)",
  "function nextWithdrawId() view returns (uint256)",
  "function withdrawals(uint256) view returns (address user,uint256 amount,bool approved,uint256 timestamp)",
  "function approveWithdrawal(uint256 id) external",
  "function pendingWithdrawals(address) view returns (uint256)",
  "function totalUsers() view returns (uint256)",
  "function totalStaked() view returns (uint256)",
  "function totalWithdrawnNet() view returns (uint256)",
  "function totalFeesCollected() view returns (uint256)",
  "function pauseContract() external",
  "function unpauseContract() external",
  "function pauseUser(address a) external",
  "function unpauseUser(address a) external",
  "function setDailyRoi(uint256 bps) external",
  "function setWithdrawFee(uint256 bps) external",
  "function setAdminWallet(address a) external",
  "function emergencyWithdrawAll(address to) external",
  "function getContractStats() view returns (uint256 contractBalance,uint256 totalPendingWithdrawals)",
  "event WithdrawalRequested(address indexed user, uint256 id, uint256 amount)",
  "event WithdrawalApproved(address indexed user, uint256 id, uint256 gross, uint256 net, uint256 fee)"
];

/* ===== STATE ===== */
let provider, signer, account, stakingContract;
let isOwner = false;

/* ===== Helpers ===== */
function toast(msg, ttl = 3500) {
  try {
    const w = document.getElementById("toastWrap");
    const el = document.createElement("div");
    el.className = "toast";
    el.innerText = msg;
    w.appendChild(el);
    setTimeout(()=>{ el.style.opacity = 0; setTimeout(()=>el.remove(),400); }, ttl);
  } catch(e){ console.log("toast err",e); }
}
function fromUnits(bn) {
  try { return Number(ethers.utils.formatUnits(bn, CONFIG.decimals)); } catch (e) { return 0; }
}
function toUnits(v) { return ethers.utils.parseUnits(String(v), CONFIG.decimals); }
function toFixed(n){return Number(n).toLocaleString('en-US',{maximumFractionDigits:6,minimumFractionDigits:6});}

/* ===== Load Contract Live Stats ===== */
async function loadContractStats() {
  try {
    const [contractBalance, totalPending] = await stakingContract.getContractStats();
    const available = contractBalance.sub(totalPending);
    document.getElementById("statContractBal").innerText = `${toFixed(fromUnits(contractBalance))} USDT`;
    document.getElementById("statPending").innerText = `${toFixed(fromUnits(totalPending))} USDT`;
    document.getElementById("statAvailable").innerText = `${toFixed(fromUnits(available))} USDT`;
  } catch (e) {
    console.error("loadContractStats error", e);
    document.getElementById("statContractBal").innerText = "-";
    document.getElementById("statPending").innerText = "-";
    document.getElementById("statAvailable").innerText = "-";
  }
}

/* ===== Init provider ===== */
async function initProvider(tempProvider) {
  provider = tempProvider;
  signer = provider.getSigner();
  account = await signer.getAddress();
  const net = await provider.getNetwork();
  if (net.chainId !== CONFIG.desiredChainId) {
    try {
      await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x61' }] });
      location.reload(); return;
    } catch (e) { toast("Please switch MetaMask to BSC Testnet (97)"); }
  }
  stakingContract = new ethers.Contract(CONFIG.stakingAddress, STAKING_ABI, signer);
  document.getElementById("walletDisplay").innerText = account;
  await loadOwnerState();
  attachHandlers();
  await refreshStats();
  await loadWithdrawQueue();
  listenEvents();
  localStorage.setItem("admin_connected","1");
}

/* ===== Connect ===== */
document.getElementById("connectBtn").addEventListener("click", async () => {
  if (!window.ethereum) return alert("MetaMask not found");
  try {
    await window.ethereum.request({ method:"eth_requestAccounts" });
    const tempProv = new ethers.providers.Web3Provider(window.ethereum,"any");
    await initProvider(tempProv);
  } catch (e) { alert("Connect failed: "+(e.message||e)); }
});

/* ===== Refresh stats ===== */
async function refreshStats() {
  try {
    const tu = await stakingContract.totalUsers().catch(()=>ethers.constants.Zero);
    const ts = await stakingContract.totalStaked().catch(()=>ethers.constants.Zero);
    const tw = await stakingContract.totalWithdrawnNet().catch(()=>ethers.constants.Zero);
    const tf = await stakingContract.totalFeesCollected().catch(()=>ethers.constants.Zero);

    document.getElementById("statUsers").innerText = Number(tu)||0;
    document.getElementById("statStaked").innerText = `${toFixed(fromUnits(ts))} USDT`;
    document.getElementById("statWithdrawn").innerText = `${toFixed(fromUnits(tw))} USDT`;
    document.getElementById("statFees").innerText = `${toFixed(fromUnits(tf))} USDT`;

    await loadContractStats(); // ðŸ”¥ added new stats call
  } catch(e){ console.error("refreshStats error",e); }
}

/* ===== Remaining functions stay unchanged ===== */
// ... (your existing loadWithdrawQueue, attachHandlers, exportCsv, listenEvents etc. exactly as before)
</script>
</body>
</html>

