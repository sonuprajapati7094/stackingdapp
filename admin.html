<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Staking Contract</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.min.js"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background-color: #0b0b0b;
      color: #f5f5f5;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #00ff88;
    }
    .card {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 0 10px rgba(0, 255, 100, 0.2);
    }
    button {
      background-color: #00ff88;
      color: black;
      padding: 8px 14px;
      margin: 4px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #00cc66;
    }
    input {
      padding: 8px;
      border-radius: 6px;
      border: none;
      width: 220px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #00ff8844;
    }
    .denied {
      color: red;
      text-align: center;
      font-weight: bold;
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <h1>Admin Panel üõ†Ô∏è</h1>
  <h2>For Contract Owner Only</h2>

  <div id="accessDenied" class="denied" style="display:none;">üö´ Access Denied: Only Owner Wallet Can Use This Panel.</div>

  <div id="mainPanel" style="display:none;">
    <div class="card">
      <h3>Connected Owner: <span id="adminAddr">-</span></h3>
      <p>Contract Address: <span id="contractAddr"></span></p>
      <button id="refreshBtn">üîÑ Refresh Withdraw Requests</button>
    </div>

    <div class="card">
      <h3>Pending Withdrawals</h3>
      <table id="withdrawTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Amount</th>
            <th>Timestamp</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="withdrawBody"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Emergency Withdraw Tokens</h3>
      <input type="text" id="toAddress" placeholder="Receiver Wallet Address" /><br/><br/>
      <input type="number" id="tokenAmount" placeholder="Amount (in tokens)" /><br/><br/>
      <button id="emergencyBtn">üö® Withdraw Now</button>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const CONTRACT_ADDRESS = "0x872C20bA980b9e31e5De6311Dc7d12e153c467C3";
    const OWNER_ADDRESS = "0x8b2Ce640BD59C7333e72BaE9a3Fc8D33d5460c63"; // Change to your owner wallet
    // ==========================

    const ABI = [
      "function owner() view returns (address)",
      "function withdrawRequestsCount() view returns (uint256)",
      "function getWithdrawRequest(uint256 id) view returns (address user, uint256 amount, uint256 timestamp, uint8 status)",
      "function approveWithdrawal(uint256 id)",
      "function rejectWithdrawal(uint256 id)",
      "function emergencyWithdrawToken(address to, uint256 amount)"
    ];

    let provider, signer, contract, currentAccount;

    async function connect() {
      if (!window.ethereum) {
        alert("MetaMask not detected!");
        return;
      }
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      currentAccount = await signer.getAddress();
      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

      document.getElementById("adminAddr").innerText = currentAccount;
      document.getElementById("contractAddr").innerText = CONTRACT_ADDRESS;

      const contractOwner = await contract.owner();

      if (currentAccount.toLowerCase() !== contractOwner.toLowerCase() && currentAccount.toLowerCase() !== OWNER_ADDRESS.toLowerCase()) {
        document.getElementById("accessDenied").style.display = "block";
        document.getElementById("mainPanel").style.display = "none";
        return;
      }

      document.getElementById("mainPanel").style.display = "block";
      loadWithdrawRequests();
    }

    async function loadWithdrawRequests() {
      const count = Number(await contract.withdrawRequestsCount());
      const tbody = document.getElementById("withdrawBody");
      tbody.innerHTML = "";

      for (let i = count; i >= 1; i--) {
        const [user, amount, timestamp, status] = await contract.getWithdrawRequest(i);
        const readableAmt = Number(amount) / 1e6; // assuming USDT (6 decimals)
        const time = new Date(Number(timestamp) * 1000).toLocaleString();
        let statusText = "";
        if (status === 0) statusText = "‚è≥ Pending";
        else if (status === 1) statusText = "‚úÖ Approved";
        else statusText = "‚ùå Rejected";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i}</td>
          <td>${user}</td>
          <td>${readableAmt.toFixed(2)} USDT</td>
          <td>${time}</td>
          <td>${statusText}</td>
          <td>
            ${status === 0 ? `
              <button onclick="approve(${i})">Approve</button>
              <button onclick="reject(${i})">Reject</button>
            ` : '-'}
          </td>
        `;
        tbody.appendChild(row);
      }
    }

    async function approve(id) {
      try {
        const tx = await contract.approveWithdrawal(id);
        await tx.wait();
        alert(`‚úÖ Withdrawal #${id} Approved`);
        loadWithdrawRequests();
      } catch (err) {
        console.error(err);
        alert("‚ùå Transaction failed.");
      }
    }

    async function reject(id) {
      try {
        const tx = await contract.rejectWithdrawal(id);
        await tx.wait();
        alert(`üö´ Withdrawal #${id} Rejected`);
        loadWithdrawRequests();
      } catch (err) {
        console.error(err);
        alert("‚ùå Transaction failed.");
      }
    }

    async function emergencyWithdraw() {
      const to = document.getElementById("toAddress").value.trim();
      const amount = document.getElementById("tokenAmount").value.trim();
      if (!to || !amount) return alert("Enter address and amount!");
      try {
        const amt = ethers.parseUnits(amount, 6); // 6 decimals for USDT
        const tx = await contract.emergencyWithdrawToken(to, amt);
        await tx.wait();
        alert(`üö® Emergency Withdrawal Successful to ${to}`);
      } catch (err) {
        console.error(err);
        alert("‚ùå Transaction failed.");
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", loadWithdrawRequests);
    document.getElementById("emergencyBtn").addEventListener("click", emergencyWithdraw);

    connect();
  </script>
</body>
</html>
