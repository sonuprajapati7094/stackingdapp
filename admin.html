<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel — USDT Staking (BSC Testnet)</title>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0d0f;
      --card: #0f1214;
      --muted: #9aa4b2;
      --accent: #ffd86b;
      --panel: #121416;
      --success: #00c176;
      --danger: #ff6b6b;
    }
    body {margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#e6eef6;}
    header {padding:18px 24px;text-align:center;background:linear-gradient(90deg,#081018,#0d1016);box-shadow:0 2px 8px rgba(0,0,0,0.5);}
    header h1 {margin:0;color:var(--accent);font-size:20px;}
    .topbar {display:flex;justify-content:flex-end;gap:12px;padding:12px 24px;align-items:center;max-width:1180px;margin:0 auto;}
    .wallet-btn {background:var(--accent);color:#000;padding:8px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer;}
    .container {padding:20px;display:grid;grid-template-columns:1fr 420px;gap:18px;max-width:1180px;margin:18px auto;}
    .card {background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.4);}
    h2 {color:var(--accent);margin:0 0 12px 0;}
    label {display:block;color:var(--muted);font-size:13px;margin-top:8px;}
    input,select {width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:#fff;box-sizing:border-box;margin-top:6px;}
    .small-btn {padding:8px 10px;border-radius:8px;border:0;background:#2a2f35;color:#fff;cursor:pointer;margin-top:8px;}
    .accent-btn {background:var(--accent);color:#000;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;margin-top:8px;}
    table {width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;}
    th,td {padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;}
    th {color:var(--accent);font-weight:700;}
    .muted {color:var(--muted);font-size:13px;}
    .danger {background:var(--danger);color:#fff;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;}
    .success {background:var(--success);color:#000;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;}
    footer {padding:14px;text-align:center;color:var(--muted);font-size:12px;}
    .toast {position:fixed;right:18px;bottom:18px;background:#111;padding:12px 16px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.6);color:#fff;z-index:9999;}
    .row {display:flex;gap:10px;align-items:center;}
    .kbd {background:#0b0d0f;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:6px;font-weight:700;display:inline-block;color:var(--muted);}
    @media(max-width:980px){.container{grid-template-columns:1fr;padding:12px;}}
  </style>
</head>
<body>
<header><h1>Admin Panel — USDT Staking (BSC Testnet)</h1></header>

<div class="topbar">
  <div id="walletDisplay" class="muted">Not connected</div>
  <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
</div>

<main class="container">
  <div class="card">
    <h2>Owner Dashboard</h2>
    <div id="ownerHint" class="muted">Connect with owner wallet to manage.</div>

    <div id="ownerControls" style="display:none;">
      <div style="display:flex;gap:10px;">
        <div style="flex:1">
          <label>Contract Owner</label>
          <div id="ownerAddr" class="kbd">-</div>
        </div>
        <div style="width:160px">
          <label>Chain</label>
          <div class="kbd">BSC Testnet</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

      <h3 style="color:var(--accent);margin-bottom:8px">Quick Stats</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <div class="card"><div class="muted">Total Users</div><div id="statUsers">-</div></div>
        <div class="card"><div class="muted">Total Staked</div><div id="statStaked">-</div></div>
        <div class="card"><div class="muted">Total Withdrawn (net)</div><div id="statWithdrawn">-</div></div>
        <div class="card"><div class="muted">Total Fees Collected</div><div id="statFees">-</div></div>
        <div class="card"><div class="muted">Contract Balance</div><div id="statContractBal">-</div></div>
        <div class="card"><div class="muted">Pending Withdrawals</div><div id="statPending">-</div></div>
        <div class="card"><div class="muted">Available Liquidity</div><div id="statAvailable">-</div></div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
      <h3 style="color:var(--accent)">Contract Controls</h3>
      <div class="row">
        <button id="pauseContract" class="small-btn">Pause</button>
        <button id="unpauseContract" class="small-btn">Unpause</button>
      </div>

      <label>Pause / Unpause User</label>
      <input id="pauseUserAddr" placeholder="0x..." />
      <div class="row">
        <button id="pauseUserBtn" class="small-btn">Pause User</button>
        <button id="unpauseUserBtn" class="small-btn">Unpause User</button>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
      <h3 style="color:var(--accent)">Settings</h3>
      <label>Set Daily ROI (bps)</label>
      <div class="row"><input id="dailyRoiInp" placeholder="e.g. 100" /><button id="setDailyRoi" class="small-btn">Set</button></div>
      <label>Withdraw Fee (bps)</label>
      <div class="row"><input id="withdrawFeeInp" placeholder="e.g. 500" /><button id="setWithdrawFee" class="small-btn">Set</button></div>
      <label>Update Admin Wallet</label>
      <div class="row"><input id="adminWalletInp" placeholder="0x..." /><button id="setAdminWalletBtn" class="small-btn">Set</button></div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
      <h3 style="color:var(--accent)">Emergency</h3>
      <div class="row"><input id="emergencyTo" placeholder="0x..." /><button id="emergencyWithdrawBtn" class="danger">Emergency Withdraw</button></div>
    </div>
  </div>

  <div class="card">
    <h2>Withdrawals Queue</h2>
    <table id="withdrawTable">
      <thead><tr><th>ID</th><th>User</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
      <tbody id="withdrawTbody"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</main>

<footer style="text-align:center;color:#777;font-size:13px;">Admin Panel — Secure Owner Access</footer>

<script>
const CONFIG={stakingAddress:"0x0c38576d85677dE210DD1C68378604d3AacfAB27",decimals:6,desiredChainId:97};
const STAKING_ABI=[
  "function owner() view returns(address)",
  "function totalUsers() view returns(uint256)",
  "function totalStaked() view returns(uint256)",
  "function totalWithdrawnNet() view returns(uint256)",
  "function totalFeesCollected() view returns(uint256)",
  "function getContractStats() view returns(uint256 contractBalance,uint256 totalPendingWithdrawals)",
  "function pauseContract() external",
  "function unpauseContract() external",
  "function pauseUser(address a) external",
  "function unpauseUser(address a) external",
  "function setDailyRoi(uint256 bps) external",
  "function setWithdrawFee(uint256 bps) external",
  "function setAdminWallet(address a) external",
  "function emergencyWithdrawAll(address to) external",
  "function nextWithdrawId() view returns(uint256)",
  "function withdrawals(uint256) view returns(address user,uint256 amount,bool approved,uint256 timestamp)",
  "function approveWithdrawal(uint256 id) external"
];

let provider,signer,account,stakingContract;

function fromUnits(v){try{return Number(ethers.utils.formatUnits(v,CONFIG.decimals));}catch{return 0;}}
function toFixed(v){return Number(v).toLocaleString("en-US",{maximumFractionDigits:6,minimumFractionDigits:6});}

document.getElementById("connectBtn").onclick=async()=>{
  const p=new ethers.providers.Web3Provider(window.ethereum,"any");
  await p.send("eth_requestAccounts",[]);
  provider=p; signer=p.getSigner(); account=await signer.getAddress();
  stakingContract=new ethers.Contract(CONFIG.stakingAddress,STAKING_ABI,signer);
  document.getElementById("walletDisplay").innerText=account;
  await refreshStats(); await loadWithdrawQueue();
};

async function refreshStats(){
  const tu=await stakingContract.totalUsers();
  const ts=await stakingContract.totalStaked();
  const tw=await stakingContract.totalWithdrawnNet();
  const tf=await stakingContract.totalFeesCollected();
  document.getElementById("statUsers").innerText=tu;
  document.getElementById("statStaked").innerText=`${toFixed(fromUnits(ts))} USDT`;
  document.getElementById("statWithdrawn").innerText=`${toFixed(fromUnits(tw))} USDT`;
  document.getElementById("statFees").innerText=`${toFixed(fromUnits(tf))} USDT`;
  await loadContractStats();
}

async function loadContractStats(){
  const [bal,pending]=await stakingContract.getContractStats();
  const available=bal.sub(pending);
  document.getElementById("statContractBal").innerText=`${toFixed(fromUnits(bal))} USDT`;
  document.getElementById("statPending").innerText=`${toFixed(fromUnits(pending))} USDT`;
  document.getElementById("statAvailable").innerText=`${toFixed(fromUnits(available))} USDT`;
}

async function loadWithdrawQueue(){
  const tbody=document.getElementById("withdrawTbody");
  tbody.innerHTML='<tr><td colspan="5">Loading...</td></tr>';
  const next=await stakingContract.nextWithdrawId();
  let html="";
  for(let i=Number(next)-1;i>=1;i--){
    const w=await stakingContract.withdrawals(i);
    if(w.user==="0x0000000000000000000000000000000000000000")continue;
    html+=`<tr><td>${i}</td><td>${w.user}</td><td>${toFixed(fromUnits(w.amount))} USDT</td><td>${w.approved?"✅":"⏳"}</td>
    <td>${!w.approved?`<button onclick="approve(${i})" class='small-btn success'>Approve</button>`:""}</td></tr>`;
  }
  tbody.innerHTML=html||"<tr><td colspan='5'>No withdrawals</td></tr>";
}

async function approve(id){
  try{
    const tx=await stakingContract.approveWithdrawal(id);
    await tx.wait(); alert(`Withdrawal ${id} approved!`);
    await refreshStats(); await loadWithdrawQueue();
  }catch(e){alert("Approve failed: "+e.message);}
}
</script>
</body>
</html>
