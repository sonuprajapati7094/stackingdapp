<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — USDT Staking Panel</title>

  <!-- ethers v5 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root {
      --bg: #071017;
      --card: #0f1720;
      --muted: #9aa4b2;
      --accent: #4ad2a6;
      --danger: #ff6b6b;
      --panel: #0b1116;
    }
    body { margin:0; font-family: Inter, Arial, sans-serif; background:var(--bg); color:#e6eef6; }
    header { padding:18px 24px; text-align:center; background:linear-gradient(90deg,#04121b,#071426); box-shadow:0 4px 18px rgba(0,0,0,0.6); }
    header h1 { margin:0; color:var(--accent); font-size:20px; letter-spacing:0.6px; }
    .topbar { display:flex; justify-content:space-between; gap:12px; padding:12px 24px; align-items:center; max-width:1180px; margin:0 auto; }
    .wallet-info { display:flex; gap:12px; align-items:center; }
    .wallet-btn { background:var(--accent); color:#032019; padding:8px 14px; border-radius:8px; border:0; font-weight:600; cursor:pointer; }
    .small-btn { padding:8px 10px; border-radius:8px; border:0; background:#15202a; color:#fff; cursor:pointer; }
    .container { padding: 20px; max-width:1180px; margin:18px auto; display:grid; grid-template-columns: 1fr; gap:18px; }
    .card { background:var(--card); border-radius:12px; padding:14px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
    h2 { margin:0 0 10px 0; color:var(--accent); font-size:18px; }
    .muted { color:var(--muted); font-size:13px; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
    th,td { padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.03); text-align:left; }
    th { color:var(--accent); font-weight:700; background:transparent; }
    .center { text-align:center; }
    .grid-2 { display:grid; grid-template-columns: 1fr 360px; gap:12px; align-items:start; }
    input[type="text"], input[type="number"] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:var(--panel); color:#fff; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn-approve { background:linear-gradient(90deg,#2ad58a,#1fb07a); color:#022b1f; padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn-reject { background:linear-gradient(90deg,#ff8b8b,#ff6b6b); color:#2b0b0b; padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn-disabled { opacity:0.45; cursor:not-allowed; }
    .log { background:#061117; padding:8px; border-radius:8px; font-size:13px; color:var(--muted); max-height:160px; overflow:auto; }
    @media(max-width:980px) { .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header><h1>Admin Panel — USDT Staking</h1></header>

  <div class="topbar">
    <div class="wallet-info">
      <div id="walletDisplay" class="muted">Not connected</div>
      <button id="connectBtn" class="wallet-btn">Connect Wallet</button>
    </div>
    <div style="text-align:right">
      <div id="ownerNotice" class="muted">Owner: <span id="ownerAddr">-</span></div>
      <div id="networkNotice" class="muted">Network: <span id="networkName">-</span></div>
    </div>
  </div>

  <main class="container">

    <div class="card">
      <h2>Contract Summary</h2>
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div>
          <div class="muted">Staking Contract</div>
          <div style="font-weight:700" id="contractAddr">0x97DE52e37eB68e6105ecb81Dd015016C36cd6D51</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Contract USDT Balance</div>
          <div style="font-weight:700" id="contractBalance">0.000000</div>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card" style="min-height:220px;">
        <h2>Withdraw Requests</h2>
        <div class="muted">List of latest withdraw requests. Owner can Approve / Reject.</div>
        <table id="requestsTable">
          <thead><tr><th>Req ID</th><th>User</th><th>Amount</th><th>Status</th><th>Time</th><th class="center">Action</th></tr></thead>
          <tbody id="requestsBody"><tr><td colspan="6" class="center muted">Loading...</td></tr></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Owner Controls</h2>
        <div class="muted">Only the contract owner can perform these actions.</div>
        <div style="margin-top:12px">
          <div style="margin-bottom:8px"><strong>Emergency Withdraw (token)</strong></div>
          <div style="display:flex;gap:8px;flex-direction:column">
            <input id="ewTo" type="text" placeholder="Recipient address (0x...)" />
            <input id="ewAmount" type="number" placeholder="Amount (USDT)" />
            <div class="actions">
              <button id="ewBtn" class="small-btn">Execute Emergency Withdraw</button>
              <button id="refreshBtn" class="small-btn">Refresh</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div><strong>Quick Admin</strong></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="fetchOwnerBtn" class="small-btn">Fetch Owner</button>
            <button id="fetchCountBtn" class="small-btn">Fetch Requests Count</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Logs</div>
          <div id="adminLog" class="log">Ready.</div>
        </div>
      </div>
    </div>

  </main>

<script>
/* ========== CONFIG ========== */
const STAKING_ADDRESS = "0x97DE52e37eB68e6105ecb81Dd015016C36cd6D51"; // your staking contract
const TOKEN_ADDRESS   = "0xBCE19c66E53da172F78FE800368361a8aaB51F2a"; // token (USDT) used by contract
let TOKEN_DECIMALS = 6; // will try to read from token contract

/* Minimal ABI for the admin actions we need */
const STAKING_ABI = [
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"withdrawRequestsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"getWithdrawRequest","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"enum USDTStakingWithReferrals.WithdrawStatus","name":"status","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"reqId","type":"uint256"}],"name":"approveWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"reqId","type":"uint256"}],"name":"rejectWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"}
];

const TOKEN_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)",
  "function transfer(address to, uint256 amount) returns (bool)"
];

/* ========== STATE ========== */
let provider, signer, account, stakingContract, tokenContract;
let contractOwner = null;

/* ========== HELPERS ========== */
function logAdmin(msg) {
  const el = document.getElementById("adminLog");
  const time = new Date().toLocaleTimeString();
  el.innerText = `${time} — ${msg}\n` + el.innerText;
}
function toFixedNumber(num, decimals=6) {
  if (isNaN(num)) return "0.000000";
  return Number(num).toFixed(decimals);
}
function fromUnits(valueBn) {
  try { return Number(ethers.utils.formatUnits(valueBn, TOKEN_DECIMALS)); }
  catch (e) { return Number(valueBn) / (10 ** TOKEN_DECIMALS); }
}
function toUnits(amountFloat) {
  try { return ethers.utils.parseUnits(String(amountFloat), TOKEN_DECIMALS); }
  catch (e) { return ethers.BigNumber.from(String(Math.floor(amountFloat * (10 ** TOKEN_DECIMALS)))); }
}

/* ========== CONNECT ========== */
async function connect() {
  try {
    if (!window.ethereum) { alert("MetaMask not found"); return; }
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    account = await signer.getAddress();
    document.getElementById("walletDisplay").innerText = account;
    document.getElementById("networkName").innerText = (await provider.getNetwork()).name || "unknown";

    stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);
    tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);

    try {
      TOKEN_DECIMALS = await tokenContract.decimals();
      logAdmin("Token decimals: " + TOKEN_DECIMALS);
    } catch (e) {
      console.warn("decimals read failed, using default", TOKEN_DECIMALS);
    }

    try {
      contractOwner = await stakingContract.owner();
      document.getElementById("ownerAddr").innerText = contractOwner;
      logAdmin("Owner loaded: " + contractOwner);
    } catch (e) {
      console.error("owner() read failed", e);
      logAdmin("Could not read owner()");
    }

    // update UI based on owner
    updateOwnerUI();

    await refreshAll();
    listenEvents();
  } catch (err) {
    console.error("connect error", err);
    alert("Connect failed: " + (err.message || err));
  }
}
document.getElementById("connectBtn").addEventListener("click", connect);
document.getElementById("fetchOwnerBtn").addEventListener("click", async ()=> {
  try { contractOwner = await stakingContract.owner(); document.getElementById("ownerAddr").innerText = contractOwner; logAdmin("Owner refreshed"); updateOwnerUI(); } catch(e){ logAdmin("owner fetch failed"); }
});

/* ========== REFRESH ========== */
async function refreshAll() {
  if (!stakingContract) return;
  try {
    // contract token balance
    let balBn = await tokenContract.balanceOf(STAKING_ADDRESS);
    const bal = fromUnits(balBn || 0);
    document.getElementById("contractBalance").innerText = toFixedNumber(bal,6) + " USDT";

    // load withdraw requests
    await loadWithdrawRequests();
  } catch (e) {
    console.error("refreshAll error", e);
    logAdmin("Refresh failed: " + (e.message||e));
  }
}
document.getElementById("refreshBtn").addEventListener("click", refreshAll);

/* ========== OWNER UI ========== */
function updateOwnerUI() {
  const isOwner = account && contractOwner && account.toLowerCase() === contractOwner.toLowerCase();
  // enable/disable emergency withdraw button
  const ewBtn = document.getElementById("ewBtn");
  if (isOwner) {
    ewBtn.classList.remove("btn-disabled"); ewBtn.disabled = false;
    document.getElementById("ewTo").disabled = false;
    document.getElementById("ewAmount").disabled = false;
    logAdmin("Connected wallet is owner — admin controls enabled.");
  } else {
    ewBtn.classList.add("btn-disabled"); ewBtn.disabled = true;
    document.getElementById("ewTo").disabled = true;
    document.getElementById("ewAmount").disabled = true;
    logAdmin("Connected wallet is NOT owner — admin controls disabled.");
  }
}

/* ========== LOAD & ACTIONS ========== */
async function loadWithdrawRequests() {
  if (!stakingContract) return;
  try {
    const countBn = await stakingContract.withdrawRequestsCount();
    const count = Number(countBn || 0);
    const tbody = document.getElementById("requestsBody");
    tbody.innerHTML = "";
    if (count === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="center muted">No withdraw requests yet.</td></tr>';
      return;
    }
    // show last up to 200
    const start = Math.max(1, count - 199);
    for (let i = count; i >= start; i--) {
      try {
        const req = await stakingContract.getWithdrawRequest(i);
        // req = { user, amount, timestamp, status }
        const user = req.user || "0x0";
        const amt = fromUnits(req.amount || 0);
        const ts = req.timestamp ? new Date(Number(req.timestamp)*1000).toLocaleString() : "-";
        const statusVal = Number(req.status || 0);
        const statusLabel = statusVal === 0 ? "Pending" : (statusVal === 1 ? "Approved" : "Rejected");

        // action buttons only for Pending and owner
        let actionHtml = "";
        const isOwner = account && contractOwner && account.toLowerCase() === contractOwner.toLowerCase();
        if (statusVal === 0 && isOwner) {
          actionHtml = `<button class="btn-approve" data-id="${i}" onclick="approveReq(${i})">Approve</button>
                        <button class="btn-reject" data-id="${i}" onclick="rejectReq(${i})">Reject</button>`;
        } else {
          actionHtml = `<span class="muted">—</span>`;
        }

        const row = `<tr>
          <td>#${i}</td>
          <td class="sm">${user}</td>
          <td>${toFixedNumber(amt,6)}</td>
          <td>${statusLabel}</td>
          <td>${ts}</td>
          <td class="center">${actionHtml}</td>
        </tr>`;
        tbody.innerHTML += row;
      } catch (e) {
        console.warn("getWithdrawRequest failed for id", i, e);
      }
    }
  } catch (e) {
    console.error("loadWithdrawRequests error", e);
    logAdmin("Could not load withdraw requests: " + (e.message || e));
  }
}

/* Approve / Reject (owner only) */
async function approveReq(id) {
  try {
    if (!stakingContract || !signer) { alert("Connect wallet first"); return; }
    const isOwner = account && contractOwner && account.toLowerCase() === contractOwner.toLowerCase();
    if (!isOwner) { alert("Only owner can approve"); return; }
    const tx = await stakingContract.approveWithdrawal(id);
    logAdmin("approveWithdrawal tx sent (#" + id + ")");
    await tx.wait();
    logAdmin("approveWithdrawal tx confirmed (#" + id + ")");
    await refreshAll();
  } catch (e) {
    console.error("approveReq error", e);
    alert("Approve failed: " + (e.data?.message || e.message || e));
    logAdmin("Approve error: " + (e.message || e));
  }
}
async function rejectReq(id) {
  try {
    if (!stakingContract || !signer) { alert("Connect wallet first"); return; }
    const isOwner = account && contractOwner && account.toLowerCase() === contractOwner.toLowerCase();
    if (!isOwner) { alert("Only owner can reject"); return; }
    const tx = await stakingContract.rejectWithdrawal(id);
    logAdmin("rejectWithdrawal tx sent (#" + id + ")");
    await tx.wait();
    logAdmin("rejectWithdrawal tx confirmed (#" + id + ")");
    await refreshAll();
  } catch (e) {
    console.error("rejectReq error", e);
    alert("Reject failed: " + (e.data?.message || e.message || e));
    logAdmin("Reject error: " + (e.message || e));
  }
}

/* Emergency withdraw token */
document.getElementById("ewBtn").addEventListener("click", async () => {
  try {
    if (!stakingContract || !signer) { alert("Connect wallet first"); return; }
    const isOwner = account && contractOwner && account.toLowerCase() === contractOwner.toLowerCase();
    if (!isOwner) { alert("Only owner can perform emergency withdraw"); return; }

    const to = document.getElementById("ewTo").value;
    const amtStr = document.getElementById("ewAmount").value;
    if (!ethers.utils.isAddress(to)) { alert("Invalid recipient address"); return; }
    if (!amtStr || Number(amtStr) <= 0) { alert("Enter withdraw amount"); return; }

    const units = toUnits(Number(amtStr));
    const tx = await stakingContract.emergencyWithdrawToken(to, units);
    logAdmin("emergencyWithdrawToken tx sent");
    await tx.wait();
    logAdmin("emergencyWithdrawToken confirmed");
    await refreshAll();
    alert("Emergency withdraw executed");
  } catch (e) {
    console.error("emergency withdraw error", e);
    alert("Emergency withdraw failed: " + (e.data?.message || e.message || e));
    logAdmin("Emergency withdraw error: " + (e.message || e));
  }
});

/* ========== EVENTS ========== */
function listenEvents() {
  try {
    if (!stakingContract) return;
    stakingContract.on("WithdrawRequested", (id, user, amount, event) => {
      logAdmin("WithdrawRequested #" + id.toString() + " from " + user);
      refreshAll();
    });
    stakingContract.on("WithdrawApproved", (id, user, amountAfterFee, event) => {
      logAdmin("WithdrawApproved #" + id.toString() + " -> " + user);
      refreshAll();
    });
    stakingContract.on("WithdrawRejected", (id, user, event) => {
      logAdmin("WithdrawRejected #" + id.toString() + " -> " + user);
      refreshAll();
    });
  } catch (e) {
    console.warn("listenEvents error", e);
  }
}

/* ========== UTIL & AUTO REFRESH ========== */
document.getElementById("fetchCountBtn").addEventListener("click", async () => {
  try {
    const c = await stakingContract.withdrawRequestsCount();
    alert("Withdraw requests count: " + c.toString());
  } catch (e) { alert("Failed to fetch count"); }
});

setInterval(()=>{ if (stakingContract) refreshAll(); }, 15000);

console.log("Admin panel loaded.");
</script>
</body>
</html>
